<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ìˆ² - ê¸°ì–µì˜ ì„œê³  (Archives)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* [1. ê¸°ë³¸ ì„¤ì •] */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; cursor: default; }
        body { 
            background-color: #050505; 
            overflow: hidden; 
            width: 100vw; height: 100vh; 
            font-family: 'Nanum Myeongjo', serif;
            color: #fff;
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }

        /* [2. íŠ¸ëœì§€ì…˜ ë ˆì´ì–´] */
        #page-transition {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1.5s cubic-bezier(0.22, 1, 0.36, 1);
        }
        #page-transition.fade-out { opacity: 0; pointer-events: none; }

        .ancient-symbol { 
            width: 60px; height: 80px; position: relative; margin-bottom: 30px; perspective: 600px; 
        }

        .book-cover {
            width: 100%; height: 100%; border: 2px solid #d4af37; border-radius: 2px 6px 6px 2px;
            background: rgba(212, 175, 55, 0.05); box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            position: absolute; 
            transform-origin: left center; /* ğŸ’¡ ì±…ë“±(ì™¼ìª½)ì„ ì¶•ìœ¼ë¡œ ì—´ë¦¬ê²Œ ê³ ì • */
            animation: bookPulse 2.5s infinite ease-in-out;
        }

        .book-page {
            width: 90%; height: 94%; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            position: absolute; top: 3%; left: 5%; 
            transform-origin: left center; /* ğŸ’¡ ì•ˆìª½ í˜ì´ì§€ë„ ê°™ì€ ì¶•ìœ¼ë¡œ ê³ ì • */
            opacity: 0; 
            animation: pageShine 2.5s infinite ease-in-out; /* ğŸ’¡ í‘œì§€ì™€ ë™ì¼í•˜ê²Œ 2.5ì´ˆ, ë¶€ë“œëŸ¬ìš´ íƒ€ì´ë°ìœ¼ë¡œ í†µì¼! */
        }

        @keyframes bookPulse {
            0%, 100% { transform: rotateY(0deg); box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); border-color: #d4af37; }
            50% { transform: rotateY(-30deg); box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); border-color: #fff; } /* ê°ë„ë¥¼ ì‚´ì§ ë” ì—´ì–´ì¤Œ */
        }

        @keyframes pageShine { 
            0%, 100% { transform: rotateY(0deg) translateX(0); opacity: 0; } 
            50% { transform: rotateY(-15deg) translateX(10px); opacity: 0.8; } /* í‘œì§€ê°€ ì—´ë¦´ ë•Œ í˜ì´ì§€ë„ ë”°ë¼ ì—´ë¦¬ë©° ë¹›ë‚¨ */
        }
        /* [3. ë°°ê²½ (Memory Void)] */
        #world-container { position: fixed; width: 100%; height: 100%; z-index: 0; }
        #void-bg { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle at 50% 120%, #1a0b2e 0%, #000000 60%); }
        #fog-layer { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to top, rgba(100, 80, 255, 0.1) 0%, transparent 100%); filter: blur(20px); z-index: 1; }
        #dust-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; opacity: 0.6; }

        /* [4. ì¤‘ì•™ ë¬´ëŒ€ (ì„¬)] */
        #stage-container {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            perspective: 1000px; z-index: 10; overflow: hidden;
        }
        #stage-inner {
            position: relative; width: 100%; height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .island-obj {
            position: absolute; width: 140px; 
            transition: opacity 0.5s ease, filter 0.3s ease; 
            filter: drop-shadow(0 30px 50px rgba(0,0,0,0.8));
            cursor: pointer; will-change: transform;
        }
        .island-obj img { width: 100%; height: auto; animation: float 6s ease-in-out infinite; }
        .island-obj:hover img { transform: scale(1.1); filter: brightness(1.2); }

        #isl-wisdom { top: 40%; left: 35%; z-index: 5; }
        #isl-serenity { top: 40%; left: 65%; z-index: 5; }
        #isl-courage { top: 55%; left: 30%; width: 160px; z-index: 10; }
        #isl-diligence { top: 55%; left: 70%; width: 160px; z-index: 10; }
        #isl-kindness { top: 65%; left: 50%; width: 180px; z-index: 20; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* [5. UI: ë„¤ë¹„ê²Œì´ì…˜] */
        .header-ui { position: absolute; top: 60px; width: 100%; z-index: 100; display: flex; justify-content: center; align-items: center; gap: 60px; }
        .date-display { text-align: center; color: #d4af37; text-shadow: 0 0 30px rgba(212,175,55,0.4); }
        #disp-year { font-family: 'Cinzel'; font-size: 1.2rem; letter-spacing: 0.5rem; color: #888; display: block; margin-bottom: 5px; }
        #disp-month { font-family: 'Cinzel'; font-size: 5rem; margin: 0; letter-spacing: 0.5rem; line-height: 1; background: linear-gradient(to bottom, #fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .nav-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            width: 60px; height: 60px; border-radius: 50%; color: #aaa; font-size: 1.5rem;
            cursor: pointer; transition: 0.4s; backdrop-filter: blur(5px);
        }
        .nav-btn:hover:not(:disabled) { border-color: #d4af37; color: #d4af37; transform: scale(1.15); background: rgba(212, 175, 55, 0.1); box-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .nav-btn:disabled { opacity: 0.1; cursor: default; transform: none; }

        /* [6. ìŠ¤íƒ¯ íŒ¨ë„] */
        #stats-toggle-btn {
            position: absolute; bottom: 50px; left: 50px; z-index: 200; width: 70px; height: 70px;
            background: rgba(10, 10, 15, 0.8); border: 2px solid #d4af37; border-radius: 50%;
            color: #d4af37; font-size: 1.8rem; cursor: pointer; box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; justify-content: center; align-items: center;
        }
        #stats-toggle-btn:hover { transform: scale(1.1) rotate(15deg); box-shadow: 0 0 50px rgba(212, 175, 55, 0.5); }
        #stats-toggle-btn.hidden { transform: scale(0) rotate(-180deg); opacity: 0; pointer-events: none; }

        #stats-panel {
            position: absolute; bottom: 50px; left: 50px; z-index: 190; width: 380px; padding: 40px 30px;
            background: linear-gradient(135deg, rgba(20, 20, 25, 0.95), rgba(5, 5, 8, 0.98));
            border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 20px 20px 20px 0;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8); backdrop-filter: blur(15px);
            transform-origin: bottom left; transform: scale(0) translate(-50px, 50px); opacity: 0; pointer-events: none;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.4s ease;
        }
        #stats-panel.active { transform: scale(1) translate(0, 0); opacity: 1; pointer-events: auto; }

        .panel-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .panel-title { font-family: 'Cinzel'; font-size: 1rem; color: #d4af37; letter-spacing: 0.1rem; }
        .close-panel-btn { background: transparent; border: none; color: #666; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        .close-panel-btn:hover { color: #fff; transform: rotate(90deg); }

        .stat-row { display: flex; align-items: center; margin-bottom: 15px; }
        .stat-icon { width: 30px; font-size: 1.2rem; text-align: center; margin-right: 10px; }
        .stat-name { width: 80px; font-family: 'Cinzel'; font-size: 0.75rem; color: #aaa; }
        .stat-track { flex: 1; height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; position: relative; }
        .stat-fill { height: 100%; width: 0%; border-radius: 3px; transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1); position: relative; }
        .stat-fill::after { content: ''; position: absolute; top: 0; right: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shine 2s infinite; }
        .stat-val { width: 40px; text-align: right; font-family: 'Cinzel'; font-weight: bold; font-size: 0.9rem; color: #fff; }
        @keyframes shine { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* [7. ë¦¬í¬íŠ¸ ëª¨ë‹¬] */
        #report-btn {
            position: absolute; bottom: 50px; right: 50px; z-index: 200;
            background: transparent; border: 1px solid #d4af37; color: #d4af37; font-family: 'Cinzel'; font-size: 1rem; letter-spacing: 0.2rem;
            padding: 15px 40px; cursor: pointer; transition: all 0.4s ease; display: flex; align-items: center; gap: 15px; backdrop-filter: blur(5px);
        }
        #report-btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 40px rgba(212, 175, 55, 0.4); transform: translateY(-5px); }
        #report-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; color: #555; }

        #report-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 300; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.5s ease;
        }
        #report-modal.active { opacity: 1; visibility: visible; }

        .report-paper {
            width: 700px; max-height: 85vh; background: linear-gradient(145deg, #15151a, #0a0a0f); border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 60px; position: relative; box-shadow: 0 0 100px rgba(0,0,0,0.9); transform: scale(0.9) translateY(30px);
            transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1); overflow-y: auto;
        }
        #report-modal.active .report-paper { transform: scale(1) translateY(0); }

        .report-title { font-family: 'Cinzel'; color: #d4af37; font-size: 2rem; text-align: center; margin-bottom: 40px; letter-spacing: 0.5rem; text-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .report-section { margin-bottom: 40px; border-left: 2px solid rgba(212,175,55,0.2); padding-left: 20px; }
        .sec-head { font-family: 'Cinzel'; color: #888; font-size: 0.9rem; letter-spacing: 0.2rem; margin-bottom: 15px; }
        .persona-text { font-size: 1.2rem; line-height: 1.8; color: #eee; margin-bottom: 10px; font-style: italic; }
        
        .virtue-group { margin-bottom: 25px; }
        .virtue-title { font-family: 'Cinzel'; font-size: 0.9rem; color: var(--v-color); letter-spacing: 0.2rem; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; display: inline-block; }
        .quote-item { margin-bottom: 10px; display: flex; flex-direction: column; }
        .q-date { font-family: 'Cinzel'; font-size: 0.7rem; color: #666; margin-bottom: 3px; }
        .q-text { font-size: 1rem; color: #ccc; line-height: 1.6; }

        .close-report-x { position: absolute; top: 30px; right: 30px; font-size: 1.5rem; color: #555; cursor: pointer; transition: 0.3s; }
        .close-report-x:hover { color: #d4af37; transform: rotate(90deg); }

        /* [8. 3D ì¼ê¸°ì¥ ë²„íŠ¼ & ëª¨ë‹¬] */
        #diary-book-btn {
            position: absolute; bottom: 50px; right: 330px; /* ë¦¬í¬íŠ¸ ë²„íŠ¼(50+width)ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ */
            z-index: 200;
            background: transparent; border: 1px solid #d4af37; color: #d4af37;
            font-family: 'Cinzel'; font-size: 1rem; letter-spacing: 0.2rem;
            padding: 15px 30px; cursor: pointer; transition: all 0.4s ease;
            display: flex; align-items: center; gap: 10px; backdrop-filter: blur(5px);
        }
        #diary-book-btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 40px rgba(212, 175, 55, 0.4); transform: translateY(-5px); }

        #diary-book-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 400;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.5s ease;
            perspective: 2500px; /* ì›ê·¼ê° */
        }
        #diary-book-modal.active { opacity: 1; visibility: visible; }

        .close-book-x { position: absolute; top: 30px; right: 40px; font-size: 2rem; color: #888; cursor: pointer; z-index: 500; transition: 0.3s; }
        .close-book-x:hover { color: #d4af37; transform: rotate(90deg); }

        .book-scene { width: 500px; height: 550px; position: relative; }
        .book { 
            width: 100%; height: 100%; 
            position: relative; 
            transform-style: preserve-3d;
            /* ì±… ìœ„ì¹˜ ì´ë™ì„ ìœ„í•œ ë¶€ë“œëŸ¬ìš´ ì „í™˜ */
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); 
        }

        /* [í•µì‹¬] ì±…ì´ í¼ì³ì¡Œì„ ë•Œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ (PCë§Œ) */
        @media screen and (min-width: 769px) {
            .book.is-open { transform: translateX(50%); }
        }

        /* ì¢…ì´ (ì–‘ë©´) */
        .paper {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            transform-origin: left center; /* ì±…ë“± ê¸°ì¤€ íšŒì „ */
            transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1); /* ë¬µì§í•˜ê²Œ ë„˜ì–´ê°€ëŠ” ëŠë‚Œ */
            transform-style: preserve-3d;
            border-radius: 5px 15px 15px 5px; /* ì¢…ì´ ë ì‚´ì§ ë‘¥ê¸€ê²Œ */
        }
        .paper.flipped { transform: rotateY(-180deg); }

        /* ì•ë©´ (ì˜¤ë¥¸ìª½ í˜ì´ì§€) */
        .front {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            background: linear-gradient(to right, #e3d2b4, #fff9e6 15%, #fff9e6 95%, #e3d2b4 100%); /* ì…ì²´ì  ì§ˆê° */
            color: #333; padding: 40px; box-sizing: border-box;
            backface-visibility: hidden; z-index: 2;
            border-right: 1px solid #ccc;
            box-shadow: inset 5px 0 10px rgba(0,0,0,0.05); /* ì±…ë“± ê·¸ë¦¼ì */
            display: flex; flex-direction: column;
        }
        
        /* ë’·ë©´ (ì™¼ìª½ í˜ì´ì§€ - ë„˜ì–´ê°”ì„ ë•Œ ë³´ì„) */
        .back { 
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            background: linear-gradient(to left, #e3d2b4, #fff9e6 15%, #fff9e6 95%, #e3d2b4 100%);
            color: #333; padding: 40px; box-sizing: border-box;
            backface-visibility: hidden; z-index: 1;
            transform: rotateY(180deg); /* ë’¤ì§‘í˜ */
            border-left: 1px solid #ccc;
            box-shadow: inset -5px 0 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }

        /* í‘œì§€ */
        .cover-page {
            background: linear-gradient(135deg, #1a0b2e, #000); /* ì„œê³  í…Œë§ˆ */
            border: 2px solid #d4af37; color: #d4af37;
            text-align: center; justify-content: center;
        }
        .cover-page h1 { font-family: 'Cinzel'; font-size: 3.5rem; margin-bottom: 20px; }
        .instruction { font-family: 'Nanum Myeongjo'; font-size: 0.8rem; opacity: 0.7; margin-top: 50px; }

        /* ë‚´ì§€ ë””ìì¸ */
        .d-date-title { 
            font-family: 'Cinzel'; font-size: 1.1rem; color: #8b5e3c; 
            border-bottom: 1px solid #d4af37; padding-bottom: 10px; margin-bottom: 20px; text-align: right; 
        }
        .d-content-text { 
            font-family: 'Nanum Myeongjo'; font-size: 1.05rem; line-height: 1.8; 
            color: #444; white-space: pre-wrap; flex: 1; overflow-y: auto; 
            scrollbar-width: none; 
        }
        .d-content-text::-webkit-scrollbar { display: none; }
        
        .d-reply-box { 
            margin-top: 15px; padding: 15px; 
            background: rgba(139, 94, 60, 0.08); 
            border-radius: 5px; font-size: 0.9rem; color: #665; font-style: italic; 
        }

        .book-controls { margin-top: 30px; display: flex; gap: 20px; align-items: center; }
        .book-controls button { background: transparent; border: 1px solid #666; color: #888; padding: 5px 15px; cursor: pointer; transition: 0.3s; font-family: 'Cinzel'; }
        .book-controls button:hover { border-color: #d4af37; color: #d4af37; }
        #book-pagination { font-family: 'Cinzel'; color: #666; }

        /* [9. ë‚˜ê°€ê¸° ë²„íŠ¼] */
        #return-btn {
            position: absolute; top: 40px; right: 40px; z-index: 200; background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.4); color: #d4af37;
            padding: 12px 30px; font-family: 'Cinzel'; font-size: 0.9rem; letter-spacing: 0.1rem; cursor: pointer; transition: all 0.4s ease; display: flex; align-items: center; gap: 10px; backdrop-filter: blur(5px);
        }
        #return-btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 30px rgba(212, 175, 55, 0.6); transform: translateY(-3px); }

        .slide-out-left { transform: translateX(-200px) rotateY(-20deg); opacity: 0; }
        .slide-out-right { transform: translateX(200px) rotateY(20deg); opacity: 0; }
        .slide-in { animation: popIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(30px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        @media screen and (max-width: 768px) {
            .header-ui { top: 30px; gap: 20px; }
            #disp-month { font-size: 3rem; }
            .island-obj { transform: translate(-50%, -50%) scale(0.6); }
            #stats-panel { bottom: 20px; left: 5%; width: 90%; }
            #stats-toggle-btn { bottom: 20px; left: 20px; width: 60px; height: 60px; }
            #report-btn { bottom: 100px; right: 20px; font-size: 0.8rem; padding: 10px 20px; }
            #diary-book-btn { bottom: 160px; right: 20px; font-size: 0.8rem; padding: 10px 20px; width: auto; }
            .report-paper { width: 90%; padding: 30px; }
            .book-scene { width: 90vw; height: 60vh; }
            .front, .back { padding: 20px; }
        }
        /* =========================================
           [10. íŠœí† ë¦¬ì–¼ ì‹œìŠ¤í…œ (ìŠ¤í¬íŠ¸ë¼ì´íŠ¸)]
           ========================================= */
        #tutorial-blocker {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 1499; background: transparent; pointer-events: none; display: none;
        }
        #tutorial-blocker.active { display: block; pointer-events: auto; }
        
        #tutorial-overlay {
            position: fixed; z-index: 1500; border-radius: 50%;
            /* ë¶€ë“œëŸ½ê³  ë¹›ë‚˜ëŠ” ì¡°ëª… í…Œë‘ë¦¬ */
            box-shadow: 
                0 0 0 9999px rgba(0, 0, 0, 0.85),
                0 0 30px 15px rgba(212, 175, 55, 0.4),
                inset 0 0 50px rgba(212, 175, 55, 0.2);
            pointer-events: none !important; opacity: 0;
            transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s ease;
            transform: translate(-50%, -50%);
            top: 50%; left: 50%; width: 200vw; height: 200vh; 
        }
        #tutorial-overlay.active { opacity: 1; }

        .tut-z-up { z-index: 3000 !important; }

        .tutorial-msg {
            position: fixed; z-index: 1501; width: 300px;
            display: flex; flex-direction: column; pointer-events: none;
            opacity: 0; transition: opacity 0.4s ease;
        }
        .tutorial-msg.active { opacity: 1; }
        
        .tut-title { font-family: 'Nanum Myeongjo', serif; color: #d4af37; font-size: 1.5rem; margin-bottom: 10px; text-shadow: 0 0 15px rgba(212, 175, 55, 0.8); }
        .tut-desc { font-family: 'Nanum Myeongjo', serif; color: #ccc; font-size: 1rem; line-height: 1.6; word-break: keep-all; }

        #tutorial-next-btn {
            position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); /* ìš°ì¸¡ í•˜ë‹¨ ë²„íŠ¼ì„ í”¼í•´ ì¤‘ì•™ í•˜ë‹¨ìœ¼ë¡œ ì´ë™ */
            z-index: 3000; background: rgba(10, 12, 15, 0.95); border: 1px solid #d4af37; color: #d4af37;
            font-family: 'Cinzel', serif; font-size: 1.1rem; letter-spacing: 0.2rem;
            padding: 12px 40px; cursor: pointer; opacity: 0; visibility: hidden;
            transition: all 0.4s ease; box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }
        #tutorial-next-btn.active { opacity: 1; visibility: visible; pointer-events: auto; }
        #tutorial-next-btn:hover { background: rgba(212, 175, 55, 0.1); color: #fff; box-shadow: 0 0 30px rgba(212, 175, 55, 0.5); }
        /* [íŠœí† ë¦¬ì–¼ í—¬í”„ ë²„íŠ¼] */
        #tutorial-help-btn {
            position: absolute; top: 40px; left: 40px; z-index: 200;
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.4);
            color: #d4af37; font-family: 'Cinzel', serif; font-size: 1.5rem;
            cursor: pointer; transition: all 0.4s ease; backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
        }
        #tutorial-help-btn:hover {
            background: #d4af37; color: #000; 
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6); transform: translateY(-3px) scale(1.1);
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <audio id="sfx-hover" src="SFX/hover.mp3"></audio>
    <audio id="sfx-click" src="SFX/click.mp3"></audio>
    <audio id="sfx-page" src="SFX/page_flip.mp3"></audio>
    <audio id="bgm-archive" src="SFX/archive_bgm.mp3" loop></audio>
    <audio id="sfx-tut-1" src="SFX/tut_early.mp3"></audio>
    <audio id="sfx-tut-2" src="SFX/tut_mid.mp3"></audio>
    <audio id="sfx-tut-3" src="SFX/tut_late.mp3"></audio>
    <audio id="sfx-clear" src="SFX/cloud_clear.mp3"></audio>

    <div id="tutorial-blocker"></div> 
    <div id="tutorial-overlay"></div>
    <div id="tutorial-text" class="tutorial-msg">
        <span class="tut-title">ì œëª©</span>
        <span class="tut-desc">ì„¤ëª…</span>
    </div>
    <button id="tutorial-next-btn">NEXT â¯</button>

    <div id="world-container">
        <div id="void-bg"></div>
        <div id="stars-container"></div>
        <div id="fog-layer"></div>
        <canvas id="dust-canvas"></canvas>
    </div>

    <div id="page-transition">
        <div class="ancient-symbol"><div class="book-cover"></div><div class="book-page"></div></div>
        <div style="color:#d4af37; font-family:'Nanum Myeongjo'; font-size:1.1rem; letter-spacing: 0.2rem; text-shadow: 0 0 10px rgba(212,175,55,0.5);">ê¸°ì–µì˜ ì‹¬ì—°ì„ ê±´ë„ˆëŠ” ì¤‘...</div>
    </div>

    <div id="stage-container">
        <div id="stage-inner">
            <div id="isl-wisdom" class="island-obj" data-base-x="35" data-base-y="40" data-depth="0.02"><img src="images/island_wisdom_1.png"></div>
            <div id="isl-courage" class="island-obj" data-base-x="30" data-base-y="55" data-depth="0.04"><img src="images/island_courage_1.png"></div>
            <div id="isl-kindness" class="island-obj" data-base-x="50" data-base-y="65" data-depth="0.06"><img src="images/island_kindness_1.png"></div>
            <div id="isl-diligence" class="island-obj" data-base-x="70" data-base-y="55" data-depth="0.04"><img src="images/island_diligence_1.png"></div>
            <div id="isl-serenity" class="island-obj" data-base-x="65" data-base-y="40" data-depth="0.02"><img src="images/island_serenity_1.png"></div>
        </div>
    </div>

    <div class="header-ui">
        <button class="nav-btn" id="btn-prev">â®</button>
        <div class="date-display"><span id="disp-year">----</span><h1 id="disp-month">LOADING</h1></div>
        <button class="nav-btn" id="btn-next">â¯</button>
    </div>

    <div id="stats-toggle-btn">ğŸ“Š</div>
    <div id="stats-panel">
        <div class="panel-header-row"><span class="panel-title">ARCHIVED GROWTH</span><button class="close-panel-btn">âœ•</button></div>
        <div id="stats-list-container"></div>
        <div style="margin-top:20px; font-size:0.8rem; color:#666; text-align:center;">* ì´ ë‹¬ì— ìˆ˜í™•í•œ ë§ˆìŒì˜ ì–‘ë¶„ì…ë‹ˆë‹¤.</div>
    </div>

    <button id="diary-book-btn"><span>ğŸ“– OPEN DIARY</span></button>

    <div id="diary-book-modal">
        <span class="close-book-x">âœ•</span>
        <div class="book-scene">
            <div class="book" id="real-book">
                <div class="paper" style="z-index: 100;">
                    <div class="front cover-page">
                        <h1>DIARY</h1>
                        <p id="book-cover-date">2024 . 05</p>
                        <span class="instruction">Click to flip</span>
                    </div>
                    <div class="back">
                        <div style="display:flex; justify-content:center; align-items:center; height:100%; opacity:0.1; font-family:'Cinzel'; font-size:2rem;">GEULSEUP</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="book-controls">
            <button id="book-prev">Prev</button>
            <span id="book-pagination">Cover</span>
            <button id="book-next">Next</button>
        </div>
    </div>

    <button id="report-btn"><span>ğŸ“œ READ MEMORY</span></button>
    <button id="tutorial-help-btn">?</button>

    <div id="report-modal">
        <div class="report-paper">
            <span class="close-report-x">âœ•</span>
            <h2 class="report-title" id="rpt-title">MAY 2024</h2>
            <div class="report-section"><div class="sec-head">THE PERSONA</div><div id="rpt-persona-box"></div></div>
            <div class="report-section"><div class="sec-head">VOICES OF VIRTUES</div><div id="rpt-quotes-box"></div></div>
        </div>
    </div>

    <button id="return-btn"><span>RETURN TO GARDEN</span></button>

    <div id="current-month-notice" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); z-index:500; display:flex; justify-content:center; align-items:center; opacity:0; visibility:hidden; transition:0.5s;">
        <div style="width:450px; padding:50px; background:linear-gradient(145deg, #1a1a20, #0a0a0f); border:1px solid #d4af37; text-align:center; box-shadow: 0 0 50px rgba(0,0,0,1);">
            <div id="notice-subtitle" style="font-family:'Cinzel'; color:#d4af37; font-size:0.8rem; letter-spacing:0.3rem; margin-bottom:20px;">IN PROGRESS</div>
            <h3 id="notice-title" style="font-family:'Nanum Myeongjo'; font-size:1.4rem; color:#fff; line-height:1.6; margin-bottom:30px;">ì´ ë‹¬ì˜ ê¸°ì–µì€<br>ì•„ì§ ì—®ì–´ì§€ëŠ” ì¤‘ì…ë‹ˆë‹¤.</h3>
            <p id="notice-desc" style="font-family:'Nanum Myeongjo'; font-size:0.9rem; color:#888; margin-bottom:40px; line-height:1.8;">ì›”ê°„ ë¦¬í¬íŠ¸ëŠ” ë‹¤ìŒ ë‹¬ì´ ì‹œì‘ë  ë•Œ<br>ì •ì›ì‚¬ê°€ ì •ì„±ê» ì‘ì„±í•´ ë“œë¦½ë‹ˆë‹¤.</p>
            
            <div style="display:flex; justify-content:center; gap:10px;">
                <button id="btn-notice-create" style="display:none; background:#d4af37; border:1px solid #d4af37; color:#000; padding:10px 25px; cursor:pointer; font-family:'Nanum Myeongjo'; font-weight:bold; transition:0.3s;">ì§€ê¸ˆ ë§Œë“¤ê¸°</button>
                <button id="close-notice-btn" style="background:transparent; border:1px solid rgba(255,255,255,0.2); color:#fff; padding:10px 25px; cursor:pointer; font-family:'Nanum Myeongjo'; transition:0.3s;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ì˜¤ë””ì˜¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const audioHover = document.getElementById('sfx-hover');
        const audioClick = document.getElementById('sfx-click');
        const audioPage = document.getElementById('sfx-page');
        const audioBgm = document.getElementById('bgm-archive');

        // [ì¤‘ìš”] index.htmlê³¼ ë³€ìˆ˜ëª… í†µì¼ (ê¸°ë³¸ê°’ ì„¤ì •)
        let globalSFXVolume = 0.5;
        let globalBGMVolume = 0.3;
        let isParallaxOn = true;
        let isGuestMode = false;
        let isTutTransitioning = false;

        // ==========================================
        // [íŠœí† ë¦¬ì–¼ ì‹œìŠ¤í…œ (Archive ë²„ì „)]
        // ==========================================
        let isTutorialMode = false;
        let tutorialStep = 0;
        let currentTargetForTutorial = null;

        const tutBlocker = document.getElementById('tutorial-blocker');
        const tutOverlay = document.getElementById('tutorial-overlay');
        const tutText = document.getElementById('tutorial-text');
        const tutNextBtn = document.getElementById('tutorial-next-btn');

        // ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ìë™ ì¡°ì¤€ í•¨ìˆ˜ (index.htmlì—ì„œ ê°œì„ í•œ ë²„ì „)
        function moveSpotlight(targetElement, titleStr, descStr, radiusPadding = 40) {
            if (!targetElement) return;
            currentTargetForTutorial = targetElement;

            tutText.classList.remove('active');
            
            setTimeout(() => {
                tutText.querySelector('.tut-title').innerHTML = titleStr;
                tutText.querySelector('.tut-desc').innerHTML = descStr;

                const rect = targetElement.getBoundingClientRect();
                if (rect.width === 0) return;

                const targetCenterX = rect.left + (rect.width / 2);
                const targetCenterY = rect.top + (rect.height / 2);
                const size = Math.max(rect.width, rect.height) + (radiusPadding * 2);

                // ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ì´ë™
                tutOverlay.style.top = `${targetCenterY}px`;
                tutOverlay.style.left = `${targetCenterX}px`;
                tutOverlay.style.width = `${size}px`;
                tutOverlay.style.height = `${size}px`;

                // í…ìŠ¤íŠ¸ ìœ„ì¹˜ ê³„ì‚° (ë²„íŠ¼ ê°€ë¦¼ ë°©ì§€)
                let textTop, textLeft;
                const textWidth = 300; 

                // íƒ€ê²Ÿì´ ì˜¤ë¥¸ìª½ì´ë©´ ì™¼ìª½ ë°°ì¹˜, ì™¼ìª½ì´ë©´ ì˜¤ë¥¸ìª½ ë°°ì¹˜
                if (targetCenterX > window.innerWidth / 2) {
                    textLeft = targetCenterX - (size / 2) - textWidth - 30;
                    tutText.style.alignItems = 'flex-end';
                    tutText.style.textAlign = 'right';
                } else {
                    textLeft = targetCenterX + (size / 2) + 30;
                    tutText.style.alignItems = 'flex-start';
                    tutText.style.textAlign = 'left';
                }

                // íƒ€ê²Ÿì´ ë„ˆë¬´ ì•„ë˜ìª½(ë²„íŠ¼ êµ¬ì—­)ì— ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ë¥¼ ìœ„ë¡œ ì˜¬ë¦¼
                if (targetCenterY > window.innerHeight - 200) {
                    textTop = targetCenterY - (size / 2) - 150; 
                } else {
                    textTop = targetCenterY - 50;
                }

                // í™”ë©´ íƒˆì¶œ ë°©ì§€
                textTop = Math.max(80, Math.min(window.innerHeight - 200, textTop));
                textLeft = Math.max(20, Math.min(window.innerWidth - textWidth - 20, textLeft));

                tutText.style.top = `${textTop}px`;
                tutText.style.left = `${textLeft}px`;
                tutText.style.transform = 'none';

                tutText.classList.add('active');
            }, 650); // ë¶€ë“œëŸ¬ìš´ ì´ë™ ëŒ€ê¸°
        }

        function startArchiveTutorial() {
            isTutorialMode = true;
            tutorialStep = 1;
            
            // 1. ì—¬ê¸°ì„œ ë¬´ì¡°ê±´ í…ìŠ¤íŠ¸ë¥¼ NEXTë¡œ ì¾… ë°•ì•„ì¤ë‹ˆë‹¤.
            tutNextBtn.innerHTML = "NEXT â¯"; 
            
            tutBlocker.classList.add('active');
            tutOverlay.classList.add('active');
            
            // 2. ë²„íŠ¼ì€ ë‹¹ì¥ ë‚˜íƒ€ë‚˜ì§€ ì•Šê²Œ ìˆ¨ê²¨ë‘¡ë‹ˆë‹¤.
            tutNextBtn.classList.remove('active'); 
            tutText.classList.remove('active');

            setTimeout(() => {
                moveSpotlight(document.querySelector('.date-display'), "ì‹œê°„ì˜ íë¦„", "ê¸°ì–µì˜ ì„œê³ ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br>í™”ì‚´í‘œë¥¼ ëˆŒëŸ¬ ê³¼ê±°ì— ê°€ê¾¸ì—ˆë˜ ì •ì›ë“¤ì„ ë‘˜ëŸ¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 40);
                
                // â˜… ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ê°€ ì´ë™í•˜ëŠ” 0.65ì´ˆ ë’¤ì— ìµœì´ˆ ì‹œì‘ íš¨ê³¼ìŒ ì¬ìƒ (ì‹±í¬ ë§ì¶¤)
                setTimeout(() => { playSfx('sfx-tut-1', 1.2); }, 650);

                // 3. ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ê°€ ì´ë™í•˜ëŠ” ì‹œê°„(ì•½ 0.65ì´ˆ)ì„ ê¸°ë‹¤ë ¸ë‹¤ê°€, 1ì´ˆ ë’¤ì— ë²„íŠ¼ ë“±ì¥! (ì´ 1.65ì´ˆ ëŒ€ê¸°)
                setTimeout(() => {
                    tutNextBtn.classList.add('active');
                }, 1650); 
                
            }, 100); 
        }

        // NEXT ë²„íŠ¼ ë¡œì§ (ì„¤ê³„í•œ 5ë‹¨ê³„ íë¦„ + ê´‘í´ ë°©ì§€)
        tutNextBtn.addEventListener('click', () => {
            // ğŸ”¥ ì• ë‹ˆë©”ì´ì…˜ì´ ì§„í–‰ ì¤‘ì´ë©´ í´ë¦­ì„ ì•„ì˜ˆ ë¬´ì‹œ (ê´‘í´ ì°¨ë‹¨)
            if (isTutTransitioning) return; 
            
            isTutTransitioning = true; // ë¬¸ ì ê¸ˆ ğŸ”’
            tutNextBtn.style.opacity = '0.5'; 
            tutNextBtn.style.pointerEvents = 'none';

            playSfx('sfx-click'); // ë²„íŠ¼ ëˆ„ë¥´ëŠ” 'ë”¸ê¹' ì†Œë¦¬ëŠ” ì¦‰ì‹œ ì¬ìƒ

            // ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ê°€ ì´ë™í•˜ëŠ” íƒ€ì´ë°(0.65ì´ˆ)ì— ë§ì¶° íš¨ê³¼ìŒì„ ë‚´ëŠ” ë„ìš°ë¯¸ í•¨ìˆ˜
            const playDelayedSfx = (sfxId) => {
                setTimeout(() => { playSfx(sfxId); }, 650);
            };

            let unlockTime = 800; // ì ê¸ˆ í•´ì œ ê¸°ë³¸ ì‹œê°„

            if (tutorialStep === 1) {
                tutorialStep = 2;
                playDelayedSfx('sfx-tut-2');
                moveSpotlight(els.toggleBtn, "ì›”ë³„ ìˆ˜í™•ëŸ‰", "ì´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, í•´ë‹¹ ì›”ì— ë‹¹ì‹ ì´ ì–¼ë§ˆë‚˜ ë§ì€ ë§ˆìŒì˜ ì–‘ë¶„ì„ ìˆ˜í™•í–ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 20);
            } 
            else if (tutorialStep === 2) {
                tutorialStep = 3;
                playDelayedSfx('sfx-tut-2');
                moveSpotlight(els.diaryBookBtn, "ê¸°ì–µ ì—´ëŒ", "ê·¸ë‹¬ì— ì ì—ˆë˜ ê¸°ë¡ë“¤ì€ ì´ ì±… ì†ì— ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.<br>í˜ì´ì§€ë¥¼ ë„˜ê¸°ë©° ê³¼ê±°ì˜ ë‹¹ì‹ ê³¼ ë§ˆì£¼í•´ë³´ì„¸ìš”.", 10);
            }
            else if (tutorialStep === 3) {
                tutorialStep = 4;
                playDelayedSfx('sfx-tut-3');
                moveSpotlight(els.reportBtn, "ì •ì›ì‚¬ì˜ í¸ì§€", "í•œ ë‹¬ì˜ ê¸°ë¡ì´ ëª¨ì—¬ ì™„ì„±ëœ 'ì •ì›ì‚¬ì˜ ë¦¬í¬íŠ¸'ë„ ì–¸ì œë“  ë‹¤ì‹œ êº¼ë‚´ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 10);
            }
            else if (tutorialStep === 4) {
                tutorialStep = 5;
                playDelayedSfx('sfx-tut-3');
                moveSpotlight(els.returnBtn, "ì •ì›ìœ¼ë¡œ ë³µê·€", "ê³¼ê±° ì—¬í–‰ì„ ë§ˆì¹˜ê³  ëŒì•„ê°€ê³  ì‹¶ë‹¤ë©´ ì´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>ì, ì´ì œ ë‹¹ì‹ ì˜ ë°œìì·¨ë¥¼ í™•ì¸í•´ ë³¼ê¹Œìš”?", 10);
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ë„ í™”ë©´ì´ ë„˜ì–´ê°ˆ ë•Œ ìŠ¤ë¥´ë¥µ ë°”ë€Œë„ë¡ ë™ê¸°í™”
                setTimeout(() => {
                    tutNextBtn.innerHTML = "FINISH â¯"; 
                }, 650);
            }
            else if (tutorialStep === 5) {
                // ì¢…ë£Œ ë¡œì§
                playSfx('sfx-clear', 0.5);
                tutBlocker.classList.remove('active');
                tutOverlay.classList.remove('active');
                tutText.classList.remove('active');
                tutNextBtn.classList.remove('active');

                tutOverlay.style.width = '200vw'; tutOverlay.style.height = '200vh';
                
                isTutorialMode = false;
                tutorialStep = 0;
                localStorage.setItem('geulsup_archive_tutorial_done', 'true'); 

                // ì¢…ë£Œ ì‹œ ë½ í•´ì œ
                isTutTransitioning = false; 
                tutNextBtn.style.opacity = '1';
                tutNextBtn.style.pointerEvents = 'auto';
                return; // ì¢…ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ í•¨ìˆ˜ ì™„ì „íˆ ëë‚´ê¸°
            }

            // â±ï¸ ì§€ì •ëœ ì‹œê°„(unlockTime)ì´ ì§€ë‚˜ë©´ ë¬¸ ì ê¸ˆ í•´ì œ ğŸ”“
            setTimeout(() => {
                isTutTransitioning = false;
                tutNextBtn.style.opacity = '1';
                tutNextBtn.style.pointerEvents = 'auto';
            }, unlockTime);
        });

        // ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
        window.addEventListener('resize', () => {
            if (isTutorialMode && currentTargetForTutorial) {
                const rect = currentTargetForTutorial.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height) + 80;
                tutOverlay.style.top = `${rect.top + (rect.height / 2)}px`;
                tutOverlay.style.left = `${rect.left + (rect.width / 2)}px`;
                tutOverlay.style.width = `${size}px`;
                tutOverlay.style.height = `${size}px`;
            }
        });

        // --- 2. ì„¤ì • ë¡œë“œ (index.htmlê³¼ ë°ì´í„° í‚¤ í†µì¼) ---
        function loadSettings() {
            try {
                const saved = localStorage.getItem('geulsup_settings');
                if (saved) { 
                    const s = JSON.parse(saved);
                    // index.htmlì—ì„œ ì €ì¥í•œ í‚¤(bgmVolume, sfxVolume)ë¥¼ ì •í™•íˆ ì½ì–´ì˜´
                    globalBGMVolume = s.bgmVolume ?? 0.3;
                    globalSFXVolume = s.sfxVolume ?? 0.5;
                    isParallaxOn = s.parallax ?? true;
                }

                // ë°°ê²½ìŒì•… ë³¼ë¥¨ ì¦‰ì‹œ ì ìš©
                if (audioBgm) {
                    const bgmWeight = 0.2; // â˜… ì—¬ê¸° ìˆ«ìë¥¼ ì¡°ì ˆí•˜ì„¸ìš” (0.1 ~ 1.0)
                    audioBgm.volume = Math.min(1, globalBGMVolume * bgmWeight);
                    const playPromise = audioBgm.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(() => {
                            // ë¸Œë¼ìš°ì € ì •ì±…ìœ¼ë¡œ ìë™ì¬ìƒ ë§‰í ê²½ìš°, ì²« í´ë¦­ ì‹œ ì¬ìƒ
                            document.addEventListener('click', () => { 
                                audioBgm.play(); 
                            }, { once: true });
                        });
                    }
                }
            } catch (e) {
                console.error("ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e);
            }
        }
        loadSettings(); // ì‹¤í–‰

        function playSfx(input, multiplier = 1.0) {
            let audioEl = input;

            // 1. ë§Œì•½ ì…ë ¥ê°’ì´ ë¬¸ìì—´(ID)ì´ë¼ë©´ ìš”ì†Œ ì°¾ê¸°
            if (typeof input === 'string') {
                // 'click'ë§Œ ë„£ì–´ë„ 'sfx-click'ì„ ì°¾ë„ë¡ í¸ì˜ì„± ì¶”ê°€ (ì„ íƒì‚¬í•­)
                if(!input.startsWith('sfx-') && !input.startsWith('bgm-')) {
                    audioEl = document.getElementById('sfx-' + input); 
                } else {
                    audioEl = document.getElementById(input);
                }
            }

            // 2. ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ (ì—ëŸ¬ ë°©ì§€)
            if (!audioEl) {
                console.warn("ì˜¤ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", input);
                return;
            }

            // 3. ì¬ìƒ (cloneNode ì‚¬ìš©)
            try {
                const sound = audioEl.cloneNode();
                sound.volume = globalSFXVolume * multiplier; 
                sound.play().catch(() => {});
            } catch (e) {
                console.error("ì¬ìƒ ì˜¤ë¥˜:", e);
            }
        }

        // --- 4. ë¹„ì£¼ì–¼ (íŒŒí‹°í´, ë³„) ---
        const canvas = document.getElementById('dust-canvas');
        const ctx = canvas.getContext('2d');
        const starsContainer = document.getElementById('stars-container');
        let width, height;

        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resize); resize();

        function createStars() {
            for(let i=0; i<80; i++) {
                const s = document.createElement('div');
                s.style.position = 'absolute'; s.style.background = '#fff'; s.style.borderRadius = '50%';
                s.style.width = Math.random()*2 + 'px'; s.style.height = s.style.width;
                s.style.left = Math.random()*100 + '%'; s.style.top = Math.random()*60 + '%';
                s.style.opacity = Math.random()*0.5 + 0.1;
                s.style.boxShadow = `0 0 ${Math.random()*5}px rgba(255,255,255,0.8)`;
                starsContainer.appendChild(s);
            }
        }
        createStars();

        const particles = [];
        class Mote {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * width; this.y = height + Math.random() * 200;
                this.size = Math.random() * 3 + 1; this.speed = Math.random() * 0.5 + 0.2;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.y -= this.speed; this.opacity -= 0.001;
                if(this.y < 0 || this.opacity <= 0) this.reset();
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.fillStyle = `rgba(200, 220, 255, ${this.opacity})`;
                ctx.shadowBlur = 10; ctx.shadowColor = "rgba(200,220,255,0.5)";
                ctx.fill(); ctx.shadowBlur = 0;
            }
        }
        for(let i=0; i<60; i++) particles.push(new Mote());
        function animate() {
            ctx.clearRect(0,0,width,height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        // --- 5. íŒŒëŸ´ë™ìŠ¤ ì—”ì§„ ---
        let mouseX = 0, mouseY = 0, targetX = 0, targetY = 0;
        const parallaxSens = 0.5;

        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - width / 2) / (width / 2);
            mouseY = (e.clientY - height / 2) / (height / 2);
        });

        function updateParallax() {
            const islands = document.querySelectorAll('.island-obj');

            if(isParallaxOn) {
                // [ON] ë§ˆìš°ìŠ¤ ë”°ë¼ ì›€ì§ì„ + ì¤‘ì•™ ì •ë ¬ ë³´ì •
                targetX += (mouseX - targetX) * 0.05;
                targetY += (mouseY - targetY) * 0.05;

                islands.forEach(obj => {
                    const depth = parseFloat(obj.dataset.depth || 0.02);
                    const bx = parseFloat(obj.dataset.baseX);
                    const by = parseFloat(obj.dataset.baseY);
                    
                    const moveX = targetX * depth * width * -1 * parallaxSens;
                    const moveY = targetY * depth * height * -1 * parallaxSens;

                    obj.style.left = `${bx}%`; 
                    obj.style.top = `${by}%`;
                    // ì—¬ê¸°ì„œ -50%ë¥¼ í•´ì¤˜ì•¼ ì„¬ì˜ ì¤‘ì‹¬ì´ ì¢Œí‘œì— ì˜´
                    obj.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
                });
            } else {
                // [OFF] ì›€ì§ì„ ì—†ìŒ + ê°•ì œ ì¤‘ì•™ ì •ë ¬
                islands.forEach(obj => {
                    const bx = parseFloat(obj.dataset.baseX);
                    const by = parseFloat(obj.dataset.baseY);
                    
                    obj.style.left = `${bx}%`; 
                    obj.style.top = `${by}%`;
                    // ì›€ì§ì„ ê°’(moveX, Y)ì„ ë¹¼ê³  ì •ì¤‘ì•™ ê³ ì •
                    obj.style.transform = `translate(-50%, -50%)`;
                });
            }
            requestAnimationFrame(updateParallax);
        }
        updateParallax();

        // --- 6. ë¡œì§ & UI ---
        const firebaseConfig = {
            apiKey: "AIzaSyANMznf6jeSLcLBPMZz7UrU7yf5YR3y18s",
            authDomain: "geulsup.firebaseapp.com",
            projectId: "geulsup",
            storageBucket: "geulsup.firebasestorage.app",
            messagingSenderId: "16178537421",
            appId: "1:16178537421:web:f6cf9fbe1317809d721a84",
            measurementId: "G-TQ6Z3SQKPM"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let archiveList = [];
        let currentIndex = 0;
        const virtueConfig = {
            wisdom: { color: '#4db8ff', icon: 'ğŸ“˜' },
            courage: { color: '#ff6b6b', icon: 'âš”ï¸' },
            kindness: { color: '#ff85a2', icon: 'ğŸ’–' },
            diligence: { color: '#2ecc71', icon: 'ğŸŒ±' },
            serenity: { color: '#81ecec', icon: 'ğŸŒ™' }
        };

        const els = {
            year: document.getElementById('disp-year'),
            month: document.getElementById('disp-month'),
            stage: document.getElementById('stage-inner'),
            prevBtn: document.getElementById('btn-prev'),
            nextBtn: document.getElementById('btn-next'),
            toggleBtn: document.getElementById('stats-toggle-btn'),
            panel: document.getElementById('stats-panel'),
            closePanel: document.querySelector('.close-panel-btn'),
            statsList: document.getElementById('stats-list-container'),
            transition: document.getElementById('page-transition'),
            returnBtn: document.getElementById('return-btn'),
            reportBtn: document.getElementById('report-btn'),
            reportModal: document.getElementById('report-modal'),
            closeReport: document.querySelector('.close-report-x'),
            rptTitle: document.getElementById('rpt-title'),
            rptPersona: document.getElementById('rpt-persona-box'),
            rptQuotes: document.getElementById('rpt-quotes-box'),
            diaryBookBtn: document.getElementById('diary-book-btn'),
            bookModal: document.getElementById('diary-book-modal'),
            realBook: document.getElementById('real-book'),
            closeBook: document.querySelector('.close-book-x'),
            bookPrev: document.getElementById('book-prev'),
            bookNext: document.getElementById('book-next'),
            bookPagination: document.getElementById('book-pagination')
        };

        // ì•ˆë‚´ì°½ ë‹«ê¸° ë²„íŠ¼
        const closeNoticeBtn = document.getElementById('close-notice-btn');
        if (closeNoticeBtn) {
            closeNoticeBtn.addEventListener('click', () => {
                playSfx(audioClick);
                const notice = document.getElementById('current-month-notice');
                notice.style.opacity = '0';
                
                setTimeout(() => { 
                    notice.style.visibility = 'hidden';             
                }, 500);
            });
        }

        // [ìˆ˜ì •] ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ (ê²ŒìŠ¤íŠ¸ í—ˆìš© ë¡œì§ ì¶”ê°€)
        auth.onAuthStateChanged(async (user) => {
            
            // ğŸ”¥ [í•´ì»¤í†¤ ì¹˜íŠ¸í‚¤] í…ŒìŠ¤í„°(ê°œë°œì) ë„ì¥ì´ ìˆëŠ”ì§€ ì œì¼ ë¨¼ì € í™•ì¸! ğŸ”¥
            if (localStorage.getItem('geulsup_dev_mode') === 'true') {
                console.log("ğŸ‘‘ í…ŒìŠ¤í„° ê³„ì •ìœ¼ë¡œ ì—­ì‚¬ê´€ í”„ë¦¬íŒ¨ìŠ¤ ì…ì¥!");
                isGuestMode = false;
                await loadData('tester_dev_001'); // í…ŒìŠ¤í„° DBì—ì„œ ì‹¹ ê¸ì–´ì˜´
                return; // ì—¬ê¸°ì„œ í†µê³¼ì‹œì¼œì£¼ê³  í•¨ìˆ˜ ì¢…ë£Œ!
            }

            if (user) {
                // 1. êµ¬ê¸€ ë¡œê·¸ì¸ íšŒì›ì¸ ê²½ìš°
                isGuestMode = false;
                await loadData(user.uid);
            } else {
                // 2. ë¡œê·¸ì¸ì´ ì•ˆ ëœ ê²½ìš° -> ê²ŒìŠ¤íŠ¸ì¸ì§€ í™•ì¸
                const isGuest = localStorage.getItem('geulsup_is_guest') === 'true';
                
                if (isGuest) {
                    // ì¼ê¸°ë¥¼ ì•ˆ ì¼ì–´ë„ ê²ŒìŠ¤íŠ¸ ì ‘ì† ìƒíƒœë©´ í†µê³¼!
                    console.log("ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì—­ì‚¬ê´€ ì§„ì…");
                    isGuestMode = true;
                    await loadData('guest'); 
                } else {
                    // ì§„ì§œ ë¡œê·¸ì¸ì„ ì•ˆ í•œ ì‚¬ëŒë§Œ ì«“ì•„ëƒ„
                    alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    window.location.href = 'index.html';
                }
            }
        });

        function updateBookPosition() {
            if (currentBookPage > 0) els.realBook.classList.add('is-open'); 
            else els.realBook.classList.remove('is-open'); 
        }

        // [ìˆ˜ì •] ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadData(uid) {
            try {
                let diaryList = [];
                let archiveMap = {}; // ê²ŒìŠ¤íŠ¸ëŠ” ì•„ì¹´ì´ë¸Œ ì €ì¥ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ë¹ˆ ê°ì²´ ì‚¬ìš©

                if (isGuestMode) {
                    // [Guest] ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    const localData = localStorage.getItem('geulsup_guest_diaries');
                    if (localData) {
                        diaryList = JSON.parse(localData);
                        // íƒ€ì„ìŠ¤íƒ¬í”„ ë³µì›
                        diaryList.forEach(d => {
                            d.timestamp = { toDate: () => new Date(d.date_str) };
                        });
                    }
                } else {
                    // [Member] Firebaseì—ì„œ ìœ ì € ì •ë³´ ë° ì¼ê¸°/ì•„ì¹´ì´ë¸Œ ê°€ì ¸ì˜¤ê¸°
                    // (ìœ ì € ë‹‰ë„¤ì„ ë¡œë“œëŠ” ì—¬ê¸°ì„  êµ³ì´ í•„ìš” ì—†ì§€ë§Œ ì›ë³¸ ìœ ì§€)
                    const userDoc = await db.collection('users').doc(uid).get();
                    
                    const diarySnapshot = await db.collection('users').doc(uid).collection('diaries').get();
                    diarySnapshot.forEach(doc => diaryList.push(doc.data()));

                    const archiveSnapshot = await db.collection('users').doc(uid).collection('archives').get();
                    archiveSnapshot.forEach(doc => {
                        archiveMap[doc.id] = doc.data();
                    });
                }

                // --- ì—¬ê¸°ë¶€í„°ëŠ” ê³µí†µ ë¡œì§ (ì›”ë³„ í†µê³„ ê³„ì‚°) ---
                const calculatedStats = {}; 
                const diaryCounts = {}; 

                diaryList.forEach(d => {
                    let dDate = null;
                    if(d.timestamp && typeof d.timestamp.toDate === 'function') dDate = d.timestamp.toDate();
                    else if(d.date_str) dDate = new Date(d.date_str);

                    if(dDate) {
                        const y = dDate.getFullYear();
                        const m = String(dDate.getMonth()+1).padStart(2, '0');
                        const key = `${y}-${m}`;

                        if(!calculatedStats[key]) calculatedStats[key] = { wisdom:0, courage:0, kindness:0, diligence:0, serenity:0 };
                        if(!diaryCounts[key]) diaryCounts[key] = 0; 
                        
                        diaryCounts[key]++; 

                        if(d.stat_increase) {
                            for(const [v, val] of Object.entries(d.stat_increase)) {
                                if(calculatedStats[key][v] !== undefined) calculatedStats[key][v] += (parseInt(val) || 0);
                            }
                        }
                    }
                });

                archiveList = [];
                const now = new Date();
                const startDate = new Date('2024-01-01'); 
                let loopDate = new Date(now.getFullYear(), now.getMonth(), 1); 

                // ë‹¬ë ¥ ë£¨í”„ (í˜„ì¬ ë‹¬ë¶€í„° ê³¼ê±°ë¡œ)
                while (loopDate >= startDate) {
                    const y = loopDate.getFullYear();
                    const m = String(loopDate.getMonth() + 1).padStart(2, '0');
                    const id = `${y}-${m}`; 
                    
                    let points = { wisdom:0, courage:0, kindness:0, diligence:0, serenity:0 };
                    let summary = null;
                    let count = diaryCounts[id] || 0; 

                    // ì•„ì¹´ì´ë¸Œ(ì €ì¥ëœ ì›”ë§ì •ì‚°)ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
                    if (archiveMap[id]) {
                        if (archiveMap[id].points) points = archiveMap[id].points;
                        if (archiveMap[id].summary) summary = archiveMap[id].summary;
                    } else if (calculatedStats[id]) {
                        // ì—†ìœ¼ë©´ ì¼ê¸°ì—ì„œ ê³„ì‚°ëœ í†µê³„ ì‚¬ìš©
                        points = calculatedStats[id];
                    }

                    archiveList.push({
                        id: id,
                        points: points,
                        summary: summary,
                        diaryCount: count
                    });
                    
                    loopDate.setMonth(loopDate.getMonth() - 1);
                }

                // ì•„ì§ ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ì„ ë•Œ í˜„ì¬ ë‹¬ ê¸°ë³¸ ì¶”ê°€
                if (archiveList.length === 0) {
                    const m = String(now.getMonth() + 1).padStart(2, '0');
                    archiveList.push({
                        id: `${now.getFullYear()}-${m}`,
                        points: { wisdom:0, courage:0, kindness:0, diligence:0, serenity:0 },
                        summary: null,
                        diaryCount: 0
                    });
                }

                renderPage(0, 'init');
                setTimeout(() => { 
                    els.transition.classList.add('fade-out'); 
                    if (!localStorage.getItem('geulsup_archive_tutorial_done')) {
                        setTimeout(startArchiveTutorial, 800); 
                    }
                }, 1000);

            } catch (e) {
                console.error(e);
                alert("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: " + e.message);
                window.location.href = 'index.html'; // ì˜¤ë¥˜ ì‹œ ì•ˆì „í•˜ê²Œ ë³µê·€
            }
        }

        function renderPage(idx, dir) {
            const data = archiveList[idx];
            const [y, m] = data.id.split('-');
            
            els.year.innerText = y;
            els.month.innerText = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][parseInt(m)-1];

            let stats = data.points || { wisdom:0, courage:0, kindness:0, diligence:0, serenity:0 };
            
            Object.keys(virtueConfig).forEach(key => {
                const val = stats[key] || 0;
                const lvl = getLevel(val);
                const img = document.querySelector(`#isl-${key} img`);
                img.style.opacity = "0";
                setTimeout(() => {
                    img.src = `images/island_${key}_${lvl}.png`;
                    img.onload = () => { img.style.opacity = "1"; };
                    img.onerror = () => { img.src = `images/island_${key}_1.png`; img.style.opacity = "1"; };
                }, 300);
            });

            buildStats(stats);
            
            els.reportBtn.disabled = false;

            if (dir !== 'init') {
                els.stage.style.opacity = '0';
                // closeStats(true)ë¥¼ ë„˜ê²¨ì„œ ì†Œë¦¬ ì—†ì´ íŒ¨ë„ë§Œ ì´ˆê¸°í™”í•˜ë„ë¡ ì§€ì‹œ!
                setTimeout(() => { els.stage.style.opacity = '1'; closeStats(true); }, 400); 
            }

            els.prevBtn.disabled = (idx >= archiveList.length - 1);
            els.nextBtn.disabled = (idx <= 0);
        }

        function buildStats(stats) {
            els.statsList.innerHTML = '';
            const max = Math.max(...Object.values(stats), 10);
            for (const [key, cfg] of Object.entries(virtueConfig)) {
                const val = stats[key] || 0;
                const pct = (val / max) * 100;
                const div = document.createElement('div');
                div.className = 'stat-row';
                div.innerHTML = `
                    <div class="stat-icon">${cfg.icon}</div>
                    <div class="stat-name">${key.toUpperCase()}</div>
                    <div class="stat-track"><div class="stat-fill" style="width:0%; background-color:${cfg.color}; box-shadow:0 0 10px ${cfg.color}"></div></div>
                    <div class="stat-val" style="color:${cfg.color}">${val}</div>
                `;
                div.querySelector('.stat-fill').dataset.targetWidth = pct + '%';
                els.statsList.appendChild(div);
            }
        }

        function openStats() {
            playSfx(audioClick);
            els.toggleBtn.classList.add('hidden'); els.panel.classList.add('active');
            setTimeout(() => { document.querySelectorAll('.stat-fill').forEach(bar => { bar.style.width = bar.dataset.targetWidth; }); }, 300);
        }
        function closeStats(isSilent) {
            // isSilentê°€ ëª…ì‹œì ìœ¼ë¡œ trueì¼ ë•Œ(ê°•ì œ ì¢…ë£Œ ì‹œ)ëŠ” ì†Œë¦¬ë¥¼ ë‚´ì§€ ì•ŠìŒ
            if (isSilent !== true) {
                playSfx(audioClick);
            }
            els.panel.classList.remove('active'); 
            els.toggleBtn.classList.remove('hidden');
            document.querySelectorAll('.stat-fill').forEach(bar => { bar.style.width = '0%'; });
        }

        function openReport() {
            playSfx(audioClick);
            const data = archiveList[currentIndex];
            
            if (data.summary) {
                const [y, m] = data.id.split('-');
                els.rptTitle.innerText = `${["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][parseInt(m)-1]} ${y}`;

                els.rptPersona.innerHTML = '';
                const personas = data.summary.persona || ["ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."];
                personas.forEach(p => {
                    const div = document.createElement('div'); div.className = 'persona-text'; div.innerText = `"${p}"`;
                    els.rptPersona.appendChild(div);
                });

                els.rptQuotes.innerHTML = '';
                const quotes = data.summary.quotes || {};
                for(const [key, arr] of Object.entries(quotes)) {
                    if(Array.isArray(arr) && arr.length > 0) {
                        const group = document.createElement('div'); group.className = 'virtue-group';
                        group.innerHTML = `<div class="virtue-title" style="--v-color:${virtueConfig[key].color}">${key.toUpperCase()}</div>`;
                        arr.forEach(item => {
                            let text = "", dateStr = "Unknown Date";
                            if(typeof item === 'object' && item !== null) {
                                text = item.text || "";
                                if(item.date) {
                                    const d = new Date(item.date);
                                    if(!isNaN(d)) dateStr = `${String(d.getMonth()+1).padStart(2,'0')}. ${String(d.getDate()).padStart(2,'0')}`;
                                    else dateStr = item.date;
                                }
                            } else { text = item; }
                            const qDiv = document.createElement('div'); qDiv.className = 'quote-item';
                            qDiv.innerHTML = `<span class="q-date">${dateStr}</span><span class="q-text">"${text}"</span>`;
                            group.appendChild(qDiv);
                        });
                        els.rptQuotes.appendChild(group);
                    }
                }
                els.reportModal.classList.add('active');
                return;
            }

            const [dataY, dataM] = data.id.split('-').map(Number);
            const now = new Date();
            const currY = now.getFullYear();
            const currM = now.getMonth() + 1;

            const isPast = (dataY < currY) || (dataY === currY && dataM < currM);

            const notice = document.getElementById('current-month-notice');
            const sub = document.getElementById('notice-subtitle');
            const title = document.getElementById('notice-title');
            const desc = document.getElementById('notice-desc');
            const btnCreate = document.getElementById('btn-notice-create');
            
            if (isPast) {
                if (data.diaryCount < 5) {
                    if(sub) sub.innerText = "LACK OF MEMORIES";
                    if(title) title.innerHTML = "ê¸°ë¡ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    if(desc) desc.innerHTML = `ì›”ê°„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•˜ë ¤ë©´<br>ìµœì†Œ 5ê°œì˜ ì¼ê¸°ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br><br><span style="color:#d4af37; font-size:0.8rem;">(í˜„ì¬ ê¸°ë¡: ${data.diaryCount}ê°œ)</span>`;
                    if(btnCreate) btnCreate.style.display = 'none'; 
                } else {
                    if(sub) sub.innerText = "UNFINISHED TALE";
                    if(title) title.innerHTML = "ì´ ë‹¬ì˜ ë¦¬í¬íŠ¸ê°€<br>ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                    if(desc) desc.innerHTML = "ê¸°ë¡ì„ ì •ë¦¬í•˜ì—¬ ì›”ê°„ ë¦¬í¬íŠ¸ë¥¼<br>ì§€ê¸ˆ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                    
                    if(btnCreate) {
                        btnCreate.style.display = 'inline-block';
                        btnCreate.onclick = () => {
                            sessionStorage.setItem('forceSeasonReport', 'true');
                            sessionStorage.setItem('targetPeriod', data.id);
                            window.location.href = 'index.html';
                        };
                    }
                }
            } else {
                if(sub) sub.innerText = "IN PROGRESS";
                if(title) title.innerHTML = "ì´ ë‹¬ì˜ ê¸°ì–µì€<br>ì•„ì§ ì—®ì–´ì§€ëŠ” ì¤‘ì…ë‹ˆë‹¤.";
                if(desc) desc.innerHTML = "ì›”ê°„ ë¦¬í¬íŠ¸ëŠ” ë‹¤ìŒ ë‹¬ì´ ì‹œì‘ë  ë•Œ<br>ì •ì›ì‚¬ê°€ ì •ì„±ê» ì‘ì„±í•´ ë“œë¦½ë‹ˆë‹¤.";
                if(btnCreate) btnCreate.style.display = 'none';
            }

            if(notice) {
                notice.style.visibility = 'visible';
                notice.style.opacity = '1';
            }
        }

        let currentBookPage = 0;
        let totalBookPages = 0;

        // [ìˆ˜ì •] 3D ì¼ê¸°ì¥ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function openDiaryBook() {
            playSfx('sfx-click');
            const data = archiveList[currentIndex];
            const [y, m] = data.id.split('-');
            
            document.getElementById('book-cover-date').innerText = `${y} . ${m}`;
            els.bookModal.classList.add('active');
            
            const pages = Array.from(els.realBook.children);
            for(let i=1; i<pages.length; i++) pages[i].remove();

            try {
                let diaries = [];
                const startStr = `${y}-${m}-01`;
                const lastDay = new Date(y, m, 0).getDate();
                const endStr = `${y}-${m}-${lastDay}`;

                if (isGuestMode) {
                    // [Guest] ë¡œì»¬ ë°ì´í„°ì—ì„œ ë‚ ì§œ í•„í„°ë§
                    const localData = localStorage.getItem('geulsup_guest_diaries');
                    if (localData) {
                        const allDiaries = JSON.parse(localData);
                        // ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ ë° ë²”ìœ„ í•„í„°ë§
                        diaries = allDiaries
                            .filter(d => d.date_str >= startStr && d.date_str <= endStr)
                            .sort((a, b) => a.date_str.localeCompare(b.date_str));
                    }
                } else {
                    // ğŸ”¥ [í•´ì»¤í†¤ ì¹˜íŠ¸í‚¤] í…ŒìŠ¤í„° ëª¨ë“œë©´ ê°•ì œë¡œ tester_dev_001 UID ì‚¬ìš© ğŸ”¥
                    const targetUid = localStorage.getItem('geulsup_dev_mode') === 'true' 
                                      ? 'tester_dev_001' 
                                      : auth.currentUser.uid;

                    // [Member & Tester] Firebase ì¿¼ë¦¬
                    const snapshot = await db.collection('users').doc(targetUid).collection('diaries')
                        .where('date_str', '>=', startStr).where('date_str', '<=', endStr)
                        .orderBy('date_str', 'asc')
                        .get();
                    snapshot.forEach(doc => diaries.push(doc.data()));
                }

                // [ê³µí†µ] ì±… í˜ì´ì§€ ìƒì„±
                if(diaries.length === 0) {
                    addSheet("ê¸°ë¡ ì—†ìŒ", "ì´ ë‹¬ì—ëŠ” ë‚¨ê²¨ì§„ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.", null, "", "", null);
                } else {
                    for(let i=0; i<diaries.length; i+=2) {
                        const d1 = diaries[i];
                        const d2 = diaries[i+1] || null; 
                        addSheet(
                            d1.date_str, d1.content, d1.ai_reply, 
                            d2 ? d2.date_str : "", d2 ? d2.content : "", d2 ? d2.ai_reply : null
                        );
                    }
                }
                
                addBackCover(); 

                currentBookPage = 0;
                totalBookPages = els.realBook.children.length;
                updateZIndex();
                updatePagination();
                updateBookPosition();

            } catch (e) {
                console.error(e);
                alert("ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function addBackCover() {
            const paper = document.createElement('div');
            paper.className = 'paper';
            
            const front = document.createElement('div');
            front.className = 'front';
            front.style.background = "linear-gradient(to right, #e3d2b4, #fff9e6 15%)"; 
            front.innerHTML = `
                <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; opacity:0.2;">
                    <div style="font-family:'Cinzel'; font-size:1.5rem; margin-bottom:10px;">FIN</div>
                    <div style="font-family:'Nanum Myeongjo'; font-size:0.8rem;">ê¸°ì–µì˜ ì •ì›, ê¸€ìˆ²</div>
                </div>
            `;

            const back = document.createElement('div');
            back.className = 'back cover-page'; 
            back.style.borderLeft = "2px solid #d4af37"; 
            back.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100%;">
                    <div style="font-family:'Cinzel'; font-size:2.5rem; opacity:0.8; filter:blur(0.5px);">G S</div>
                </div>
            `;

            paper.appendChild(front);
            paper.appendChild(back);
            
            paper.addEventListener('click', () => {
                if(paper.classList.contains('flipped')) goPrevPage();
                else goNextPage();
            });

            els.realBook.appendChild(paper);
        }

        function addSheet(date1, text1, reply1, date2, text2, reply2) {
            const paper = document.createElement('div');
            paper.className = 'paper';
            
            const front = document.createElement('div');
            front.className = 'front';
            front.innerHTML = `
                <div class="d-date-title">${date1}</div>
                <div class="d-content-text">${text1}</div>
                ${reply1 ? `<div class="d-reply-box">ğŸŒ¿ ${reply1}</div>` : ''}
            `;

            const back = document.createElement('div');
            back.className = 'back';
            if (date2) {
                back.innerHTML = `
                    <div class="d-date-title">${date2}</div>
                    <div class="d-content-text">${text2}</div>
                    ${reply2 ? `<div class="d-reply-box">ğŸŒ¿ ${reply2}</div>` : ''} 
                `; 
            } else {
                back.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%; opacity:0.1; font-family:'Cinzel'; font-size:2rem;">GEULSEUP</div>`;
            }

            paper.appendChild(front);
            paper.appendChild(back);
            
            paper.addEventListener('click', () => {
                if(paper.classList.contains('flipped')) goPrevPage();
                else goNextPage();
            });

            els.realBook.appendChild(paper);
        }

        function goNextPage() {
            if(currentBookPage < totalBookPages) { 
                playSfx(audioPage); 
                els.realBook.children[currentBookPage].classList.add('flipped');
                currentBookPage++;
                updateZIndex();
                updatePagination();
                updateBookPosition();
            }
        }

        function goPrevPage() {
            if(currentBookPage > 0) {
                playSfx(audioPage); 
                currentBookPage--;
                els.realBook.children[currentBookPage].classList.remove('flipped');
                updateZIndex();
                updatePagination();
                updateBookPosition();
            }
        }

        function updateZIndex() {
            const papers = Array.from(els.realBook.children);
            papers.forEach((p, i) => {
                if (i < currentBookPage) p.style.zIndex = i; 
                else p.style.zIndex = totalBookPages - i;
            });
        }

        function updatePagination() {
            if (currentBookPage === 0) {
                els.bookPagination.innerText = "Cover";
            } else if (currentBookPage === totalBookPages) {
                els.bookPagination.innerText = "Back Cover"; 
            } else {
                els.bookPagination.innerText = `${currentBookPage} / ${totalBookPages - 1}`;
            }
        }

        function getLevel(p) {
            if(p<=15) return 1; if(p<=30) return 2; if(p<=45) return 3; if(p<=60) return 4;
            if(p<=75) return 5; if(p<=90) return 6; if(p<=105) return 7; if(p<=125) return 8;
            if(p<=150) return 9; return 10;
        }

        els.toggleBtn.addEventListener('click', openStats);
        els.closePanel.addEventListener('click', closeStats);
        els.reportBtn.addEventListener('click', openReport);
        els.closeReport.addEventListener('click', () => { playSfx(audioClick); els.reportModal.classList.remove('active'); });
        
        els.diaryBookBtn.addEventListener('click', openDiaryBook);
        els.closeBook.addEventListener('click', () => { playSfx(audioClick); els.bookModal.classList.remove('active'); });
        els.bookNext.addEventListener('click', goNextPage);
        els.bookPrev.addEventListener('click', goPrevPage);
        
        document.querySelector('.cover-page').parentElement.addEventListener('click', () => {
             if(!document.querySelector('.cover-page').parentElement.classList.contains('flipped')) goNextPage();
             else goPrevPage();
        });

        els.prevBtn.addEventListener('click', () => { playSfx(audioClick); if(currentIndex < archiveList.length - 1) { currentIndex++; renderPage(currentIndex, 'prev'); } });
        els.nextBtn.addEventListener('click', () => { playSfx(audioClick); if(currentIndex > 0) { currentIndex--; renderPage(currentIndex, 'next'); } });
        
        els.returnBtn.addEventListener('click', () => {
            playSfx(audioClick);
            sessionStorage.setItem('skipIntro', 'true'); 
            els.transition.classList.remove('fade-out');
            setTimeout(() => { window.location.href = 'index.html'; }, 1200);
        });

        // ëª¨ë“  ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œì— í˜¸ë²„ ë° íš¨ê³¼ìŒ ì—°ê²° (NEW)
        const interactiveElements = document.querySelectorAll('button, .nav-btn, #stats-toggle-btn, .close-book-x, .close-panel-btn, .close-report-x, .island-obj');
        interactiveElements.forEach(el => {
            el.addEventListener('mouseenter', () => playSfx(audioHover));
            // ëŒ€ë¶€ë¶„ì˜ ë²„íŠ¼ì€ ê°œë³„ í•¨ìˆ˜ì—ì„œ playSfx(audioClick)ì„ í˜¸ì¶œí•˜ë¯€ë¡œ ì¤‘ë³µ ë°©ì§€
        });

        document.getElementById('tutorial-help-btn').addEventListener('click', () => {
            playSfx('sfx-click'); // ì„¤ì •í•˜ì‹  í´ë¦­ íš¨ê³¼ìŒ ì¬ìƒ
            startArchiveTutorial();
        });
    </script>
</body>
</html>