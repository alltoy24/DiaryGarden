<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ìˆ² - ê¸€ì´ ì •ì›ì„ ë§Œë“¤ë‹¤ (Evolution Dev)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nanum+Myeongjo:wght@400;700&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    
    <style>
        /* --- [Diary ì „ìš© ìŠ¤íƒ€ì¼ ì •ë¦¬] --- */

        /* 1. ì¼ê¸° ì—´ê¸° ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) */
        #diary-open-btn {
            position: fixed;
            bottom: 50px;
            right: 50px;
            z-index: 1000;
            background: transparent;
            border: none;
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            letter-spacing: 0.2rem;
            cursor: pointer;
            opacity: 0; 
            visibility: hidden;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }

        #diary-open-btn.visible { 
            opacity: 0.7; 
            visibility: visible;
            pointer-events: auto; 
        }

        #diary-open-btn:hover { 
            opacity: 1; 
            transform: translateY(-5px); 
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6); 
        }

        .btn-line {
            width: 0%; height: 1px; background: #d4af37;
            transition: width 0.4s ease; margin-top: 5px;
        }
        #diary-open-btn:hover .btn-line { width: 100%; }

        /* 2. ì¼ê¸° ëª¨ë‹¬ ì „ì²´ ë°°ê²½ */
        #diary-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px); /* ìˆ²ì´ ëª½í™˜ì ìœ¼ë¡œ ë¹„ì¹¨ */
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; 
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        #diary-modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* 3. ì¼ê¸° ì‘ì„± ì°½ (ë””ìì¸ í•µì‹¬) */
        .diary-window {
            width: 550px;
            background: linear-gradient(145deg, rgba(20, 25, 30, 0.95), rgba(10, 12, 15, 0.98));
            border: 1px solid rgba(212, 175, 55, 0.25);
            padding: 50px 40px;
            position: relative;
            box-shadow: 0 40px 100px rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            /* ì• ë‹ˆë©”ì´ì…˜: ì‚´ì§ ì•„ë˜ì—ì„œ ë¶€ë“œëŸ½ê²Œ ë– ì˜¤ë¦„ */
            transform: translateY(30px) scale(0.98);
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #diary-modal.active .diary-window {
            transform: translateY(0) scale(1);
        }

        .diary-header {
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
            padding-bottom: 20px;
        }

        #diary-date-display {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: #ffd700;
            letter-spacing: 0.1rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        /* 4. í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ (ì¤‘ë³µ ìŠ¤íƒ€ì¼ í†µí•©) */
        #diary-textarea {
            width: 100%;
            height: 300px;
            background: rgba(255, 255, 255, 0.02);
            border: none;
            color: #e0e0e0;
            font-family: 'Nanum Pen Script', cursive;
            font-size: 1rem;
            line-height: 1.8;
            resize: none;
            outline: none;
            padding: 15px;
            transition: background 0.3s ease;
        }

        #diary-textarea:focus {
            background: rgba(255, 255, 255, 0.04);
        }

        #diary-textarea::placeholder {
            color: #555;
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1rem;
        }

        /* 5. ë²„íŠ¼ ë° ê¸°íƒ€ ìš”ì†Œ */
        .char-counter {
            text-align: right;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            color: #666;
            margin-top: 15px;
        }

        .char-counter.invalid { color: #cc4444; }

        .diary-submit-btn {
            margin-top: 30px;
            background: transparent;
            border: 1px solid rgba(212, 175, 55, 0.4);
            color: #d4af37;
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1rem;
            padding: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .diary-submit-btn:disabled { 
            border-color: #333; color: #444; cursor: not-allowed; 
        }

        .diary-submit-btn:not(:disabled):hover { 
            background: rgba(212, 175, 55, 0.1); 
            border-color: #d4af37;
            color: #fff;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.15);
        }

        .close-modal {
            position: absolute;
            top: 20px; right: 25px;
            color: rgba(212, 175, 55, 0.5); 
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .close-modal:hover { 
            color: #d4af37; 
            transform: rotate(90deg); 
        }

        .close-modal {
            position: absolute;
            top: 15px; right: 20px;
            color: #888; cursor: pointer;
            font-family: sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; cursor: default; }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: #000; }

        /* ì›”ë“œ ì»¨í…Œì´ë„ˆ */
        #world-container {
            position: relative; width: 100%; height: 100%;
            transition: transform 3.5s cubic-bezier(0.25, 1, 0.5, 1);
            transform-origin: center center; overflow: hidden; 
        }

        /* ë°°ê²½ */
        #sky-bg {
            position: absolute; top: -20%; left: -20%; width: 140%; height: 140%;
            background: linear-gradient(160deg, #0f2027 0%, #203a43 60%, #2c5364 100%);
            z-index: 1; transition: background 3s ease-in-out;
        }

        /* ë³„ (ë°¤) */
        #stars-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none; opacity: 0; transition: opacity 3s ease-in-out;
        }
        .star {
            position: absolute; background-color: white; border-radius: 50%;
            box-shadow: 0 0 4px 1px rgba(255, 255, 255, 0.4);
            animation: twinkle var(--duration) ease-in-out infinite; opacity: var(--opacity);
        }
        @keyframes twinkle { 0%, 100% { opacity: var(--opacity); transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.8); } }

        /* ë°”ë‹¥ ìš´í•´ */
        #cloud-floor {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            background: linear-gradient(to top, rgba(255,255,255,0.95) 10%, rgba(220,230,255,0.8) 40%, rgba(255,255,255,0) 100%);
            z-index: 3; pointer-events: none; opacity: 0; transition: opacity 3s ease-in-out;
        }

        /* íŒŒí‹°í´ ìº”ë²„ìŠ¤ */
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; pointer-events: none; }

        /* UI ë ˆì´ì–´ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            padding: 60px; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start;
            transition: opacity 1.5s ease-out; background: linear-gradient(to right, rgba(0,0,0,0.5) 0%, transparent 50%);
        }

        /* íˆ´íŒ */
        #cursor-tooltip {
            position: fixed; z-index: 200; top: 0; left: 0; pointer-events: none; opacity: 0;
            transform: translate(20px, -20px); transition: opacity 0.2s ease, transform 0.2s ease;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        #cursor-tooltip.active { opacity: 1; transform: translate(25px, -25px); }
        .tooltip-line { width: 40px; height: 2px; background: #d4af37; margin-bottom: 5px; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); }
        #tooltip-kr { font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; color: #fff; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.8); letter-spacing: 0.1rem; line-height: 1; margin-bottom: 3px; }
        #tooltip-en { font-family: 'Cinzel', serif; font-size: 0.7rem; color: rgba(255, 255, 255, 0.7); letter-spacing: 0.2rem; text-transform: uppercase; }
        .tooltip-level { font-family: 'Cinzel', serif; font-size: 0.8rem; color: #ffd700; margin-top: 5px; } /* ë ˆë²¨ í‘œì‹œ ì¶”ê°€ */

        /* HUD */
        #hud-layer {
            position: fixed; top: 50px; left: 50px; z-index: 90; opacity: 0; transition: opacity 3s ease-in-out;
            font-family: 'Nanum Myeongjo', serif; color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; pointer-events: none;
        }
        #hud-line { width: 1px; height: 35px; background-color: rgba(255,255,255,0.4); margin-right: 15px; }
        #hud-text-group { display: flex; flex-direction: column; }
        #hud-date { font-size: 0.8rem; letter-spacing: 0.1rem; opacity: 0.6; margin-bottom: 2px;}
        #hud-time { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 400; line-height: 1; }

        .title-group { margin-bottom: 50px; color: white; text-shadow: 0 2px 15px rgba(0,0,0,0.5); }
        h1.main-title { font-family: 'Nanum Myeongjo', serif; font-size: 5rem; font-weight: 700; letter-spacing: 0.3rem; margin-bottom: 10px; line-height: 1.1; }
        h2.sub-title { font-family: 'Nanum Myeongjo', serif; font-size: 1.2rem; font-weight: 400; opacity: 0.8; letter-spacing: 0.4rem; margin-left: 5px; }

        .enter-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.4); color: white; font-family: 'Nanum Myeongjo', serif; font-size: 1.1rem; cursor: pointer; padding: 10px 30px; margin-left: 5px; position: relative; opacity: 0.8; transition: all 0.3s;
        }
        .enter-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); border-color: #fff; }

        /* --- ì„¬ ì»¨í…Œì´ë„ˆ --- */
        #islands-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; perspective: 1000px;
        }
        .scene-object {
            position: absolute; opacity: 0; transition: opacity 2s ease-in-out;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            will-change: transform; pointer-events: auto; cursor: pointer;
        }
        .scene-object.visible { opacity: 1; }

        .island img {
            width: 100%; height: auto;
            filter: drop-shadow(0 15px 25px rgba(0,0,0,0.6)) brightness(0.9);
            animation: float 6s ease-in-out infinite;
            /* ì´ë¯¸ì§€ êµì²´ì‹œ ë¶€ë“œëŸ½ê²Œ */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.4s ease, opacity 0.3s ease; 
        }
        .island:hover img {
            transform: scale(1.1) translateY(-10px);
            filter: drop-shadow(0 30px 50px rgba(255,255,255,0.2)) brightness(1.3);
            z-index: 50;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        /* ì„¬ ë°°ì¹˜ */
        #island-kindness { width: 90px; z-index: 20; top: 55%; left: 50%; transform: translate(-50%, 0); }
        #island-courage { width: 70px; z-index: 15; top: 50%; left: 38%; transform: translate(-50%, 0); }
        #island-diligence { width: 70px; z-index: 15; top: 50%; left: 62%; transform: translate(-50%, 0); }
        #island-wisdom { width: 50px; z-index: 10; top: 43%; left: 42%; transform: translate(-50%, 0); }
        #island-serenity { width: 50px; z-index: 10; top: 43%; left: 58%; transform: translate(-50%, 0); }

        /* ì¥ì‹ë¬¼ íŒŒí¸ */
        .shard {
            position: absolute;
            background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.05));
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
            backdrop-filter: blur(2px);
            z-index: 5; pointer-events: none; opacity: 0; transition: opacity 2s;
            animation: shard-spin 15s linear infinite alternate;
        }
        .shard.visible { opacity: 0.6; }
        @keyframes shard-spin { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(-20px) rotate(15deg); } }

        /* --- [ìˆ˜ì •] ê°œë°œììš© ì»¨íŠ¸ë¡¤ íŒ¨ë„: ì™¼ìª½ìœ¼ë¡œ ì´ë™ --- */
        #dev-panel {
            position: fixed; 
            bottom: 20px; 
            left: 20px; /* rightì—ì„œ leftë¡œ ë³€ê²½ */
            right: auto; /* ê¸°ì¡´ ìš°ì¸¡ ê³ ì • í•´ì œ */
            z-index: 9999;
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px);
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: white; 
            font-family: sans-serif; 
            width: 250px;
            display: none; 
        }
        #dev-panel h3 { font-size: 14px; margin-bottom: 10px; color: #ffd700; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .control-group { margin-bottom: 10px; display: flex; flex-direction: column; }
        .control-group label { font-size: 12px; margin-bottom: 2px; color: #ccc; display: flex; justify-content: space-between; }
        .control-group input[type="range"] { width: 100%; cursor: pointer; }
        .val-display { color: #fff; font-weight: bold; }

        #island-info-panel {
            position: fixed; top: 0; right: -400px; /* ì˜¤ë¥¸ìª½ ë°–ì— ìˆ¨ê¸°ê¸° */
            width: 380px; height: 100%;
            background: rgba(10, 12, 15, 0.95); /* ê²€ì€ìƒ‰ ë°°ê²½ */
            border-left: 1px solid rgba(212, 175, 55, 0.3);
            backdrop-filter: blur(10px);
            z-index: 5000;
            padding: 40px 30px;
            display: flex; flex-direction: column;
            transition: right 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        #island-info-panel.active { right: 0; }

        /* 2. íŒ¨ë„ ë‚´ë¶€ íƒ€ì´í¬ê·¸ë˜í”¼ */
        #panel-close-btn {
            position: absolute; top: 20px; right: 20px;
            background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; transition: color 0.3s;
        }
        #panel-close-btn:hover { color: #d4af37; }

        .panel-header { margin-bottom: 30px; text-align: left; }
        #panel-title-kr { font-family: 'Nanum Myeongjo', serif; font-size: 2.5rem; color: #fff; margin-bottom: 5px; }
        #panel-title-en { font-family: 'Cinzel', serif; font-size: 0.9rem; color: #d4af37; letter-spacing: 0.2rem; text-transform: uppercase; }

        .panel-stats { margin-bottom: 30px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-family: 'Cinzel', serif; font-size: 0.9rem; color: #ccc; }
        .stat-value { color: #ffd700; font-weight: bold; }
        .stat-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; }
        .stat-bar-fill { height: 100%; background: #d4af37; width: 0%; transition: width 1s ease; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }

        .panel-divider { width: 100%; height: 1px; background: linear-gradient(to right, transparent, rgba(212, 175, 55, 0.5), transparent); margin-bottom: 30px; }

        /* 3. ì¼ê¸° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .panel-history h4 { font-family: 'Nanum Myeongjo', serif; color: #aaa; font-size: 0.9rem; margin-bottom: 15px; }
        #panel-diary-list { list-style: none; overflow-y: auto; max-height: 60vh; padding-right: 5px; }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        #panel-diary-list::-webkit-scrollbar { width: 4px; }
        #panel-diary-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .diary-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 15px; margin-bottom: 10px;
            border-radius: 5px; transition: all 0.3s ease;
        }
        .diary-item:hover { background: rgba(255,255,255,0.07); border-color: rgba(212, 175, 55, 0.3); transform: translateX(5px); }
        .diary-date { font-family: 'Cinzel', serif; font-size: 0.7rem; color: #d4af37; margin-bottom: 5px; display: block; }
        .diary-snippet { font-family: 'Nanum Myeongjo', serif; font-size: 0.9rem; color: #ddd; line-height: 1.4; }


        /* --- [í•µì‹¬] ì›”ë“œ ì§‘ì¤‘ ëª¨ë“œ (World Focus Mode) --- */

        /* ì§‘ì¤‘ ëª¨ë“œ ì‹œ ê¸°ì¡´ UI íˆ¬ëª…í™” */
        .world-focused #hud-layer, 
        .world-focused #diary-open-btn,
        .world-focused #cursor-tooltip { 
            opacity: 0 !important; pointer-events: none; transition: opacity 0.5s ease; 
        }

        /* ì„ íƒë˜ì§€ ì•Šì€ ì„¬ë“¤: êµ¬ë¦„ì²˜ëŸ¼ í¼ì§€ë©° ì‚¬ë¼ì§ */
        .world-focused .island:not(.focused-island) {
            opacity: 0 !important;
            transform: translate(-50%, -100px) scale(1.5) !important; /* ìœ„ë¡œ ì˜¬ë¼ê°€ë©° ì»¤ì§ */
            filter: blur(10px);
            pointer-events: none;
            transition: all 1s ease;
        }

        .world-focused .island.focused-island {
            /* ê¸°ì¡´ 25%ëŠ” ë„ˆë¬´ ì™¼ìª½ì…ë‹ˆë‹¤. íŒ¨ë„(380px)ì„ ëº€ ê³µê°„ì˜ ì¤‘ì•™ì„ ê³„ì‚°í•©ë‹ˆë‹¤. */
            left: calc(50% - 190px) !important; 
            top: 50% !important;
            
            /* í™•ëŒ€ ë¹„ìœ¨ì„ 2.5ë°°ì—ì„œ 1.8ë°° ì •ë„ë¡œ ì‚´ì§ ì¤„ì—¬ì„œ ì•ˆì •ê°ì„ ì¤ë‹ˆë‹¤. */
            transform: translate(-50%, -50%) scale(1.8) !important; 
            
            z-index: 1000;
            filter: drop-shadow(0 0 50px rgba(255, 215, 0, 0.5)); /* í›„ê´‘ ë” ê°•í•˜ê²Œ */
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        }
        /* --- [NEW] ê²°ê³¼ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #result-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px);
            z-index: 6000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.8s ease;
        }
        #result-modal.active { opacity: 1; visibility: visible; }

        .result-window {
            width: 650px; padding: 60px;
            background: linear-gradient(145deg, rgba(25, 30, 35, 0.9), rgba(10, 12, 15, 1));
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 0 50px rgba(0,0,0,1);
            text-align: center; position: relative;
            transform: translateY(50px); transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #result-modal.active .result-window { transform: translateY(0); }

        .result-subtitle { font-family: 'Cinzel', serif; color: #d4af37; letter-spacing: 0.3rem; font-size: 0.8rem; }
        .result-title { font-family: 'Nanum Myeongjo', serif; font-size: 2.2rem; color: #fff; margin-top: 10px; margin-bottom: 40px; }

        .result-content {
            font-family: 'Nanum Myeongjo', serif; color: #ccc; line-height: 2; text-align: left;
            max-height: 300px; overflow-y: auto; padding-right: 15px; margin-bottom: 40px; font-size: 1.05rem;
        }

        /* í¬ì¸íŠ¸ ì•„ì´ì½˜ ìƒ‰ìƒ ì •ì˜ */
        #result-point-up-area { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }
        .point-badge {
            padding: 8px 15px; border-radius: 20px; font-family: 'Cinzel', serif; font-size: 0.85rem;
            font-weight: bold; animation: fadeInUp 0.5s ease forwards; opacity: 0;
        }

        /* ê° ë•ëª©ë³„ ì»¬ëŸ¬ (ìœ¤í˜¸ë‹˜ì´ ì›í•˜ì‹  ëŒ€ë¡œ!) */
        .badge-courage { border: 1px solid #ff6b6b; color: #ff6b6b; box-shadow: 0 0 10px rgba(255, 107, 107, 0.2); }
        .badge-wisdom { border: 1px solid #4db8ff; color: #4db8ff; box-shadow: 0 0 10px rgba(77, 184, 255, 0.2); }
        .badge-kindness { border: 1px solid #ff85a2; color: #ff85a2; box-shadow: 0 0 10px rgba(255, 133, 162, 0.2); }
        .badge-diligence { border: 1px solid #2ecc71; color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); }
        .badge-serenity { border: 1px solid #81ecec; color: #81ecec; box-shadow: 0 0 10px rgba(129, 236, 236, 0.2); }

        #result-close-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff;
            padding: 12px 40px; font-family: 'Nanum Myeongjo', serif; cursor: pointer; transition: 0.3s;
        }
        #result-close-btn:hover { background: #fff; color: #000; border-color: #fff; }

        /* 1. ì—ë„ˆì§€ êµ¬ìŠ¬ (ë” ê°•ë ¥í•œ ë°œê´‘ê³¼ ê¼¬ë¦¬ íš¨ê³¼) */
        .energy-orb {
            position: fixed;
            width: 30px; height: 30px; /* í¬ê¸° ì•½ê°„ í‚¤ì›€ */
            background: radial-gradient(circle at 30% 30%, #fff, var(--orb-color));
            border-radius: 50%;
            z-index: 7000; pointer-events: none;
            /* í•µì‹¬: ë‹¤ì¤‘ ê·¸ë¦¼ìë¡œ ë¹› ë²ˆì§ + ê¼¬ë¦¬ íš¨ê³¼ ì—°ì¶œ */
            box-shadow: 
                0 0 20px var(--orb-color),
                0 0 40px var(--orb-color),
                0 0 80px var(--orb-color);
            opacity: 0; transform: scale(0); /* ì‹œì‘ ì „ ìˆ¨ê¹€ */
            will-change: transform, left, top; /* ì„±ëŠ¥ ìµœì í™” */
        }

        /* 2. êµ¬ìŠ¬ ì´ë™ ì• ë‹ˆë©”ì´ì…˜ (ì§ì„  -> ê³¡ì„  ëŠë‚Œì˜ ê°€ê°ì†) */
        .energy-orb.flying {
            opacity: 1; transform: scale(1);
            /* í•µì‹¬ ë² ì§€ì— ê³¡ì„ : ì²˜ìŒì—” í­ë°œì ìœ¼ë¡œ ë¹ ë¥´ë‹¤ê°€ ì¤‘ê°„ì— ì‚´ì§ ëŠë ¤ì§€ê³ ,
            ë„ì°© ì§ì „ì— ë‹¤ì‹œ ë¹ ë¥´ê²Œ ê½‚íˆëŠ” ëŠë‚Œ (ë¡œì¼“ ë°œì‚¬ ëŠë‚Œ)
            */
            transition: 
                left 1.2s cubic-bezier(0.25, 0.1, 0.25, 1.2),
                top 1.2s cubic-bezier(0.25, 0.1, 0.25, 1.2),
                transform 0.3s ease-out,
                opacity 0.3s ease-in;
        }

        .impact-ripple {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px; /* ì‘ê²Œ ì‹œì‘ */
            border-radius: 50%;
            /* ì„ ì´ ì•„ë‹ˆë¼ ë©´ìœ¼ë¡œ í¼ì§€ëŠ” ë¹›ì˜ ëŠë‚Œ */
            background: radial-gradient(circle, var(--orb-color) 0%, transparent 70%);
            filter: blur(8px); /* ëª½í™˜ì ì¸ ëŠë‚Œì„ ìœ„í•´ ë¸”ëŸ¬ ì²˜ë¦¬ */
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.8;
            pointer-events: none; z-index: 999;
        }

        .impact-ripple.active {
            /* ë” ë¹ ë¥´ê³  ìš°ì•„í•˜ê²Œ í©ì–´ì§ */
            animation: rippleBurst 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes rippleBurst {
            to { transform: translate(-50%, -50%) scale(8); opacity: 0; }
        }

        /* 2. í¬ì¸íŠ¸ í…ìŠ¤íŠ¸ (í¬ê¸° ì¶•ì†Œ ë° ê°€ë…ì„± í–¥ìƒ) */
        .floating-point {
            position: absolute; top: -30px; left: 50%;
            transform: translateX(-50%) scale(0);
            color: #fff;
            font-family: 'Cinzel', serif; 
            font-weight: 800; 
            font-size: 0.7rem; /* 2rem -> 1.1remìœ¼ë¡œ ì¶•ì†Œ */
            letter-spacing: 0.1rem;
            pointer-events: none; z-index: 1002;
            text-shadow: 0 0 10px var(--orb-color), 0 2px 4px rgba(0,0,0,0.8);
            white-space: nowrap;
        }

        /* 4. ì„¬ ë°œê´‘ (ë” ê°•ë ¬í•˜ê²Œ) */
        @keyframes island-flash-strong {
            0% { filter: brightness(1) contrast(1); transform: scale(1); }
            30% { filter: brightness(2.5) contrast(1.2) drop-shadow(0 0 50px var(--orb-color)); transform: scale(1.05); }
            100% { filter: brightness(1) contrast(1); transform: scale(1); }
        }
        .flash-effect { animation: island-flash-strong 0.7s ease-out; }

        /* ì«€ë“í•œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        .floating-point.pop {
            animation: popUpElastic 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        /* ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        .floating-point.fade {
            transition: all 0.5s ease-out;
            opacity: 0; transform: translate(-50%, -50px) scale(0.8);
        }

        @keyframes popUpElastic {
            0% { opacity: 0; transform: translate(-50%, 20px) scale(0.5); }
            60% { opacity: 1; transform: translate(-50%, -10px) scale(1.3); } /* ì‚´ì§ ì˜¤ë²„í•´ì„œ ì»¤ì§ */
            100% { opacity: 1; transform: translate(-50%, 0) scale(1); } /* ì œìë¦¬ */
        }
        /* êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ */
        .google-btn {
            background: white; border: none; padding: 10px 20px;
            display: flex; align-items: center; gap: 10px;
            border-radius: 30px; cursor: pointer;
            font-family: 'Roboto', sans-serif; font-weight: 500; color: #555;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-left: 5px; opacity: 0.9;
        }
        .google-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,255,255,0.2); opacity: 1; }
        .google-btn img { width: 20px; height: 20px; }

        /* ë‹‰ë„¤ì„ ëª¨ë‹¬ */
        #nickname-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 8000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.5s;
        }
        #nickname-modal.active { opacity: 1; visibility: visible; }
        
        .nickname-window {
            background: #1a1a1a; border: 1px solid #d4af37;
            padding: 40px; text-align: center; width: 350px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        .nickname-window h3 { color: #d4af37; font-family: 'Nanum Myeongjo'; margin-bottom: 10px; font-size: 1.5rem; }
        .nickname-window p { color: #aaa; font-family: 'Nanum Myeongjo'; margin-bottom: 25px; font-size: 0.9rem; }
        
        #nickname-input {
            width: 100%; padding: 10px; background: rgba(255,255,255,0.1);
            border: none; border-bottom: 1px solid #555; color: white;
            text-align: center; font-family: 'Nanum Myeongjo'; font-size: 1.2rem;
            margin-bottom: 30px; outline: none; transition: border 0.3s;
        }
        #nickname-input:focus { border-bottom: 1px solid #d4af37; }
        
        #nickname-submit-btn {
            background: #d4af37; color: #000; border: none;
            padding: 10px 30px; font-family: 'Nanum Myeongjo'; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        #nickname-submit-btn:hover { background: #fff; }
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            letter-spacing: 0.1rem;
            padding: 10px 15px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            color: #fff;
            border-color: #fff;
            background: rgba(255, 255, 255, 0.05);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        /* --- ì¼ê¸° ìƒì„¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #diary-detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 7000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.4s ease;
        }
        #diary-detail-modal.active { opacity: 1; visibility: visible; }

        .detail-window {
            width: 600px; height: 80vh; 
            background: linear-gradient(145deg, rgba(25, 30, 35, 0.95), rgba(10, 12, 15, 0.98));
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 50px 40px; position: relative;
            display: flex; flex-direction: column;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            transform: scale(0.95); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #diary-detail-modal.active .detail-window { transform: scale(1); }

        .detail-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-bottom: 30px; text-align: center; }
        .detail-label { font-family: 'Cinzel', serif; font-size: 0.8rem; color: #666; letter-spacing: 0.2rem; }
        #detail-date { font-family: 'Cinzel', serif; font-size: 1.8rem; color: #d4af37; margin-top: 10px; }

        .detail-scroll-area { overflow-y: auto; padding-right: 10px; flex: 1; }
        .detail-scroll-area::-webkit-scrollbar { width: 4px; }
        .detail-scroll-area::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .detail-section { margin-bottom: 40px; }
        .section-title { font-family: 'Nanum Myeongjo', serif; font-size: 0.9rem; color: #888; margin-bottom: 10px; border-left: 2px solid #555; padding-left: 10px; }
        
        .detail-text { font-family: 'Nanum Myeongjo', serif; font-size: 1.05rem; color: #ddd; line-height: 1.8; white-space: pre-wrap; }
        
        .ai-section { background: rgba(212, 175, 55, 0.05); padding: 20px; border-radius: 5px; border: 1px solid rgba(212, 175, 55, 0.1); }
        .ai-text { color: #f0e6d2; font-style: italic; }

        .stats-container { display: flex; gap: 10px; flex-wrap: wrap; }
        /* --- [ìˆ˜ì •ë¨] í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ --- */
        #menu-toggle-btn {
            position: fixed; top: 30px; right: 40px; z-index: 9000;
            background: transparent; border: none; cursor: pointer;
            width: 35px; height: 25px; /* í¬ê¸° ì•½ê°„ ì¡°ì • */
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: flex-end;
            padding: 0; transition: transform 0.3s ease;
        }

        .menu-line {
            display: block; height: 2px; background-color: rgba(255, 255, 255, 0.8);
            border-radius: 2px; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* ì«€ë“í•œ ì›€ì§ì„ */
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        /* ë‹«í˜€ìˆì„ ë•Œ: ê°ê°ì ì¸ ë¹„ëŒ€ì¹­ ê¸¸ì´ */
        .menu-line:nth-child(1) { width: 100%; }
        .menu-line:nth-child(2) { width: 70%; }
        .menu-line:nth-child(3) { width: 40%; }

        /* í˜¸ë²„ ì‹œ: ê¸ˆìƒ‰ìœ¼ë¡œ ë¹›ë‚˜ë©° ê½‰ ì°¸ */
        #menu-toggle-btn:hover .menu-line {
            width: 100% !important; 
            background-color: #d4af37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
        }
        #menu-toggle-btn:hover { transform: scale(1.1); }

        /* [í•µì‹¬ ìˆ˜ì •] ì—´ë ¸ì„ ë•Œ (Xì): ê¸¸ì´ë¥¼ 100%ë¡œ ê°•ì œ í†µì¼í•˜ì—¬ ëŒ€ì¹­ ë§ì¶¤ */
        #menu-toggle-btn.open .menu-line { width: 100% !important; background-color: #d4af37; }
        
        /* ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ ì •í™•íˆ êµì°¨í•˜ë„ë¡ ì¢Œí‘œ ìˆ˜ì • */
        #menu-toggle-btn.open .menu-line:nth-child(1) { transform: translateY(11px) rotate(45deg); }
        #menu-toggle-btn.open .menu-line:nth-child(2) { opacity: 0; transform: translateX(-20px); } /* ê°€ìš´ë°ëŠ” íœ™ ë‚ ì•„ê° */
        #menu-toggle-btn.open .menu-line:nth-child(3) { transform: translateY(-12px) rotate(-45deg); }


        /* --- [ìˆ˜ì •ë¨] ë©”ì¸ ì‚¬ì´ë“œë°” --- */
        #main-menu-sidebar {
            position: fixed; top: 0; right: 0; width: 400px; /* ë„ˆë¹„ë¥¼ ì¢€ ë” ë„“í˜€ì„œ ê·¸ë¼ë°ì´ì…˜ ì—¬ìœ  í™•ë³´ */
            height: 100%; z-index: 8500;
            padding: 120px 50px; display: flex; flex-direction: column;
            
            /* [í•µì‹¬ ìˆ˜ì •] ê·¸ë¼ë°ì´ì…˜: ì™¼ìª½(íˆ¬ëª…) -> ì˜¤ë¥¸ìª½(ì§„í•œ ê²€ì •) */
            /* backdrop-filterëŠ” ì œê±° (íˆ¬ëª… ê·¸ë¼ë°ì´ì…˜ê³¼ ê²¹ì¹˜ë©´ ì§€ì €ë¶„í•´ ë³´ì¼ ìˆ˜ ìˆìŒ) */
            background: linear-gradient(to right, transparent 0%, rgba(5, 7, 10, 0.8) 30%, #05070a 100%);
            
            transform: translateX(100%); /* í™”ë©´ ë°–ìœ¼ë¡œ ìˆ¨ê¹€ */
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s ease;
            
            /* ë‹«í˜€ìˆì„ ë•ŒëŠ” ê·¸ë¦¼ì ì œê±° (ì”ìƒ í•´ê²°) */
            box-shadow: none;
            opacity: 0; pointer-events: none; /* ë‹«í˜€ìˆì„ ë•Œ í´ë¦­ ë°©ì§€ */
        }

        /* --- [ìˆ˜ì •ë¨] ë©”ì¸ ì‚¬ì´ë“œë°” --- */
        #main-menu-sidebar {
            position: fixed; top: 0; right: 0; width: 500px; /* ë„ˆë¹„ë¥¼ ë” ë„“ê²Œ ì¡ì•„ì„œ ê·¸ë¼ë°ì´ì…˜ êµ¬ê°„ í™•ë³´ */
            height: 100%; z-index: 8500;
            padding: 120px 60px 120px 100px; /* ì™¼ìª½ íŒ¨ë”©ì„ ëŠ˜ë ¤ì„œ ë‚´ìš©ì€ ì–´ë‘ìš´ ìª½ì— ë°°ì¹˜ */
            display: flex; flex-direction: column;
            
            /* [í•µì‹¬ ìˆ˜ì • 1] ì™¼ìª½ í…Œë‘ë¦¬ ì œê±° (ì´ê²Œ ìˆìœ¼ë©´ ê³µì¤‘ì— ì„ ë§Œ ë– ë‹¤ë‹˜) */
            border-left: none;

            /* [í•µì‹¬ ìˆ˜ì • 2] ë¶€ë“œëŸ¬ìš´ ê·¸ë¼ë°ì´ì…˜ (íƒí•´ì§€ì§€ ì•Šê²Œ rgbaê°’ í†µì¼) */
            /* ì™¼ìª½(0%)ì€ ì™„ì „ íˆ¬ëª… -> 30% ì§€ì ë¶€í„° ì„œì„œíˆ ì–´ë‘ì›Œì§ -> 70%ë¶€í„°ëŠ” ê±°ì˜ ë¶ˆíˆ¬ëª… */
            background: linear-gradient(to right, 
                rgba(5, 7, 10, 0) 0%, 
                rgba(5, 7, 10, 0.4) 30%, 
                rgba(5, 7, 10, 0.95) 70%, 
                rgba(5, 7, 10, 1) 100%
            );
            
            transform: translateX(100%); /* í‰ì†Œì—” ìˆ¨ê¹€ */
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s ease;
            
            box-shadow: none; /* ë‹«í˜€ìˆì„ ë•Œ ê·¸ë¦¼ì ì œê±° */
            opacity: 0; pointer-events: none;
        }

        /* ì—´ë ¸ì„ ë•Œ */
        #main-menu-sidebar.active { 
            transform: translateX(0); 
            opacity: 1; 
            pointer-events: auto;
            /* ì—´ë ¸ì„ ë•Œë„ ê·¸ë¦¼ìëŠ” ì œê±°í•˜ê±°ë‚˜ ì•„ì£¼ ì€ì€í•˜ê²Œ (ê·¸ë¼ë°ì´ì…˜ì´ ê·¸ë¦¼ì ì—­í•  í•¨) */
            box-shadow: none; 
        }

        .menu-header { margin-bottom: 60px; text-align: right; }
        .menu-header h2 { font-family: 'Cinzel', serif; color: #fff; font-size: 1.8rem; letter-spacing: 0.3rem; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .menu-underline { width: 100%; height: 1px; background: linear-gradient(to left, #d4af37, transparent); margin-top: 15px; }

        .menu-list { list-style: none; text-align: right; margin-right: 10px; }
        .menu-list li { margin-bottom: 30px; transform: translateX(50px); opacity: 0; transition: all 0.5s ease; }
        
        /* ìˆœì°¨ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        #main-menu-sidebar.active .menu-list li { transform: translateX(0); opacity: 1; }
        #main-menu-sidebar.active .menu-list li:nth-child(1) { transition-delay: 0.2s; }
        #main-menu-sidebar.active .menu-list li:nth-child(2) { transition-delay: 0.3s; }
        #main-menu-sidebar.active .menu-list li:nth-child(3) { transition-delay: 0.4s; }

        .menu-list a {
            color: #888; text-decoration: none; font-family: 'Nanum Myeongjo', serif; font-size: 1.2rem;
            transition: color 0.3s, transform 0.3s; display: inline-block;
        }
        .menu-list a:hover { 
            color: #d4af37; 
            transform: translateX(-10px); /* í˜¸ë²„ ì‹œ ì™¼ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™ */
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6); 
        }

        .menu-footer { margin-top: auto; text-align: right; opacity: 0.3; padding-right: 10px;}

        body.world-focused #menu-toggle-btn {
            opacity: 0;
            pointer-events: none; /* ì•ˆ ë³´ì¼ ë•Œ í´ë¦­ ì•ˆ ë˜ê²Œ ë§‰ìŒ (í•„ìˆ˜!) */
            transform: scale(0.8) rotate(90deg); /* ì‚´ì§ ì‘ì•„ì§€ê³  ëŒë©´ì„œ ì‚¬ë¼ì§€ëŠ” ì—°ì¶œ */
            transition: all 0.5s ease;
        }
        
        /* ë‹¤ì‹œ ë‚˜íƒ€ë‚  ë•Œì˜ íŠ¸ëœì§€ì…˜ë„ ë¶€ë“œëŸ½ê²Œ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° ë°©ì§€ìš©) */
        #menu-toggle-btn {
            transition: opacity 0.5s ease, transform 0.3s ease;
        }

        /* --- í”„ë¡œí•„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #profile-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 9500; /* ë©”ë‰´(8500)ë³´ë‹¤ ë†’ì•„ì•¼ í•¨ */
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.4s ease;
        }
        #profile-modal.active { opacity: 1; visibility: visible; }

        .profile-window {
            width: 450px; background: linear-gradient(135deg, #1a1c20 0%, #0f1012 100%);
            border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 2px;
            padding: 50px 40px; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transform: translateY(20px); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #profile-modal.active .profile-window { transform: translateY(0); }

        /* ìƒë‹¨ ì •ë³´ */
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .profile-icon {
            width: 70px; height: 70px; background: rgba(255,255,255,0.05);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 2rem; border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .profile-role { font-family: 'Cinzel', serif; color: #d4af37; font-size: 0.7rem; letter-spacing: 0.2rem; display: block; margin-bottom: 5px; }
        #profile-nickname { font-family: 'Nanum Myeongjo', serif; color: #fff; font-size: 2rem; margin: 0; line-height: 1; }
        .join-date { font-family: 'Cinzel', serif; color: #666; font-size: 0.8rem; margin-top: 8px; }

        .profile-divider { width: 100%; height: 1px; background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent); margin-bottom: 30px; }

        /* í†µê³„ ì˜ì—­ */
        .stats-title { font-family: 'Nanum Myeongjo', serif; color: #ddd; font-size: 1.1rem; margin-bottom: 5px; }
        .stats-desc { font-family: 'Nanum Myeongjo', serif; color: #777; font-size: 0.8rem; margin-bottom: 25px; }

        .stat-bar-group { margin-bottom: 15px; }
        .stat-label-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-family: 'Cinzel', serif; font-size: 0.8rem; color: #aaa; }
        .stat-track { width: 100%; height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; }
        .stat-fill { height: 100%; width: 0%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); border-radius: 3px; position: relative; }
        
        /* ë°”ì—ì„œ ë¹›ë‚˜ëŠ” íš¨ê³¼ */
        .stat-fill::after {
            content: ''; position: absolute; top: 0; right: 0; width: 5px; height: 100%;
            background: rgba(255,255,255,0.8); box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        /* ğŸ“± [NEW] ëª¨ë°”ì¼ ì „ìš© ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ (í™”ë©´ í­ 768px ì´í•˜ì¼ ë•Œ ì ìš©) */
        @media screen and (max-width: 768px) {
            
            /* 1. ë©”ì¸ íƒ€ì´í‹€ í¬ê¸° ì¶•ì†Œ */
            .main-title { font-size: 3rem; letter-spacing: 0.3rem; }
            .sub-title { font-size: 0.8rem; letter-spacing: 0.2rem; margin-bottom: 30px; }
            .main-content-box { margin-bottom: 15vh; }

            /* 2. ëª¨ë“  ëª¨ë‹¬ ì°½(ì¼ê¸°, ê²°ê³¼, í”„ë¡œí•„, ìƒì„¸) ë„ˆë¹„ ìµœì í™” */
            .diary-window, .result-window, .detail-window, .profile-window {
                width: 90% !important; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
                max-height: 85vh;      /* ìœ„ì•„ë˜ ì—¬ë°± í™•ë³´ */
                padding: 30px 20px;    /* ë‚´ë¶€ ì—¬ë°± ì¤„ì´ê¸° */
            }
            
            /* 3. í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ë†’ì´ ì¡°ì ˆ */
            #diary-textarea { height: 180px; }

            /* 4. ë©”ì¸ ë©”ë‰´ ì‚¬ì´ë“œë°” (í™”ë©´ ì „ì²´ ë®ê¸°) */
            #main-menu-sidebar { 
                width: 100%; 
                padding: 100px 30px; /* íŒ¨ë”© ì¡°ì • */
                background: linear-gradient(to right, rgba(5,7,10,0.9), #05070a); /* ëª¨ë°”ì¼ì€ ê°€ë…ì„± ìœ„í•´ ì¢€ ë” ì§„í•˜ê²Œ */
            }

            /* 5. ì„¬ ì •ë³´ íŒ¨ë„ (í™”ë©´ ì „ì²´ ë®ê¸°) */
            #island-info-panel { 
                width: 100%; 
                right: -100%; /* ìˆ¨ê²¨ì§„ ìœ„ì¹˜ ìˆ˜ì • */
                border-left: none; /* ëª¨ë°”ì¼ì€ ì „ì²´í™”ë©´ì´ë¼ ê²½ê³„ì„  ë¶ˆí•„ìš” */
            }
            #island-info-panel.active { right: 0; }

            /* 6. ë²„íŠ¼ë“¤ ìœ„ì¹˜ ë° í¬ê¸° ì¡°ì • */
            #menu-toggle-btn { top: 20px; right: 20px; transform: scale(0.9); }
            #diary-open-btn { bottom: 30px; right: 20px; font-size: 0.9rem; }
            .minimal-logout-btn { bottom: 20px; font-size: 0.6rem; }

            /* 7. ëª¨ë°”ì¼ì—ì„œ ë„ˆë¬´ í° ê¸€ì”¨ë“¤ ì¡°ì • */
            #tooltip-kr { font-size: 1.2rem; }
            .panel-header h2 { font-size: 2rem; }
            #profile-nickname { font-size: 1.5rem; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <audio id="sfx-hover" src="SFX/hover.mp3"></audio>
    <audio id="sfx-click" src="SFX/click.mp3"></audio>
    <audio id="sfx-clear" src="SFX/cloud_clear.mp3"></audio>
    <audio id="sfx-ambiance" src="SFX/ambiance.mp3" loop></audio>
    <audio id="sfx-result" src="SFX/result.mp3"></audio>
    <audio id="sfx-hit" src="SFX/hit.mp3"></audio>

    <div id="dev-panel">
        <h3>ğŸŒ± ì •ì›ì‚¬ ëª¨ë“œ (Point Controller)</h3>
        <div class="control-group">
            <label>ìš©ê¸° (Courage) <span id="val-courage" class="val-display">0</span></label>
            <input type="range" id="rng-courage" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>ì§€í˜œ (Wisdom) <span id="val-wisdom" class="val-display">0</span></label>
            <input type="range" id="rng-wisdom" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>ì¹œì ˆ (Kindness) <span id="val-kindness" class="val-display">0</span></label>
            <input type="range" id="rng-kindness" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>ì„±ì‹¤ (Diligence) <span id="val-diligence" class="val-display">0</span></label>
            <input type="range" id="rng-diligence" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>í‰ì˜¨ (Serenity) <span id="val-serenity" class="val-display">0</span></label>
            <input type="range" id="rng-serenity" min="0" max="160" value="0">
        </div>
        <div style="font-size: 10px; color:#888; margin-top:5px;">* ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ ì„¬ì„ ì§„í™”ì‹œí‚¤ì„¸ìš”.</div>
    </div>

    <div id="cursor-tooltip">
        <div class="tooltip-line"></div>
        <div id="tooltip-kr">í•œê¸€ ì´ë¦„</div>
        <div id="tooltip-en">English Name</div>
        <div class="tooltip-level" id="tooltip-lvl">Lv. 1</div>
    </div>

    <div id="hud-layer">
        <div id="hud-line"></div>
        <div id="hud-text-group">
            <div id="hud-date">...</div>
            <div id="hud-time">00:00</div>
        </div>
    </div>

    <div id="world-container">
        <div id="sky-bg"></div>
        <div id="stars-container"></div>
        <div id="cloud-floor"></div>
        <canvas id="particle-canvas"></canvas>

        <div id="islands-container">
            <div id="island-wisdom" class="scene-object island" 
                 data-depth="0.02" data-base-x="42" data-base-y="43" 
                 data-name-en="Wisdom" data-name-kr="ì§€í˜œ" data-type="wisdom" data-points="0">
                <img id="img-wisdom" src="images/island_wisdom_1.png" alt="ì§€í˜œ">
            </div>

            <div id="island-serenity" class="scene-object island" 
                 data-depth="0.02" data-base-x="58" data-base-y="43" 
                 data-name-en="Serenity" data-name-kr="í‰ì˜¨" data-type="serenity" data-points="0">
                <img id="img-serenity" src="images/island_serenity_1.png" alt="í‰ì˜¨">
            </div>

            <div id="island-courage" class="scene-object island" 
                 data-depth="0.04" data-base-x="38" data-base-y="50" 
                 data-name-en="Courage" data-name-kr="ìš©ê¸°" data-type="courage" data-points="0">
                <img id="img-courage" src="images/island_courage_1.png" alt="ìš©ê¸°">
            </div>

            <div id="island-diligence" class="scene-object island" 
                 data-depth="0.04" data-base-x="62" data-base-y="50" 
                 data-name-en="Diligence" data-name-kr="ì„±ì‹¤" data-type="diligence" data-points="0">
                <img id="img-diligence" src="images/island_diligence_1.png" alt="ì„±ì‹¤">
            </div>

            <div id="island-kindness" class="scene-object island" 
                 data-depth="0.07" data-base-x="50" data-base-y="55" 
                 data-name-en="Kindness" data-name-kr="ì¹œì ˆ" data-type="kindness" data-points="0">
                <img id="img-kindness" src="images/island_kindness_1.png" alt="ì¹œì ˆ">
            </div>
        </div>
    </div>

    <div id="ui-layer">
        <div class="title-group">
            <h1 class="main-title">ê¸€ìˆ²</h1>
            <h2 class="sub-title">ê¸€ì´ ì •ì›ì„ ë§Œë“¤ë‹¤</h2>
        </div>
        
        <button id="google-login-btn" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
            <span>Googleë¡œ ì‹œì‘í•˜ê¸°</span>
        </button>

        <button id="enter-btn" class="enter-btn" style="display: none;">ì •ì› ë“¤ì–´ê°€ê¸°</button>
        
        <button id="logout-btn" class="logout-btn" style="display: none;">LOGOUT</button>
        
        <div id="user-greeting" style="color:white; margin-top:15px; font-family:'Nanum Myeongjo'; opacity:0;"></div>
    </div>

    <div id="nickname-modal">
        <div class="nickname-window">
            <h3>ì´ë¦„ ë“±ë¡</h3>
            <p>ì´ ì •ì›ì˜ ì£¼ì¸ì¸ ë‹¹ì‹ ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”? (ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ì£¼ì„¸ìš”, ë³€ê²½ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤)</p>
            <input type="text" id="nickname-input" placeholder="ìµœëŒ€ 8ê¸€ì" maxlength="8">
            <button id="nickname-submit-btn">ì •ì›ì‚¬ì—ê²Œ ì´ë¦„ ì•Œë ¤ì£¼ê¸°</button>
        </div>
    </div>

    <button id="menu-toggle-btn">
        <span class="menu-line"></span>
        <span class="menu-line"></span>
        <span class="menu-line"></span>
    </button>

    <aside id="main-menu-sidebar">
        <div class="menu-header">
            <h2>SYSTEM</h2>
            <div class="menu-underline"></div>
        </div>
        
        <ul class="menu-list">
            <li><a href="#">ë‚´ í”„ë¡œí•„ (Profile)</a></li>
            <li><a href="#">ì •ì› ì„¤ì • (Settings)</a></li>
            <li><a href="#">ë„ì›€ë§ (Help)</a></li>
            </ul>

        <div class="menu-footer">
            <span style="font-family: 'Cinzel'; font-size: 0.7rem; color: #555;">GEULSEUP v1.0</span>
        </div>
    </aside>
    
    <aside id="island-info-panel">
        <button id="panel-close-btn">âœ•</button>
        
        <div class="panel-header">
            <h2 id="panel-title-kr">ì§€í˜œì˜ ì •ì›</h2>
            <h3 id="panel-title-en">Garden of Wisdom</h3>
        </div>

        <div class="panel-stats">
            <div class="stat-row">
                <span class="stat-label">CURRENT LEVEL</span>
                <span class="stat-value" id="panel-lvl">Lv. 3</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">TOTAL POINTS</span>
                <span class="stat-value" id="panel-pts">450</span>
            </div>
            <div class="stat-bar-bg"><div id="panel-progress-bar" class="stat-bar-fill"></div></div>
        </div>

        <div class="panel-divider"></div>

        <div class="panel-history">
            <h4>ê¸°ë¡ëœ ì–‘ë¶„ (Diary Log)</h4>
            <ul id="panel-diary-list">
                </ul>
        </div>
    </aside>

    <button id="diary-open-btn">
        WRITE DIARY
        <div class="btn-line"></div>
    </button>

    <div id="diary-modal">
        <div class="diary-window">
            <span class="close-modal" id="diary-close-x">âœ•</span>
            <div class="diary-header">
                <div id="diary-date-display">2024. 05. 21. TUE</div>
            </div>
            
            <textarea id="diary-textarea" placeholder="ì˜¤ëŠ˜ì˜ ì¼ë“¤ì„ ê¸°ë¡í•˜ì„¸ìš”... (30ì ~ 200ì)"></textarea>
            
            <div class="char-counter" id="char-count-info">0 / 200</div>
            
            <button id="diary-submit" class="diary-submit-btn" disabled>ë‚˜ë¬´ ì‹¬ê¸° (ê¸°ë¡)</button>
        </div>
    </div>
    <div id="result-modal">
        <div class="result-window">
            <div class="result-header">
                <span class="result-subtitle">THE GARDENER'S INSIGHT</span>
                <h2 class="result-title">ì •ì›ì‚¬ì˜ ë‹µì¥</h2>
            </div>
            
            <div class="result-content" id="result-comment">
                </div>

            <div class="result-footer">
                <div id="result-point-up-area">
                    </div>
                <button id="result-close-btn">ì •ì›ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <div id="profile-modal">
        <div class="profile-window">
            <span class="close-modal" id="profile-close-x">âœ•</span>
            
            <div class="profile-header">
                <div class="profile-icon">ğŸ§™â€â™‚ï¸</div> <div class="profile-info">
                    <span class="profile-role">GARDEN MASTER</span>
                    <h2 id="profile-nickname">ì—¬í–‰ì</h2>
                    <p id="profile-join-date" class="join-date">Since 2024. 05. 21.</p>
                </div>
            </div>

            <div class="profile-divider"></div>

            <div class="profile-stats-area">
                <h3 class="stats-title">ì´ë²ˆ ë‹¬ì˜ ì„±ì¥ (Monthly Growth)</h3>
                <p class="stats-desc">ì´ë²ˆ ë‹¬, ë‹¹ì‹ ì˜ ë§ˆìŒì† ì •ì›ì—ì„œ ìë¼ë‚œ ê¸°ìš´ë“¤ì…ë‹ˆë‹¤.</p>
                
                <div id="monthly-stat-container">
                    </div>
            </div>
        </div>
    </div>

    <div id="diary-detail-modal">
        <div class="detail-window">
            <span class="close-modal" id="detail-close-x">âœ•</span>
            
            <div class="detail-header">
                <span class="detail-label">ARCHIVED MEMORY</span>
                <h2 id="detail-date">2024. 05. 21. TUE</h2>
            </div>

            <div class="detail-scroll-area">
                <div class="detail-section">
                    <div class="section-title">ë‚˜ì˜ ê¸°ë¡</div>
                    <p id="detail-content" class="detail-text">ì¼ê¸° ë‚´ìš©ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤...</p>
                </div>

                <div class="detail-section ai-section">
                    <div class="section-title">ì •ì›ì‚¬ì˜ ë‹µì¥ ğŸŒ¿</div>
                    <p id="detail-ai-reply" class="detail-text ai-text">ì •ì›ì‚¬ì˜ ë‹µë³€ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤...</p>
                </div>

                <div class="detail-section">
                    <div class="section-title">ì„±ì¥í•œ ê¸°ìš´</div>
                    <div id="detail-stats" class="stats-container">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        const worldContainer = document.getElementById('world-container');
        const uiLayer = document.getElementById('ui-layer');
        const enterBtn = document.getElementById('enter-btn');
        const islandElements = document.querySelectorAll('.island'); 
        const cloudFloor = document.getElementById('cloud-floor');
        const hudLayer = document.getElementById('hud-layer'); 
        const islandsContainer = document.getElementById('islands-container');
        const skyBg = document.getElementById('sky-bg');
        const starsContainer = document.getElementById('stars-container');
        const tooltip = document.getElementById('cursor-tooltip');
        const tooltipEn = document.getElementById('tooltip-en');
        const tooltipKr = document.getElementById('tooltip-kr');
        const tooltipLvl = document.getElementById('tooltip-lvl'); // ë ˆë²¨ íˆ´íŒ
        const devPanel = document.getElementById('dev-panel'); // ê°œë°œì íŒ¨ë„
        const detailModal = document.getElementById('diary-detail-modal');
        const detailCloseX = document.getElementById('detail-close-x');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const mainMenuSidebar = document.getElementById('main-menu-sidebar');
        const profileModal = document.getElementById('profile-modal');
        const profileCloseX = document.getElementById('profile-close-x');
        const profileLink = document.querySelector('.menu-list li:first-child a');
        const logoutBtn = document.getElementById('logout-btn');

        const audioHover = document.getElementById('sfx-hover');
        const audioClick = document.getElementById('sfx-click');
        const audioClear = document.getElementById('sfx-clear');
        const audioAmbiance = document.getElementById('sfx-ambiance');
        const hudDate = document.getElementById('hud-date');
        const hudTime = document.getElementById('hud-time');

        // --- ìš”ì†Œ ì„ íƒ ---
        const diaryOpenBtn = document.getElementById('diary-open-btn');
        const diaryModal = document.getElementById('diary-modal');
        const diaryCloseX = document.getElementById('diary-close-x');
        const diaryTextarea = document.getElementById('diary-textarea');
        const charCounter = document.getElementById('char-count-info');
        const diarySubmitBtn = document.getElementById('diary-submit');
        const diaryDateDisplay = document.getElementById('diary-date-display');

        const sidePanel = document.getElementById('island-info-panel');
        const panelCloseBtn = document.getElementById('panel-close-btn');
        const panelDiaryList = document.getElementById('panel-diary-list');
        const resultModal = document.getElementById('result-modal');
        const resultComment = document.getElementById('result-comment');
        const resultPointUpArea = document.getElementById('result-point-up-area');
        const resultCloseBtn = document.getElementById('result-close-btn');
        const audioResult = document.getElementById('sfx-result');
        const audioHit = document.getElementById('sfx-hit');
        let cachedDiaries = []; // ğŸ§º ì¼ê¸° ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë‹´ì•„ë‘˜ ë°”êµ¬ë‹ˆ

        profileLink.addEventListener('click', (e) => {
            e.preventDefault(); // # ì´ë™ ë°©ì§€
            audioClick.play();
            openProfileModal();
        });

        // 2. Firebase ì„¤ì • (ìœ¤í˜¸ë‹˜ì˜ ì„¤ì •ê°’ ê·¸ëŒ€ë¡œ ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyANMznf6jeSLcLBPMZz7UrU7yf5YR3y18s",
            authDomain: "geulsup.firebaseapp.com",
            projectId: "geulsup",
            storageBucket: "geulsup.firebasestorage.app",
            messagingSenderId: "16178537421",
            appId: "1:16178537421:web:f6cf9fbe1317809d721a84",
            measurementId: "G-TQ6Z3SQKPM"
        };

        // 3. [ìˆ˜ì •] Firebase ì´ˆê¸°í™” (compat ë°©ì‹)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ìš”ì†Œ ì„ íƒ ---
        const googleLoginBtn = document.getElementById('google-login-btn');
        const enterButton = document.getElementById('enter-btn'); // ë³€ìˆ˜ëª… ì£¼ì˜ (ìœ„ html idë‘ ë§ì¶¤)
        const userGreeting = document.getElementById('user-greeting');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const nicknameSubmitBtn = document.getElementById('nickname-submit-btn');

        let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´

        // --- 3. êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ---
        googleLoginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log("ë¡œê·¸ì¸ ì„±ê³µ:", result.user);
                    // ë¡œê·¸ì¸ ìƒíƒœ ë³€í™”ëŠ” ì•„ë˜ onAuthStateChangedì—ì„œ ì²˜ë¦¬
                })
                .catch((error) => {
                    console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                    alert("ë¡œê·¸ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        });

        menuToggleBtn.addEventListener('click', () => {
            audioClick.play();
            
            // ë§Œì•½ 'ì„¬ ì •ë³´ íŒ¨ë„(ì§‘ì¤‘ ëª¨ë“œ)'ì´ ì—´ë ¤ìˆë‹¤ë©´? -> ë‹«ì•„ë²„ë¦¬ê¸°
            if (document.body.classList.contains('world-focused')) {
                closeFocusMode(); 
            }

            // ë©”ë‰´ í† ê¸€ (active í´ë˜ìŠ¤ ìŠ¤ìœ„ì¹­)
            menuToggleBtn.classList.toggle('open');
            mainMenuSidebar.classList.toggle('active');
        });

        // ë²„íŠ¼ í˜¸ë²„ ì‹œ íš¨ê³¼ìŒ
        menuToggleBtn.addEventListener('mouseenter', () => {
            const sound = audioHover.cloneNode();
            sound.volume = 0.05;
            sound.play().catch(()=>{});
        });

        async function loadAllDiaries(uid) {
            try {
                const snapshot = await db.collection('users').doc(uid).collection('diaries')
                    .orderBy('timestamp', 'desc') // ìµœì‹ ìˆœ ì •ë ¬
                    .get();
                
                cachedDiaries = []; // ì´ˆê¸°í™”
                snapshot.forEach(doc => {
                    cachedDiaries.push(doc.data()); // ë°”êµ¬ë‹ˆì— ë‹´ê¸°
                });
                console.log("ì¼ê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", cachedDiaries.length, "ê°œ");
            } catch (err) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
            }
        }

        function openDetailModal(data, dateStr) {
            document.getElementById('detail-date').innerText = dateStr;
            document.getElementById('detail-content').innerText = data.content;
            document.getElementById('detail-ai-reply').innerText = data.ai_reply || "ì •ì›ì‚¬ì˜ ë‹µì¥ì´ ì—†ìŠµë‹ˆë‹¤.";
            
            // ìŠ¤íƒ¯ í‘œì‹œ
            const statsContainer = document.getElementById('detail-stats');
            statsContainer.innerHTML = '';
            
            if (data.stat_increase) {
                for (const [key, value] of Object.entries(data.stat_increase)) {
                    if (value > 0) {
                        const badge = document.createElement('div');
                        badge.classList.add('point-badge', `badge-${key}`);
                        badge.innerText = `${key.toUpperCase()} +${value}`;
                        statsContainer.appendChild(badge);
                    }
                }
            }

            detailModal.classList.add('active');
        }

        // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        detailCloseX.addEventListener('click', () => {
            detailModal.classList.remove('active');
        });

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) detailModal.classList.remove('active');
        });

        function openProfileModal() {
            // 1. ìœ ì € ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
            if (currentUser) {
                // ë‹‰ë„¤ì„ì€ userGreetingì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ DBì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ DB ë¡œë“œëœ ê°’ì„ ì“´ë‹¤ê³  ê°€ì • (ì—†ìœ¼ë©´ Auth ì •ë³´)
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if(doc.exists) {
                        document.getElementById('profile-nickname').innerText = doc.data().nickname;
                        
                        // ê°€ì…ì¼ (timestamp -> Date ë³€í™˜)
                        const joinDate = doc.data().createdAt ? doc.data().createdAt.toDate() : new Date();
                        const year = joinDate.getFullYear();
                        const month = String(joinDate.getMonth() + 1).padStart(2, '0');
                        const day = String(joinDate.getDate()).padStart(2, '0');
                        document.getElementById('profile-join-date').innerText = `Since ${year}. ${month}. ${day}.`;
                    }
                });
            }

            // 2. [í•µì‹¬] ì´ë²ˆ ë‹¬ ìŠ¤íƒ¯ ê³„ì‚°í•˜ê¸°
            const now = new Date();
            const thisMonth = now.getMonth(); // 0 ~ 11
            const thisYear = now.getFullYear();
            
            // ì´ë²ˆ ë‹¬ì— í•´ë‹¹í•˜ëŠ” ìŠ¤íƒ¯ ëˆ„ì  ë³€ìˆ˜
            let monthlyStats = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
            let maxVal = 1; // ê·¸ë˜í”„ ë¹„ìœ¨ ê³„ì‚°ìš© ìµœëŒ€ê°’ (ìµœì†Œ 1)

            // ìºì‹œëœ ì¼ê¸°ì¥ì—ì„œ ì´ë²ˆ ë‹¬ ê²ƒë§Œ í•„í„°ë§
            cachedDiaries.forEach(diary => {
                let dDate;
                if (diary.timestamp && typeof diary.timestamp.toDate === 'function') {
                    dDate = diary.timestamp.toDate();
                } else {
                    dDate = new Date(); // fallback
                }

                if (dDate.getMonth() === thisMonth && dDate.getFullYear() === thisYear) {
                    if (diary.stat_increase) {
                        for (const [key, val] of Object.entries(diary.stat_increase)) {
                            if (monthlyStats[key] !== undefined) {
                                monthlyStats[key] += val;
                            }
                        }
                    }
                }
            });

            // ìµœëŒ€ê°’ ì°¾ê¸° (ê·¸ë˜í”„ ê½‰ ì°¨ê²Œ ë³´ì´ê¸° ìœ„í•´)
            maxVal = Math.max(...Object.values(monthlyStats), 10); // ì ì–´ë„ 10ì ì€ ë˜ì–´ì•¼ ê½‰ ì°¸

            // 3. ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            const container = document.getElementById('monthly-stat-container');
            container.innerHTML = '';

            const virtueNames = { 
                courage: 'ìš©ê¸° (Courage)', wisdom: 'ì§€í˜œ (Wisdom)', 
                kindness: 'ì¹œì ˆ (Kindness)', diligence: 'ì„±ì‹¤ (Diligence)', serenity: 'í‰ì˜¨ (Serenity)' 
            };

            for (const [key, val] of Object.entries(monthlyStats)) {
                const percent = Math.min((val / maxVal) * 100, 100); // 100% ë„˜ì§€ ì•Šê²Œ
                const color = virtueColors[key]; // ê¸°ì¡´ì— ì •ì˜í•œ ìƒ‰ìƒ í™œìš©

                const div = document.createElement('div');
                div.className = 'stat-bar-group';
                div.innerHTML = `
                    <div class="stat-label-row">
                        <span>${virtueNames[key]}</span>
                        <span style="color:${color}">${val} pts</span>
                    </div>
                    <div class="stat-track">
                        <div class="stat-fill" style="width: 0%; background-color: ${color}; box-shadow: 0 0 10px ${color};"></div>
                    </div>
                `;
                container.appendChild(div);

                // ì• ë‹ˆë©”ì´ì…˜ (ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì°¨ì˜¤ë¦„)
                setTimeout(() => {
                    div.querySelector('.stat-fill').style.width = `${percent}%`;
                }, 100);
            }

            profileModal.classList.add('active');
        }

        // ë‹«ê¸° ë¡œì§
        profileCloseX.addEventListener('click', () => profileModal.classList.remove('active'));
        profileModal.addEventListener('click', (e) => {
            if(e.target === profileModal) profileModal.classList.remove('active');
        });

        // --- 4. ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ (ìˆ˜ì •ë¨) ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                googleLoginBtn.style.display = 'none';
                logoutBtn.style.display = 'block'; // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ

                // ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    showEnterButton(userData.nickname);
                    
                    // [NEW] 1. ìœ ì €ì˜ ëˆ„ì  ìŠ¤íƒ¯(total_points)ì„ ê°€ì ¸ì™€ì„œ í™”ë©´ì— ë°˜ì˜í•˜ê¸°
                    if (userData.total_points) {
                        // DBì— ìˆëŠ” ìŠ¤íƒ¯ì„ ë¡œì»¬ ë³€ìˆ˜(currentPoints)ì— ë®ì–´ì”Œì›€
                        currentPoints = { ...currentPoints, ...userData.total_points };
                        
                        // ê° ë•ëª©ë³„ë¡œ ì„¬ ì´ë¯¸ì§€ ë° ìŠ¬ë¼ì´ë” ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
                        virtues.forEach(v => {
                            const p = currentPoints[v] || 0;
                            // ê°œë°œì ëª¨ë“œ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
                            const slider = document.getElementById(`rng-${v}`);
                            const display = document.getElementById(`val-${v}`);
                            if (slider) slider.value = p;
                            if (display) display.innerText = p;
                            
                            // [í•µì‹¬] ë¶ˆëŸ¬ì˜¨ ì ìˆ˜ë¡œ ì„¬ ì´ë¯¸ì§€ ê°±ì‹ !
                            updateIslandVisual(v, p); 
                        });
                    }

                    // 2. ì¼ê¸° ëª©ë¡ ë¯¸ë¦¬ ë¡œë“œ (ê¸°ì¡´ì— ë§Œë“  ê¸°ëŠ¥)
                    await loadAllDiaries(user.uid); 

                } else {
                    // ì‹ ê·œ ìœ ì €ì¼ ê²½ìš° ì´ë¦„ ì„¤ì • ì°½ ë„ìš°ê¸°
                    nicknameModal.classList.add('active');
                }
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ
                currentUser = null;
                googleLoginBtn.style.display = 'flex';
                enterButton.style.display = 'none';
                logoutBtn.style.display = 'none';
                userGreeting.style.opacity = '0';
                
                // ë°ì´í„° ì´ˆê¸°í™”
                cachedDiaries = [];
                currentPoints = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
            }
        });

        logoutBtn.addEventListener('click', () => {
            if (confirm("ì •ì›ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                auth.signOut().then(() => {
                    console.log("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
                    location.reload(); // ê¹”ë”í•˜ê²Œ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì„œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                }).catch((error) => {
                    console.error("ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:", error);
                });
            }
        });

        // --- 5. ë‹‰ë„¤ì„ ì œì¶œ ë¡œì§ ---
        nicknameSubmitBtn.addEventListener('click', async () => {
            const nickname = nicknameInput.value.trim();
            if (nickname.length < 1) {
                alert("ì´ë¦„ì„ í•œ ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // DBì— ìœ ì € ì •ë³´ ì €ì¥ (íšŒì›ê°€ì… ì™„ë£Œ)
            await db.collection('users').doc(currentUser.uid).set({
                nickname: nickname,
                email: currentUser.email,
                createdAt: new Date(),
                // ì´ˆê¸° í¬ì¸íŠ¸ ì„¤ì •
                points: { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 }
            });

            nicknameModal.classList.remove('active'); // ëª¨ë‹¬ ë‹«ê¸°
            showEnterButton(nickname); // ì…ì¥ ë²„íŠ¼ ë³´ì´ê¸°
        });

        // --- 6. ì…ì¥ ë²„íŠ¼ í™œì„±í™” í•¨ìˆ˜ ---
        function showEnterButton(nickname) {
            enterButton.style.display = 'block';
            enterButton.style.animation = 'fadeInUp 1s ease forwards';
            
            userGreeting.innerText = `í™˜ì˜í•©ë‹ˆë‹¤, ${nickname}ë‹˜.`;
            userGreeting.style.opacity = '1';
            userGreeting.style.transition = 'opacity 1s ease';
        }

        // ëˆ„ì  ì ìˆ˜ ìƒíƒœ ê´€ë¦¬
        let currentPoints = {
            courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0
        };

        let currentLastResult = null;

        const virtueColors = {
            courage: '#ff6b6b', wisdom: '#4db8ff', kindness: '#ff85a2',
            diligence: '#2ecc71', serenity: '#81ecec'
        };

        // ë”ë¯¸ ë°ì´í„° (ë‚˜ì¤‘ì—” ì‹¤ì œ ì¼ê¸° ë°ì´í„°ì™€ ì—°ë™)
        const islandData = {
            'wisdom': { 
                kr: 'ì§€í˜œì˜ ì •ì›', en: 'Garden of Wisdom', 
                logs: [
                    { date: '2024.05.20', text: 'ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¥¼ ë°°ì› ë‹¤. ì–´ë µì§€ë§Œ ì›ë¦¬ë¥¼ ê¹¨ë‹«ëŠ” ê³¼ì •ì´ ì¦ê±°ì› ë‹¤.' },
                    { date: '2024.05.18', text: 'ì±…ì„ ì½ë‹¤ê°€ ë¬¸ë“ ë‚´ ì‚¶ì˜ ë°©í–¥ì„±ì— ëŒ€í•œ íŒíŠ¸ë¥¼ ì–»ì—ˆë‹¤.' }
                ] 
            },
            'courage': { 
                kr: 'ìš©ê¸°ì˜ ì •ì›', en: 'Garden of Courage', 
                logs: [
                    { date: '2024.05.21', text: 'ë°œí‘œ ê³µí¬ì¦ì´ ìˆì—ˆì§€ë§Œ ì†ì„ ë“¤ê³  ë‚´ ì˜ê²¬ì„ ë§í–ˆë‹¤. ì‹¬ì¥ì´ í„°ì§ˆ ê²ƒ ê°™ì•˜ì§€ë§Œ í•´ëƒˆë‹¤.' }
                ] 
            },
            'kindness': { kr: 'ì¹œì ˆì˜ ì •ì›', en: 'Garden of Kindness', logs: [] },
            'diligence': { kr: 'ì„±ì‹¤ì˜ ì •ì›', en: 'Garden of Diligence', logs: [] },
            'serenity': { kr: 'í‰ì˜¨ì˜ ì •ì›', en: 'Garden of Serenity', logs: [] }
        };

        async function realAnalyzeDiary(diaryText) {
            // ğŸ‘‡ ìœ¤í˜¸ë‹˜ì˜ Render ì„œë²„ ì£¼ì†Œë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
            const url = "https://guelforest-server.onrender.com/analyze"; 

            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                    // ğŸ” Authorization í—¤ë” ì‚­ì œ! (ì´ì œ API í‚¤ëŠ” ì„œë²„ì— ìˆìœ¼ë‹ˆê¹Œìš”)
                },
                body: JSON.stringify({
                    diaryText: diaryText // ì„œë²„ë¡œ 'ì¼ê¸° ë‚´ìš©'ë§Œ ê°€ë³ê²Œ ë³´ëƒ…ë‹ˆë‹¤.
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || "ì„œë²„ í†µì‹  ì‹¤íŒ¨");
            }

            // ì„œë²„ê°€ ì´ë¯¸ ë¶„ì„í•´ì„œ ê¹”ë”í•œ JSONì„ ë³´ë‚´ì£¼ë¯€ë¡œ ë°”ë¡œ ë¦¬í„´!
            return await response.json(); 
        }

        // --- [í•µì‹¬] ì„¬ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì • ---
        islandElements.forEach(island => {
            // 1. í˜¸ë²„ íš¨ê³¼ (ê¸°ì¡´ ìœ ì§€)
            island.addEventListener('mouseenter', () => {
                // ì§‘ì¤‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ íˆ´íŒ í‘œì‹œ
                if(!document.body.classList.contains('world-focused') && island.classList.contains('visible')) {
                    const sound = audioHover.cloneNode(); sound.volume = 0.1; sound.play().catch(()=>{});
                    tooltipEn.innerText = island.dataset.nameEn;
                    tooltipKr.innerText = island.dataset.nameKr;
                    const points = parseInt(island.dataset.points);
                    const lvl = calculateLevel(points);
                    tooltipLvl.innerText = `Lv. ${lvl} (${points}pts)`;
                    tooltip.classList.add('active');
                }
            });
            island.addEventListener('mouseleave', () => { tooltip.classList.remove('active'); });

            island.addEventListener('click', (e) => {
                if (mainMenuSidebar.classList.contains('active')) {
                    mainMenuSidebar.classList.remove('active');
                    menuToggleBtn.classList.remove('open');
                }
                if (document.body.classList.contains('world-focused')) return;

                e.stopPropagation();
                const type = island.dataset.type;
                const points = parseInt(island.dataset.points);
                const level = calculateLevel(points);

                audioClick.play();
                document.body.classList.add('world-focused');
                island.classList.add('focused-island');

                // íŒ¨ë„ UI ì±„ìš°ê¸° (ê¸°ì¡´ê³¼ ë™ì¼)
                document.getElementById('panel-title-kr').innerText = islandData[type].kr;
                document.getElementById('panel-title-en').innerText = islandData[type].en;
                document.getElementById('panel-lvl').innerText = `Lv. ${level}`;
                document.getElementById('panel-pts').innerText = points;
                document.getElementById('panel-progress-bar').style.width = `${(level / 10) * 100}%`;

                // [NEW] ë°”êµ¬ë‹ˆ(cachedDiaries)ì—ì„œ í•„í„°ë§í•˜ê¸° (ì¦‰ë°œ ë¡œë”© âš¡ï¸)
                const listContainer = document.getElementById('panel-diary-list');
                listContainer.innerHTML = ''; 

                // í•´ë‹¹ ë•ëª©(type) ì ìˆ˜ê°€ 0ë³´ë‹¤ í° ì¼ê¸°ë§Œ ê³¨ë¼ë‚´ê¸°
                const filteredLogs = cachedDiaries.filter(data => 
                    data.stat_increase && data.stat_increase[type] > 0
                );

                if (filteredLogs.length === 0) {
                    listContainer.innerHTML = '<li style="color:#555; font-size:0.8rem; text-align:center; margin-top:20px;">ì•„ì§ ì´ ì •ì›ì— í•€ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                } else {
                    filteredLogs.forEach((data, index) => {
                        let dateStr = data.date_str || "ë‚ ì§œ ë¯¸ìƒ";
                        if(!data.date_str && data.timestamp) {
                             const date = data.timestamp.toDate();
                             dateStr = `${date.getFullYear()}. ${String(date.getMonth()+1).padStart(2,'0')}. ${String(date.getDate()).padStart(2,'0')}`;
                        }

                        const li = document.createElement('li');
                        li.classList.add('diary-item');
                        li.style.animation = `fadeInUp 0.5s ease forwards ${index * 0.05}s`;
                        li.style.opacity = '0';
                        li.style.cursor = 'pointer'; // í´ë¦­ ê°€ëŠ¥ í‘œì‹œ

                        li.innerHTML = `
                            <span class="diary-date">${dateStr}</span>
                            <span class="diary-snippet">${data.content}</span>
                            <div style="font-size: 0.7rem; color: #d4af37; margin-top: 5px; opacity: 0.8;">
                                ğŸŒ¿ "${data.ai_reply ? data.ai_reply.substring(0, 20) : "..."}..."
                            </div>
                        `;

                        // [NEW] ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í´ë¦­ ì‹œ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°!
                        li.addEventListener('click', () => openDetailModal(data, dateStr));

                        listContainer.appendChild(li);
                    });
                }

                sidePanel.classList.add('active');
            });
        });

        // --- [NEW] ì§‘ì¤‘ ëª¨ë“œ í•´ì œ (íŒ¨ë„ ë‹«ê¸°) í•¨ìˆ˜ ---
        function closeFocusMode() {
            if (!document.body.classList.contains('world-focused')) return;

            audioClick.play();
            sidePanel.classList.remove('active'); // íŒ¨ë„ ë‹«ê¸°
            document.body.classList.remove('world-focused'); // ì›”ë“œ ë³µê·€
            
            // ëª¨ë“  ì„¬ì—ì„œ focused í´ë˜ìŠ¤ ì œê±°
            islandElements.forEach(isl => isl.classList.remove('focused-island'));
        }

        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
        panelCloseBtn.addEventListener('click', closeFocusMode);

        // ë°°ê²½(ì›”ë“œ) í´ë¦­ ì‹œ ë‹«ê¸° (ë¹ˆ ê³µê°„ í´ë¦­)
        worldContainer.addEventListener('click', (e) => {
            // ì„¬ì´ë‚˜ íŒ¨ë„ì„ í´ë¦­í•œ ê²Œ ì•„ë‹ˆë¼ë©´ ë‹«ê¸°
            if(document.body.classList.contains('world-focused') && !e.target.closest('.island')) {
                closeFocusMode();
            }
        });

        // ESC í‚¤ ëˆ„ë¥´ë©´ ë‹«ê¸°
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeFocusMode();
        });

        // --- [ì¶”ê°€] ë¦¬ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ (ìŠ¤íƒ€ì¼ íƒœê·¸ì— ë„£ì–´ë„ ë¨) ---
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);

        // --- 1. ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ìŒ (ê¸°ì¡´ ì˜¤ë””ì˜¤ ì¬í™œìš©) ---
        diaryOpenBtn.addEventListener('mouseenter', () => {
            const sound = audioHover.cloneNode();
            sound.volume = 0.05;
            sound.play().catch(()=>{});
        });


        // --- 2. ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° ---
        diaryOpenBtn.addEventListener('click', () => {
            audioClick.play();
            diaryModal.classList.add('active');
            // ëª¨ë‹¬ ì—´ ë•Œ í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
            const now = new Date();
            diaryDateDisplay.innerText = `${now.getFullYear()}. ${String(now.getMonth()+1).padStart(2,'0')}. ${String(now.getDate()).padStart(2,'0')}. ${['SUN','MON','TUE','WED','THU','FRI','SAT'][now.getDay()]}`;
        });

        // --- 3. ê¸€ì ìˆ˜ ê²€ì¦ ë¡œì§ (30ì ~ 20ì) ---
        diaryTextarea.addEventListener('input', () => {
            const len = diaryTextarea.value.length;
            charCounter.innerText = `${len} / 200`;

            // ê¸°íšì„œ ë°¸ëŸ°ì‹± ê¸°ì¤€: ìµœì†Œ 30ì, ìµœëŒ€ 200ì [cite: 3, 17]
            if (len >= 30 && len <= 200) {
                diarySubmitBtn.disabled = false;
                charCounter.classList.remove('invalid');
            } else {
                diarySubmitBtn.disabled = true;
                charCounter.classList.add('invalid');
            }
        });

        // --- 5. [ìˆ˜ì •] ì¼ê¸° ì œì¶œ ë° ì €ì¥ ë¡œì§ ---
        diarySubmitBtn.addEventListener('click', async () => {
            const text = diaryTextarea.value;
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (text.length < 30 || text.length > 200) {
                alert("ì¼ê¸°ëŠ” 30ì ì´ìƒ 200ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                return;
            }

            diarySubmitBtn.disabled = true;
            diarySubmitBtn.innerText = "ì •ì›ì‚¬ê°€ ì½ëŠ” ì¤‘... ğŸŒ¿";
            audioClick.play();

            try {
                // 1. ì„œë²„(Render)ì— ë¶„ì„ ìš”ì²­
                const result = await realAnalyzeDiary(text);
                currentLastResult = result; // ê²°ê³¼ ëª¨ë‹¬ìš© ì €ì¥

                // 2. [í•µì‹¬] Firestoreì— ì¼ê¸° ë°ì´í„° ì €ì¥
                // users -> (ë‚´ UID) -> diaries -> (ìë™ìƒì„±ID) ë¬¸ì„œ ìƒì„±
                await db.collection('users').doc(currentUser.uid).collection('diaries').add({
                    content: text, // ë‚´ê°€ ì“´ ì¼ê¸°
                    ai_reply: result.comment, // ì •ì›ì‚¬ì˜ ë‹µì¥
                    stat_increase: result.points, // ì´ë²ˆì— ì˜¤ë¥¸ ì ìˆ˜ë“¤
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), // ì •í™•í•œ ì„œë²„ ì‹œê°„
                    date_str: new Date().toISOString().slice(0,10) // ê²€ìƒ‰ìš© ë‚ ì§œ ë¬¸ìì—´ (2024-05-21)
                });

                const newDiaryObj = {
                    content: text,
                    ai_reply: result.comment,
                    stat_increase: result.points,
                    timestamp: { toDate: () => new Date() }, // ë¡œì»¬ í‘œì‹œìš© ê°€ì§œ íƒ€ì„ìŠ¤íƒ¬í”„
                    date_str: new Date().toISOString().slice(0,10)
                };
                
                // [NEW] ë°”êµ¬ë‹ˆ ë§¨ ì•ì— ìƒˆ ì¼ê¸° ì¶”ê°€ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜)
                cachedDiaries.unshift(newDiaryObj);

                // 3. [í•µì‹¬] ìœ ì €ì˜ ì´ ëŠ¥ë ¥ì¹˜(Total Points) ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                const userRef = db.collection('users').doc(currentUser.uid);
                
                // ì ìˆ˜ê°€ ì˜¤ë¥¸ í•­ëª©ë§Œ ê³¨ë¼ì„œ ê¸°ì¡´ ì ìˆ˜ì— ë”í•˜ê¸°(increment)
                const updateData = {};
                for (const [virtue, score] of Object.entries(result.points)) {
                    if (score > 0) {
                        // total_points.courage += 8 ì´ëŸ° ì‹ìœ¼ë¡œ ì‘ë™í•¨
                        updateData[`total_points.${virtue}`] = firebase.firestore.FieldValue.increment(score);
                    }
                }
                
                // ì—…ë°ì´íŠ¸ ì‹¤í–‰ (ë§Œì•½ total_points í•„ë“œê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë¨)
                await userRef.update(updateData);


                // --- ì´í•˜ ì—°ì¶œ ë° UI ì—…ë°ì´íŠ¸ ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼ ---
                resultPointUpArea.innerHTML = '';
                
                virtues.forEach((v, index) => {
                    const p = result.points[v] || 0;
                    if (p > 0) {
                        currentPoints[v] += p;
                        islandData[v].logs.unshift({ date: 'ë°©ê¸ˆ ì „', text: text });
                        
                        const badge = document.createElement('div');
                        badge.classList.add('point-badge', `badge-${v}`);
                        badge.innerText = `${v.toUpperCase()} +${p}`;
                        badge.style.animationDelay = `${0.8 + (index * 0.1)}s`;
                        resultPointUpArea.appendChild(badge);

                        const slider = document.getElementById(`rng-${v}`);
                        const display = document.getElementById(`val-${v}`);
                        if (slider) slider.value = currentPoints[v];
                        if (display) display.innerText = currentPoints[v];
                        updateIslandVisual(v, currentPoints[v]);
                    }
                });

                resultComment.innerText = result.comment;

                diaryModal.classList.remove('active');
                setTimeout(() => {
                    resultModal.classList.add('active');
                    audioResult.volume = 0.6;
                    audioResult.play().catch(e => console.warn("ê²°ê³¼ íš¨ê³¼ìŒ ë¡œë“œ ì‹¤íŒ¨:", e));
                }, 500);

                diaryTextarea.value = '';
                charCounter.innerText = "0 / 200";

            } catch (err) {
                console.error(err);
                alert("ì¼ê¸° ê¸°ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            } finally {
                diarySubmitBtn.disabled = false;
                diarySubmitBtn.innerText = "ë‚˜ë¬´ ì‹¬ê¸° (ê¸°ë¡)";
            }
        });

        resultCloseBtn.addEventListener('click', () => {
            resultModal.classList.remove('active');

            // ì´ì œ currentLastResultê°€ ì •ì˜ë˜ì–´ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤!
            if (!currentLastResult) return;

            Object.keys(currentLastResult.points).forEach((v, index) => {
                const p = currentLastResult.points[v];
                if (p > 0) {
                    setTimeout(() => {
                        createOrbToIsland(v, p);
                    }, index * 250); // êµ¬ìŠ¬ì´ í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ ë‚ ì•„ê°
                }
            });
        });

        function createOrbToIsland(virtue, points) {
            const island = document.getElementById(`island-${virtue}`);
            const islandImg = document.getElementById(`img-${virtue}`);
            const islandRect = island.getBoundingClientRect();
            const color = virtueColors[virtue];
            
            const orb = document.createElement('div');
            orb.classList.add('energy-orb');
            orb.style.setProperty('--orb-color', color);
            
            orb.style.left = `${window.innerWidth / 2}px`;
            orb.style.top = `${window.innerHeight / 2}px`;
            document.body.appendChild(orb);

            orb.offsetHeight; 

            setTimeout(() => {
                orb.classList.add('flying');
                const targetX = islandRect.left + islandRect.width / 2;
                const targetY = islandRect.top + islandRect.height / 2;
                orb.style.left = `${targetX - 15}px`; 
                orb.style.top = `${targetY - 15}px`;
            }, 100);

            // [ì¶©ëŒ ì‹œì ]
            setTimeout(() => {
                orb.remove();

                // A. [NEW] íƒ€ê²© íš¨ê³¼ìŒ ì¬ìƒ
                if(audioHit) {
                    const hitSound = audioHit.cloneNode();
                    hitSound.volume = 0.4;
                    hitSound.play().catch(()=>{});
                }

                // B. ì„¬ ë°œê´‘
                islandImg.classList.add('flash-effect');
                setTimeout(() => islandImg.classList.remove('flash-effect'), 700);

                // C. [ê°œì„ ] ì¶©ê²©íŒŒ ìƒì„±
                const ripple = document.createElement('div');
                ripple.classList.add('impact-ripple');
                ripple.style.setProperty('--orb-color', color);
                island.appendChild(ripple);
                setTimeout(() => ripple.classList.add('active'), 10);
                setTimeout(() => ripple.remove(), 600);

                // D. [ê°œì„ ] ì‘ê³  ì˜ˆìœ í…ìŠ¤íŠ¸ íŒì—…
                const popup = document.createElement('div');
                popup.classList.add('floating-point');
                popup.style.setProperty('--orb-color', color);
                popup.innerText = `+${points} PTS`;
                island.appendChild(popup);
                
                setTimeout(() => popup.classList.add('pop'), 10);

                setTimeout(() => {
                    popup.classList.add('fade');
                    setTimeout(() => popup.remove(), 500);
                }, 1200); // í‘œì‹œ ì‹œê°„ë„ ì‚´ì§ ë‹¨ì¶•í•˜ì—¬ ê²½ì¾Œí•˜ê²Œ

            }, 1300);
        }

        diaryCloseX.addEventListener('click', () => { 
            // [ì¤‘ìš”] style.display = 'none' ëŒ€ì‹  í´ë˜ìŠ¤ ì œê±°!
            diaryModal.classList.remove('active'); 
        });

        diaryModal.addEventListener('click', (e) => {
            if (e.target === diaryModal) {
                diaryModal.classList.remove('active');
            }
        });

        // [í•µì‹¬] í¬ì¸íŠ¸ì— ë”°ë¥¸ ë ˆë²¨ ê³„ì‚° í•¨ìˆ˜ 
        function calculateLevel(points) {
            if (points <= 15) return 1;
            if (points <= 30) return 2;
            if (points <= 45) return 3;
            if (points <= 60) return 4;
            if (points <= 75) return 5;
            if (points <= 90) return 6;
            if (points <= 105) return 7;
            if (points <= 125) return 8;
            if (points <= 150) return 9;
            return 10; // Max [cite: 43]
        }

        // [í•µì‹¬] ì„¬ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateIslandVisual(type, points) {
            const level = calculateLevel(points);
            const imgElement = document.getElementById(`img-${type}`);
            const parentElement = document.getElementById(`island-${type}`);
            
            // ë°ì´í„° ì—…ë°ì´íŠ¸
            parentElement.dataset.points = points;
            
            // ì´ë¯¸ì§€ ì†ŒìŠ¤ êµì²´ (íŒŒì¼ëª… ê·œì¹™: island_type_level.png)
            const newSrc = `images/island_${type}_${level}.png`;
            
            // í˜„ì¬ ì´ë¯¸ì§€ì™€ ë‹¤ë¥¼ ë•Œë§Œ êµì²´ (ë¶ˆí•„ìš”í•œ ë¦¬ë¡œë“œ ë°©ì§€)
            if (!imgElement.src.includes(newSrc)) {
                // í˜ì´ë“œ íš¨ê³¼ë¥¼ ìœ„í•´ íˆ¬ëª…ë„ ì¡°ì ˆ
                imgElement.style.opacity = 0;
                setTimeout(() => {
                    imgElement.src = newSrc;
                    imgElement.onload = () => {
                        imgElement.style.opacity = 1;
                    };
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ(íŒŒì¼ ì—†ì„ ë•Œ) 1ë ˆë²¨ë¡œ ë¡¤ë°±í•˜ëŠ” ì•ˆì „ì¥ì¹˜
                    imgElement.onerror = () => {
                        imgElement.src = `images/island_${type}_1.png`;
                        imgElement.style.opacity = 1;
                    }
                }, 300);
            }
        }

        // [NEW] ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        const virtues = ['courage', 'wisdom', 'kindness', 'diligence', 'serenity'];
        virtues.forEach(v => {
            const slider = document.getElementById(`rng-${v}`);
            const display = document.getElementById(`val-${v}`);
            
            slider.addEventListener('input', (e) => {
                const points = parseInt(e.target.value);
                display.innerText = points;
                updateIslandVisual(v, points);
            });
        });

        function createStars() {
            const count = 100;
            for(let i=0; i<count; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const x = Math.random() * 100;
                const y = Math.random() * 70; 
                const size = Math.random() * 2 + 1;
                const duration = Math.random() * 3 + 2; 
                const opacity = Math.random() * 0.7 + 0.3;
                star.style.left = `${x}%`; star.style.top = `${y}%`;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${duration}s`);
                star.style.setProperty('--opacity', opacity);
                starsContainer.appendChild(star);
            }
        }
        createStars();

        function updateDayNightCycle() {
            let now;
            if (window.manualTime) { now = new Date(); now.setHours(window.manualTime.h, window.manualTime.m); } else { now = new Date(); }
            const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0'); const date = String(now.getDate()).padStart(2, '0');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT']; const dayName = days[now.getDay()];
            hudDate.innerText = `${year}. ${month}. ${date}. ${dayName}`;
            const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0');
            hudTime.innerText = `${hours}:${minutes}`;
            const h = now.getHours();
            let skyGradient = ''; let starsOpacity = 0;
            if (h >= 5 && h < 7) { skyGradient = 'linear-gradient(135deg, #2c3e50 0%, #4ca1af 60%, #ff9966 100%)'; starsOpacity = 0; }
            else if (h >= 7 && h < 17) { skyGradient = 'linear-gradient(135deg, #2980b9 0%, #6dd5fa 50%, #ffffff 100%)'; starsOpacity = 0; }
            else if (h >= 17 && h < 19) { skyGradient = 'linear-gradient(135deg, #3e5151 0%, #decba4 50%, #ff7e5f 100%)'; starsOpacity = 0.3; }
            else { skyGradient = 'linear-gradient(160deg, #0f2027 0%, #203a43 60%, #2c5364 100%)'; starsOpacity = 1; }
            skyBg.style.background = skyGradient; starsContainer.style.opacity = starsOpacity;
        }
        setInterval(updateDayNightCycle, 1000); updateDayNightCycle(); 

        let width, height;
        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resize); resize();

        let mouseX = 0; let mouseY = 0; let targetX = 0; let targetY = 0;
        const parallaxSensitivity = 0.2; 
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - width / 2) / (width / 2);
            mouseY = (e.clientY - height / 2) / (height / 2);
            tooltip.style.left = e.clientX + 'px'; tooltip.style.top = e.clientY + 'px';
        });

        function updateParallax() {
            targetX += (mouseX - targetX) * 0.05; targetY += (mouseY - targetY) * 0.05;
            const allObjects = document.querySelectorAll('.scene-object');
            allObjects.forEach(obj => {
                const depth = parseFloat(obj.dataset.depth); const baseX = parseFloat(obj.dataset.baseX); const baseY = parseFloat(obj.dataset.baseY);
                const moveX = targetX * depth * width * -1 * parallaxSensitivity; const moveY = targetY * depth * height * -1 * parallaxSensitivity;
                obj.style.left = `${baseX}%`; obj.style.top = `${baseY}%`; obj.style.transform = `translate(calc(-50% + ${moveX}px), ${moveY}px)`;
            });
            requestAnimationFrame(updateParallax);
        }

        function createShards() {
            const shardCount = 20;
            for(let i=0; i<shardCount; i++) {
                const shard = document.createElement('div'); shard.classList.add('shard', 'scene-object'); 
                const size = 5 + Math.random() * 20; shard.style.width = `${size}px`; shard.style.height = `${size}px`;
                shard.dataset.baseX = Math.random() * 100; shard.dataset.baseY = Math.random() * 90; shard.dataset.depth = (Math.random() * 0.1).toFixed(3); 
                const p1 = Math.floor(Math.random() * 100); const p2 = Math.floor(Math.random() * 100); const p3 = Math.floor(Math.random() * 100);
                shard.style.clipPath = `polygon(${p1}% 0%, 100% ${p2}%, ${p3}% 100%)`; shard.style.animationDelay = `${Math.random() * 5}s`;
                islandsContainer.appendChild(shard);
            }
        }
        createShards(); 

        islandElements.forEach(island => {
            island.addEventListener('mouseenter', () => {
                if(island.classList.contains('visible')) {
                    const sound = audioHover.cloneNode(); sound.volume = 0.05; sound.play().catch(()=>{});
                    tooltipEn.innerText = island.dataset.nameEn;
                    tooltipKr.innerText = island.dataset.nameKr;
                    
                    // íˆ´íŒì— í˜„ì¬ ë ˆë²¨ í‘œì‹œ ì¶”ê°€
                    const points = parseInt(island.dataset.points);
                    const lvl = calculateLevel(points);
                    tooltipLvl.innerText = `Lv. ${lvl} (${points}pts)`;
                    
                    tooltip.classList.add('active');
                }
            });
            island.addEventListener('mouseleave', () => { tooltip.classList.remove('active'); });
        });

        let particles = []; const particleCount = 200; let isClearing = false; let isGardenMode = false;
        class Particle {
            constructor(isIntro = true) { this.isIntro = isIntro; this.markedForDeletion = false; this.reset(true); }
            reset(initial = false) {
                if (this.isIntro) {
                    this.x = Math.random() * width; this.y = Math.random() * height; this.z = Math.random(); 
                    this.size = 100 + this.z * 300; this.speed = 0.5 + this.z * 0.5; this.opacity = 0.4 + Math.random() * 0.5;
                    this.vx = this.speed; this.vy = 0; this.type = 'cloud';
                } else {
                    this.x = width + 50; const rand = Math.random();
                    if (rand < 0.8) { this.y = (height * 0.7) + Math.random() * (height * 0.3); } else { this.y = Math.random() * (height * 0.5); }
                    const typeRand = Math.random();
                    if (typeRand > 0.8) { this.type = 'mini-cloud'; this.size = 30 + Math.random() * 60; this.speed = 0.5 + Math.random() * 0.5; this.opacity = 0.15 + Math.random() * 0.2; } 
                    else { this.type = 'wind'; this.size = 1 + Math.random() * 2; this.speed = 2.5 + Math.random() * 2; this.opacity = 0.05 + Math.random() * 0.1; }
                    this.vx = -this.speed; this.vy = (Math.random() - 0.5) * 0.2;
                }
                this.explodeVx = 0; this.explodeVy = 0;
            }
            update() {
                if (this.isIntro) {
                    if (!isClearing) { this.x += this.vx; if (this.x - this.size > width) { this.x = -this.size; this.y = Math.random() * height; } } 
                    else {
                        const centerX = width / 2; const centerY = height / 2; const dx = this.x - centerX; const dy = this.y - centerY;
                        const angle = Math.atan2(dy, dx); const force = 8; 
                        this.explodeVx += Math.cos(angle) * 0.8; this.explodeVy += Math.sin(angle) * 0.8;
                        this.x += (Math.cos(angle) * force) + this.explodeVx; this.y += (Math.sin(angle) * force) + this.explodeVy;
                        this.opacity -= 0.02; if (this.opacity <= 0) { this.markedForDeletion = true; }
                    }
                } else {
                    this.x += this.vx; this.y += this.vy; if (this.x < -200) { this.markedForDeletion = true; }
                }
            }
            draw() {
                if (this.opacity <= 0) return; ctx.beginPath();
                if (this.type === 'cloud' || this.type === 'mini-cloud') {
                    const gradient = ctx.createRadialGradient(this.x, this.y, this.size * 0.1, this.x, this.y, this.size);
                    gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`); gradient.addColorStop(0.6, `rgba(240, 248, 255, ${this.opacity * 0.5})`); gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                    ctx.fillStyle = gradient; ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                } else if (this.type === 'wind') {
                    ctx.strokeStyle = `rgba(255, 255, 255, ${this.opacity})`; ctx.lineWidth = 1;
                    ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.size * 15, this.y); ctx.stroke();
                }
            }
        }

        function initIntroParticles() { for (let i = 0; i < particleCount; i++) particles.push(new Particle(true)); }
        function spawnGardenParticles() { if (!isGardenMode) return; if (particles.length < 100) { particles.push(new Particle(false)); } }
        function animateParticles() {
            ctx.clearRect(0, 0, width, height); for (let i = 0; i < particles.length; i++) { particles[i].update(); particles[i].draw(); }
            particles = particles.filter(p => !p.markedForDeletion);
            if (isGardenMode) { spawnGardenParticles(); }
            requestAnimationFrame(animateParticles);
        }

        enterBtn.addEventListener('mouseenter', () => { const sound = audioHover.cloneNode(); sound.volume = 0.05; sound.play().catch(()=>{}); });
        enterBtn.addEventListener('click', () => {
            // [ì¦‰ì‹œ ì‹¤í–‰] íš¨ê³¼ìŒ, UI í˜ì´ë“œì•„ì›ƒ, ì›”ë“œ í™•ëŒ€
            audioClick.play();
            
            // [ìˆ˜ì •] í´ë¦­í•˜ìë§ˆì êµ¬ë¦„ ê±·íˆëŠ” ì†Œë¦¬ì™€ ë°”ëŒ ì†Œë¦¬ ì¦‰ì‹œ ì¬ìƒ
            audioClear.volume = 0.2;
            audioClear.play();
            
            audioAmbiance.volume = 0.3; // ë°”ëŒ ì†Œë¦¬ëŠ” ì€ì€í•˜ê²Œ
            audioAmbiance.play();

            uiLayer.style.opacity = '0';
            isClearing = true;
            worldContainer.style.transform = "scale(2.0)"; 

            setTimeout(() => {
                isGardenMode = true;
                const allSceneObjects = document.querySelectorAll('.scene-object');
                allSceneObjects.forEach((obj) => { obj.classList.add('visible'); });

                if (diaryOpenBtn) diaryOpenBtn.classList.add('visible');

                cloudFloor.style.opacity = '1'; 
                hudLayer.style.opacity = '1'; 
                updateParallax();
            }, 1000);

            setTimeout(() => { 
                uiLayer.style.display = 'none'; 
            }, 1500);
        });

        initIntroParticles(); animateParticles();
        // --- [ì¶”ê°€] F3 í‚¤ë¡œ ì •ì›ì‚¬ ëª¨ë“œ í† ê¸€ ---
        window.addEventListener('keydown', (e) => {
            if (e.key === 'F3') {
                e.preventDefault(); // ë¸Œë¼ìš°ì € ìì²´ 'ì°¾ê¸°' ì°½ì´ ëœ¨ëŠ” ê±¸ ë§‰ìŒ
                
                // í˜„ì¬ ìƒíƒœê°€ blockì´ë©´ ìˆ¨ê¸°ê³ , ì•„ë‹ˆë©´ ë³´ì—¬ì¤Œ
                if (devPanel.style.display === 'block') {
                    devPanel.style.display = 'none';
                } else {
                    devPanel.style.display = 'block';
                }
            }
        });
    </script>
</body>
</html> 