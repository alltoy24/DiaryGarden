<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ìˆ² - ê¸€ì´ ì •ì›ì„ ë§Œë“¤ë‹¤ (Evolution Dev)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nanum+Myeongjo:wght@400;700&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    
    <style>
        /* 1. ì¼ê¸° ì—´ê¸° ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) */
        #diary-open-btn {
            position: fixed;
            bottom: 50px;
            right: 50px;
            z-index: 1000;
            background: transparent;
            border: none;
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            letter-spacing: 0.2rem;
            cursor: pointer;
            opacity: 0; 
            visibility: hidden;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }

        #diary-open-btn.visible { 
            opacity: 0.7; 
            visibility: visible;
            pointer-events: auto; 
        }

        #diary-open-btn:hover { 
            opacity: 1; 
            transform: translateY(-5px); 
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6); 
        }

        .btn-line {
            width: 0%; height: 1px; background: #d4af37;
            transition: width 0.4s ease; margin-top: 5px;
        }
        #diary-open-btn:hover .btn-line { width: 100%; }

        /* 2. ì¼ê¸° ëª¨ë‹¬ ì „ì²´ ë°°ê²½ */
        #diary-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px); /* ìˆ²ì´ ëª½í™˜ì ìœ¼ë¡œ ë¹„ì¹¨ */
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; 
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        #diary-modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* 3. ì¼ê¸° ì‘ì„± ì°½ (ë””ìì¸ í•µì‹¬) */
        .diary-window {
            width: 550px;
            background: linear-gradient(145deg, rgba(20, 25, 30, 0.95), rgba(10, 12, 15, 0.98));
            border: 1px solid rgba(212, 175, 55, 0.25);
            padding: 50px 40px;
            position: relative;
            box-shadow: 0 40px 100px rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            /* ì• ë‹ˆë©”ì´ì…˜: ì‚´ì§ ì•„ë˜ì—ì„œ ë¶€ë“œëŸ½ê²Œ ë– ì˜¤ë¦„ */
            transform: translateY(30px) scale(0.98);
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #diary-modal.active .diary-window {
            transform: translateY(0) scale(1);
        }

        .diary-header {
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
            padding-bottom: 20px;
        }

        #diary-date-display {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: #ffd700;
            letter-spacing: 0.1rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        /* 4. í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ (ì¤‘ë³µ ìŠ¤íƒ€ì¼ í†µí•©) */
        #diary-textarea {
            width: 100%;
            height: 300px;
            background: rgba(255, 255, 255, 0.02);
            border: none;
            color: #e0e0e0;
            font-family: 'Nanum Pen Script', cursive;
            font-size: 1rem;
            line-height: 1.8;
            resize: none;
            outline: none;
            padding: 15px;
            transition: background 0.3s ease;
        }

        #diary-textarea:focus {
            background: rgba(255, 255, 255, 0.04);
        }

        #diary-textarea::placeholder {
            color: #555;
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1rem;
        }

        /* 5. ë²„íŠ¼ ë° ê¸°íƒ€ ìš”ì†Œ */
        .char-counter {
            text-align: right;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            color: #666;
            margin-top: 15px;
        }

        .char-counter.invalid { color: #cc4444; }

        .diary-submit-btn {
            margin-top: 30px;
            background: transparent;
            border: 1px solid rgba(212, 175, 55, 0.4);
            color: #d4af37;
            font-family: 'Nanum Myeongjo', serif;
            font-size: 1rem;
            padding: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .diary-submit-btn:disabled { 
            border-color: #333; color: #444; cursor: not-allowed; 
        }

        .diary-submit-btn:not(:disabled):hover { 
            background: rgba(212, 175, 55, 0.1); 
            border-color: #d4af37;
            color: #fff;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.15);
        }

        .close-modal {
            position: absolute;
            top: 20px; right: 25px;
            color: rgba(212, 175, 55, 0.5);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            font-family: sans-serif;
            z-index: 10; /* ì•ˆì „í•˜ê²Œ ì¶”ê°€ */
        }
        .close-modal:hover {
            color: #d4af37;
            transform: rotate(90deg);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; cursor: default; }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: #000; }

        /* ì›”ë“œ ì»¨í…Œì´ë„ˆ */
        #world-container {
            position: relative; width: 100%; height: 100%;
            transition: transform 3.5s cubic-bezier(0.25, 1, 0.5, 1);
            transform-origin: center center; overflow: hidden; 
        }

        /* ë°°ê²½ */
        #sky-bg {
            position: absolute; top: -20%; left: -20%; width: 140%; height: 140%;
            background: linear-gradient(160deg, #0f2027 0%, #203a43 60%, #2c5364 100%);
            z-index: 1; transition: background 3s ease-in-out;
        }

        /* ë³„ (ë°¤) */
        #stars-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none; opacity: 0; transition: opacity 3s ease-in-out;
        }
        .star {
            position: absolute; background-color: white; border-radius: 50%;
            box-shadow: 0 0 4px 1px rgba(255, 255, 255, 0.4);
            animation: twinkle var(--duration) ease-in-out infinite; opacity: var(--opacity);
        }
        @keyframes twinkle { 0%, 100% { opacity: var(--opacity); transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.8); } }

        /* ë°”ë‹¥ ìš´í•´ */
        #cloud-floor {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            background: linear-gradient(to top, rgba(255,255,255,0.95) 10%, rgba(220,230,255,0.8) 40%, rgba(255,255,255,0) 100%);
            z-index: 3; pointer-events: none; opacity: 0; transition: opacity 3s ease-in-out;
        }

        /* íŒŒí‹°í´ ìº”ë²„ìŠ¤ */
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; pointer-events: none; }

        /* UI ë ˆì´ì–´ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            padding: 60px; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start;
            transition: opacity 1.5s ease-out; background: linear-gradient(to right, rgba(0,0,0,0.5) 0%, transparent 50%);
        }

        /* íˆ´íŒ */
        #cursor-tooltip {
            position: fixed; z-index: 200; top: 0; left: 0; pointer-events: none; opacity: 0;
            transform: translate(20px, -20px); transition: opacity 0.2s ease, transform 0.2s ease;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        #cursor-tooltip.active { opacity: 1; transform: translate(25px, -25px); }
        .tooltip-line { width: 40px; height: 2px; background: #d4af37; margin-bottom: 5px; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); }
        #tooltip-kr { font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; color: #fff; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.8); letter-spacing: 0.1rem; line-height: 1; margin-bottom: 3px; }
        #tooltip-en { font-family: 'Cinzel', serif; font-size: 0.7rem; color: rgba(255, 255, 255, 0.7); letter-spacing: 0.2rem; text-transform: uppercase; }
        .tooltip-level { font-family: 'Cinzel', serif; font-size: 0.8rem; color: #ffd700; margin-top: 5px; } /* ë ˆë²¨ í‘œì‹œ ì¶”ê°€ */

        /* HUD */
        #hud-layer {
            position: fixed; top: 30px; left: 30px; z-index: 90; opacity: 0; transition: opacity 3s ease-in-out;
            font-family: 'Nanum Myeongjo', serif; color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; pointer-events: none;
        }
        #hud-line { width: 1px; height: 35px; background-color: rgba(255,255,255,0.4); margin-right: 15px; }
        #hud-text-group { display: flex; flex-direction: column; }
        #hud-date { font-size: 0.8rem; letter-spacing: 0.1rem; opacity: 0.6; margin-bottom: 2px;}
        #hud-time { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 400; line-height: 1; }

        .title-group { margin-bottom: 50px; color: white; text-shadow: 0 2px 15px rgba(0,0,0,0.5); }
        h1.main-title { font-family: 'Nanum Myeongjo', serif; font-size: 5rem; font-weight: 700; letter-spacing: 0.3rem; margin-bottom: 10px; line-height: 1.1; }
        h2.sub-title { font-family: 'Nanum Myeongjo', serif; font-size: 1.2rem; font-weight: 400; opacity: 0.8; letter-spacing: 0.4rem; margin-left: 5px; }

        .enter-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.4); color: white; font-family: 'Nanum Myeongjo', serif; font-size: 1.1rem; cursor: pointer; padding: 10px 30px; margin-left: 5px; position: relative; opacity: 0.8; transition: all 0.3s;
        }
        .enter-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); border-color: #fff; }

        /* --- ì„¬ ì»¨í…Œì´ë„ˆ --- */
        #islands-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; perspective: 1000px;
        }
        .scene-object {
            position: absolute; opacity: 0; transition: opacity 2s ease-in-out;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            will-change: transform; pointer-events: auto; cursor: pointer;
        }
        .scene-object.visible { opacity: 1; }

        .island img {
            width: 100%; height: auto;
            filter: drop-shadow(0 15px 25px rgba(0,0,0,0.6)) brightness(0.9);
            animation: float 6s ease-in-out infinite;
            /* ì´ë¯¸ì§€ êµì²´ì‹œ ë¶€ë“œëŸ½ê²Œ */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.4s ease, opacity 0.3s ease; 
        }
        .island:hover img {
            transform: scale(1.1) translateY(-10px);
            filter: drop-shadow(0 30px 50px rgba(255,255,255,0.2)) brightness(1.3);
            z-index: 50;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        /* ì„¬ ë°°ì¹˜ */
        #island-kindness { width: 105px; z-index: 20; top: 30%; left: 50%; transform: translate(-50%, 0); }
        #island-courage { width: 90px; z-index: 15; top: 23%; left: 38%; transform: translate(-50%, 0); }
        #island-diligence { width: 90px; z-index: 15; top: 23%; left: 62%; transform: translate(-50%, 0); }
        #island-wisdom { width: 65px; z-index: 10; top: 15%; left: 42%; transform: translate(-50%, 0); }
        #island-serenity { width: 65px; z-index: 10; top: 15%; left: 58%; transform: translate(-50%, 0); }

        /* ì¥ì‹ë¬¼ íŒŒí¸ */
        .shard {
            position: absolute;
            background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.05));
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
            backdrop-filter: blur(2px);
            z-index: 5; pointer-events: none; opacity: 0; transition: opacity 2s;
            animation: shard-spin 15s linear infinite alternate;
        }
        .shard.visible { opacity: 0.6; }
        @keyframes shard-spin { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(-20px) rotate(15deg); } }

        /* --- [ìˆ˜ì •] ê°œë°œììš© ì»¨íŠ¸ë¡¤ íŒ¨ë„: ì™¼ìª½ìœ¼ë¡œ ì´ë™ --- */
        #dev-panel {
            position: fixed; 
            bottom: 20px; 
            left: 20px; /* rightì—ì„œ leftë¡œ ë³€ê²½ */
            right: auto; /* ê¸°ì¡´ ìš°ì¸¡ ê³ ì • í•´ì œ */
            z-index: 9999;
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px);
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: white; 
            font-family: sans-serif; 
            width: 250px;
            display: none; 
        }
        #dev-panel h3 { font-size: 14px; margin-bottom: 10px; color: #ffd700; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .control-group { margin-bottom: 10px; display: flex; flex-direction: column; }
        .control-group label { font-size: 12px; margin-bottom: 2px; color: #ccc; display: flex; justify-content: space-between; }
        .control-group input[type="range"] { width: 100%; cursor: pointer; }
        .val-display { color: #fff; font-weight: bold; }

        #island-info-panel {
            position: fixed; top: 0; right: -400px; /* ì˜¤ë¥¸ìª½ ë°–ì— ìˆ¨ê¸°ê¸° */
            width: 380px; height: 100%;
            background: rgba(10, 12, 15, 0.95); /* ê²€ì€ìƒ‰ ë°°ê²½ */
            border-left: 1px solid rgba(212, 175, 55, 0.3);
            backdrop-filter: blur(10px);
            z-index: 5000;
            padding: 40px 30px;
            display: flex; flex-direction: column;
            transition: right 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        #island-info-panel.active { right: 0; }

        /* 2. íŒ¨ë„ ë‚´ë¶€ íƒ€ì´í¬ê·¸ë˜í”¼ */
        #panel-close-btn {
            position: absolute; top: 20px; right: 20px;
            background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; transition: color 0.3s;
        }
        #panel-close-btn:hover { color: #d4af37; }

        .panel-header { margin-bottom: 30px; text-align: left; }
        #panel-title-kr { font-family: 'Nanum Myeongjo', serif; font-size: 2.5rem; color: #fff; margin-bottom: 5px; }
        #panel-title-en { font-family: 'Cinzel', serif; font-size: 0.9rem; color: #d4af37; letter-spacing: 0.2rem; text-transform: uppercase; }

        .panel-stats { margin-bottom: 30px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-family: 'Cinzel', serif; font-size: 0.9rem; color: #ccc; }
        .stat-value { color: #ffd700; font-weight: bold; }
        .stat-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; }
        .stat-bar-fill { height: 100%; background: #d4af37; width: 0%; transition: width 1s ease; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }

        .panel-divider { width: 100%; height: 1px; background: linear-gradient(to right, transparent, rgba(212, 175, 55, 0.5), transparent); margin-bottom: 30px; }

        /* 3. ì¼ê¸° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .panel-history h4 { font-family: 'Nanum Myeongjo', serif; color: #aaa; font-size: 0.9rem; margin-bottom: 15px; }
        #panel-diary-list { list-style: none; overflow-y: auto; max-height: 60vh; padding-right: 5px; }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        #panel-diary-list::-webkit-scrollbar { width: 4px; }
        #panel-diary-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .diary-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 15px; margin-bottom: 10px;
            border-radius: 5px; transition: all 0.3s ease;
        }
        .diary-item:hover { background: rgba(255,255,255,0.07); border-color: rgba(212, 175, 55, 0.3); transform: translateX(5px); }
        .diary-date { font-family: 'Cinzel', serif; font-size: 0.7rem; color: #d4af37; margin-bottom: 5px; display: block; }
        .diary-snippet { font-family: 'Nanum Myeongjo', serif; font-size: 0.9rem; color: #ddd; line-height: 1.4; }


        /* --- [í•µì‹¬] ì›”ë“œ ì§‘ì¤‘ ëª¨ë“œ (World Focus Mode) --- */

        /* ì§‘ì¤‘ ëª¨ë“œ ì‹œ ê¸°ì¡´ UI íˆ¬ëª…í™” */
        .world-focused #hud-layer, 
        .world-focused #diary-open-btn,
        .world-focused #cursor-tooltip { 
            opacity: 0 !important; pointer-events: none; transition: opacity 0.5s ease; 
        }

        /* ì„ íƒë˜ì§€ ì•Šì€ ì„¬ë“¤: êµ¬ë¦„ì²˜ëŸ¼ í¼ì§€ë©° ì‚¬ë¼ì§ */
        .world-focused .island:not(.focused-island) {
            opacity: 0 !important;
            transform: translate(-50%, -100px) scale(1.5) !important; /* ìœ„ë¡œ ì˜¬ë¼ê°€ë©° ì»¤ì§ */
            filter: blur(10px);
            pointer-events: none;
            transition: all 1s ease;
        }

        .world-focused .island.focused-island {
            /* ê¸°ì¡´ 25%ëŠ” ë„ˆë¬´ ì™¼ìª½ì…ë‹ˆë‹¤. íŒ¨ë„(380px)ì„ ëº€ ê³µê°„ì˜ ì¤‘ì•™ì„ ê³„ì‚°í•©ë‹ˆë‹¤. */
            left: calc(50% - 190px) !important; 
            top: 50% !important;
            
            /* í™•ëŒ€ ë¹„ìœ¨ì„ 2.5ë°°ì—ì„œ 1.8ë°° ì •ë„ë¡œ ì‚´ì§ ì¤„ì—¬ì„œ ì•ˆì •ê°ì„ ì¤ë‹ˆë‹¤. */
            transform: translate(-50%, -50%) scale(1.8) !important; 
            
            z-index: 1000;
            filter: drop-shadow(0 0 50px rgba(255, 215, 0, 0.5)); /* í›„ê´‘ ë” ê°•í•˜ê²Œ */
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        }
        /* --- [NEW] ê²°ê³¼ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #result-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px);
            z-index: 6000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.8s ease;
        }
        

        .result-window {
            width: 650px; padding: 60px;
            background: linear-gradient(145deg, rgba(25, 30, 35, 0.9), rgba(10, 12, 15, 1));
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 0 50px rgba(0,0,0,1);
            text-align: center; position: relative;
            transform: translateY(50px); transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #result-modal.active { 
            opacity: 1 !important; 
            visibility: visible !important; 
        }
        #result-modal.active .result-window { 
            transform: scale(1) !important; 
        }

        .result-subtitle { font-family: 'Cinzel', serif; color: #d4af37; letter-spacing: 0.3rem; font-size: 0.8rem; }
        .result-title { font-family: 'Nanum Myeongjo', serif; font-size: 2.2rem; color: #fff; margin-top: 10px; margin-bottom: 40px; }

        .result-content {
            font-family: 'Nanum Myeongjo', serif; color: #ccc; line-height: 2; text-align: left;
            max-height: 300px; overflow-y: auto; padding-right: 15px; margin-bottom: 40px; font-size: 1.05rem;
        }

        /* í¬ì¸íŠ¸ ì•„ì´ì½˜ ìƒ‰ìƒ ì •ì˜ */
        #result-point-up-area { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }
        .point-badge {
            padding: 8px 15px; border-radius: 20px; font-family: 'Cinzel', serif; font-size: 0.85rem;
            font-weight: bold; animation: fadeInUp 0.5s ease forwards; opacity: 0;
        }

        /* ê° ë•ëª©ë³„ ì»¬ëŸ¬ (ìœ¤í˜¸ë‹˜ì´ ì›í•˜ì‹  ëŒ€ë¡œ!) */
        .badge-courage { border: 1px solid #ff6b6b; color: #ff6b6b; box-shadow: 0 0 10px rgba(255, 107, 107, 0.2); }
        .badge-wisdom { border: 1px solid #4db8ff; color: #4db8ff; box-shadow: 0 0 10px rgba(77, 184, 255, 0.2); }
        .badge-kindness { border: 1px solid #ff85a2; color: #ff85a2; box-shadow: 0 0 10px rgba(255, 133, 162, 0.2); }
        .badge-diligence { border: 1px solid #2ecc71; color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); }
        .badge-serenity { border: 1px solid #81ecec; color: #81ecec; box-shadow: 0 0 10px rgba(129, 236, 236, 0.2); }

        #result-close-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff;
            padding: 12px 40px; font-family: 'Nanum Myeongjo', serif; cursor: pointer; transition: 0.3s;
        }
        #result-close-btn:hover { background: #fff; color: #000; border-color: #fff; }

        /* 1. ì—ë„ˆì§€ êµ¬ìŠ¬ (ë” ê°•ë ¥í•œ ë°œê´‘ê³¼ ê¼¬ë¦¬ íš¨ê³¼) */
        .energy-orb {
            position: fixed;
            width: 30px; height: 30px; /* í¬ê¸° ì•½ê°„ í‚¤ì›€ */
            background: radial-gradient(circle at 30% 30%, #fff, var(--orb-color));
            border-radius: 50%;
            z-index: 7000; pointer-events: none;
            /* í•µì‹¬: ë‹¤ì¤‘ ê·¸ë¦¼ìë¡œ ë¹› ë²ˆì§ + ê¼¬ë¦¬ íš¨ê³¼ ì—°ì¶œ */
            box-shadow: 
                0 0 20px var(--orb-color),
                0 0 40px var(--orb-color),
                0 0 80px var(--orb-color);
            opacity: 0; transform: scale(0); /* ì‹œì‘ ì „ ìˆ¨ê¹€ */
            will-change: transform, left, top; /* ì„±ëŠ¥ ìµœì í™” */
        }

        /* 2. êµ¬ìŠ¬ ì´ë™ ì• ë‹ˆë©”ì´ì…˜ (ì§ì„  -> ê³¡ì„  ëŠë‚Œì˜ ê°€ê°ì†) */
        .energy-orb.flying {
            opacity: 1; transform: scale(1);
            /* í•µì‹¬ ë² ì§€ì— ê³¡ì„ : ì²˜ìŒì—” í­ë°œì ìœ¼ë¡œ ë¹ ë¥´ë‹¤ê°€ ì¤‘ê°„ì— ì‚´ì§ ëŠë ¤ì§€ê³ ,
            ë„ì°© ì§ì „ì— ë‹¤ì‹œ ë¹ ë¥´ê²Œ ê½‚íˆëŠ” ëŠë‚Œ (ë¡œì¼“ ë°œì‚¬ ëŠë‚Œ)
            */
            transition: 
                left 1.2s cubic-bezier(0.25, 0.1, 0.25, 1.2),
                top 1.2s cubic-bezier(0.25, 0.1, 0.25, 1.2),
                transform 0.3s ease-out,
                opacity 0.3s ease-in;
        }

        .impact-ripple {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px; /* ì‘ê²Œ ì‹œì‘ */
            border-radius: 50%;
            /* ì„ ì´ ì•„ë‹ˆë¼ ë©´ìœ¼ë¡œ í¼ì§€ëŠ” ë¹›ì˜ ëŠë‚Œ */
            background: radial-gradient(circle, var(--orb-color) 0%, transparent 70%);
            filter: blur(8px); /* ëª½í™˜ì ì¸ ëŠë‚Œì„ ìœ„í•´ ë¸”ëŸ¬ ì²˜ë¦¬ */
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.8;
            pointer-events: none; z-index: 999;
        }

        .impact-ripple.active {
            /* ë” ë¹ ë¥´ê³  ìš°ì•„í•˜ê²Œ í©ì–´ì§ */
            animation: rippleBurst 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes rippleBurst {
            to { transform: translate(-50%, -50%) scale(8); opacity: 0; }
        }

        /* 2. í¬ì¸íŠ¸ í…ìŠ¤íŠ¸ (í¬ê¸° ì¶•ì†Œ ë° ê°€ë…ì„± í–¥ìƒ) */
        .floating-point {
            position: absolute; top: -30px; left: 50%;
            transform: translateX(-50%) scale(0);
            color: #fff;
            font-family: 'Cinzel', serif; 
            font-weight: 800; 
            font-size: 0.7rem; /* 2rem -> 1.1remìœ¼ë¡œ ì¶•ì†Œ */
            letter-spacing: 0.1rem;
            pointer-events: none; z-index: 1002;
            text-shadow: 0 0 10px var(--orb-color), 0 2px 4px rgba(0,0,0,0.8);
            white-space: nowrap;
        }

        /* 4. ì„¬ ë°œê´‘ (ë” ê°•ë ¬í•˜ê²Œ) */
        @keyframes island-flash-strong {
            0% { filter: brightness(1) contrast(1); transform: scale(1); }
            30% { filter: brightness(2.5) contrast(1.2) drop-shadow(0 0 50px var(--orb-color)); transform: scale(1.05); }
            100% { filter: brightness(1) contrast(1); transform: scale(1); }
        }
        .flash-effect { animation: island-flash-strong 0.7s ease-out; }

        /* ì«€ë“í•œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        .floating-point.pop {
            animation: popUpElastic 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        /* ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        .floating-point.fade {
            transition: all 0.5s ease-out;
            opacity: 0; transform: translate(-50%, -50px) scale(0.8);
        }

        @keyframes popUpElastic {
            0% { opacity: 0; transform: translate(-50%, 20px) scale(0.5); }
            60% { opacity: 1; transform: translate(-50%, -10px) scale(1.3); } /* ì‚´ì§ ì˜¤ë²„í•´ì„œ ì»¤ì§ */
            100% { opacity: 1; transform: translate(-50%, 0) scale(1); } /* ì œìë¦¬ */
        }
        /* êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ */
        .google-btn {
            background: white; border: none; padding: 10px 20px;
            display: flex; align-items: center; gap: 10px;
            border-radius: 30px; cursor: pointer;
            font-family: 'Roboto', sans-serif; font-weight: 500; color: #555;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-left: 5px; opacity: 0.9;
        }
        .google-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,255,255,0.2); opacity: 1; }
        .google-btn img { width: 20px; height: 20px; }

        /* ë‹‰ë„¤ì„ ëª¨ë‹¬ */
        #nickname-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 8000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.5s;
        }
        #nickname-modal.active { opacity: 1; visibility: visible; }
        
        .nickname-window {
            background: #1a1a1a; border: 1px solid #d4af37;
            padding: 40px; text-align: center; width: 350px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        .nickname-window h3 { color: #d4af37; font-family: 'Nanum Myeongjo'; margin-bottom: 10px; font-size: 1.5rem; }
        .nickname-window p { color: #aaa; font-family: 'Nanum Myeongjo'; margin-bottom: 25px; font-size: 0.9rem; }
        
        #nickname-input {
            width: 100%; padding: 10px; background: rgba(255,255,255,0.1);
            border: none; border-bottom: 1px solid #555; color: white;
            text-align: center; font-family: 'Nanum Myeongjo'; font-size: 1.2rem;
            margin-bottom: 30px; outline: none; transition: border 0.3s;
        }
        #nickname-input:focus { border-bottom: 1px solid #d4af37; }
        
        #nickname-submit-btn {
            background: #d4af37; color: #000; border: none;
            padding: 10px 30px; font-family: 'Nanum Myeongjo'; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        #nickname-submit-btn:hover { background: #fff; }
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            letter-spacing: 0.1rem;
            padding: 10px 15px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            color: #fff;
            border-color: #fff;
            background: rgba(255, 255, 255, 0.05);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        /* --- ì¼ê¸° ìƒì„¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #diary-detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 7000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.4s ease;
        }
        #diary-detail-modal.active { opacity: 1; visibility: visible; }

        .detail-window {
            width: 600px; height: 80vh; 
            background: linear-gradient(145deg, rgba(25, 30, 35, 0.95), rgba(10, 12, 15, 0.98));
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 50px 40px; position: relative;
            display: flex; flex-direction: column;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            transform: scale(0.95); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #diary-detail-modal.active .detail-window { transform: scale(1); }

        .detail-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-bottom: 30px; text-align: center; }
        .detail-label { font-family: 'Cinzel', serif; font-size: 0.8rem; color: #666; letter-spacing: 0.2rem; }
        #detail-date { font-family: 'Cinzel', serif; font-size: 1.8rem; color: #d4af37; margin-top: 10px; }

        .detail-scroll-area { overflow-y: auto; padding-right: 10px; flex: 1; }
        .detail-scroll-area::-webkit-scrollbar { width: 4px; }
        .detail-scroll-area::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .detail-section { margin-bottom: 40px; }
        .section-title { font-family: 'Nanum Myeongjo', serif; font-size: 0.9rem; color: #888; margin-bottom: 10px; border-left: 2px solid #555; padding-left: 10px; }
        
        .detail-text { font-family: 'Nanum Myeongjo', serif; font-size: 1.05rem; color: #ddd; line-height: 1.8; white-space: pre-wrap; }
        
        .ai-section { background: rgba(212, 175, 55, 0.05); padding: 20px; border-radius: 5px; border: 1px solid rgba(212, 175, 55, 0.1); }
        .ai-text { color: #f0e6d2; font-style: italic; }

        .stats-container { display: flex; gap: 10px; flex-wrap: wrap; }

        .menu-line {
            display: block; height: 2px; background-color: rgba(255, 255, 255, 0.8);
            border-radius: 2px; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* ì«€ë“í•œ ì›€ì§ì„ */
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        /* ë‹«í˜€ìˆì„ ë•Œ: ê°ê°ì ì¸ ë¹„ëŒ€ì¹­ ê¸¸ì´ */
        .menu-line:nth-child(1) { width: 100%; }
        .menu-line:nth-child(2) { width: 70%; }
        .menu-line:nth-child(3) { width: 40%; }

        /* í˜¸ë²„ ì‹œ: ê¸ˆìƒ‰ìœ¼ë¡œ ë¹›ë‚˜ë©° ê½‰ ì°¸ */
        #menu-toggle-btn:hover .menu-line {
            width: 100% !important; 
            background-color: #d4af37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
        }
        #menu-toggle-btn:hover { transform: scale(1.1); }

        /* [í•µì‹¬ ìˆ˜ì •] ì—´ë ¸ì„ ë•Œ (Xì): ê¸¸ì´ë¥¼ 100%ë¡œ ê°•ì œ í†µì¼í•˜ì—¬ ëŒ€ì¹­ ë§ì¶¤ */
        #menu-toggle-btn.open .menu-line { width: 100% !important; background-color: #d4af37; }
        
        /* ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ ì •í™•íˆ êµì°¨í•˜ë„ë¡ ì¢Œí‘œ ìˆ˜ì • */
        #menu-toggle-btn.open .menu-line:nth-child(1) { transform: translateY(11px) rotate(45deg); }
        #menu-toggle-btn.open .menu-line:nth-child(2) { opacity: 0; transform: translateX(-20px); } /* ê°€ìš´ë°ëŠ” íœ™ ë‚ ì•„ê° */
        #menu-toggle-btn.open .menu-line:nth-child(3) { transform: translateY(-12px) rotate(-45deg); }

        /* --- [ìˆ˜ì •ë¨] ë©”ì¸ ì‚¬ì´ë“œë°” --- */
        #main-menu-sidebar {
            position: fixed; top: 0; right: 0; width: 500px; /* ë„ˆë¹„ë¥¼ ë” ë„“ê²Œ ì¡ì•„ì„œ ê·¸ë¼ë°ì´ì…˜ êµ¬ê°„ í™•ë³´ */
            height: 100%; z-index: 8500;
            padding: 120px 60px 120px 100px; /* ì™¼ìª½ íŒ¨ë”©ì„ ëŠ˜ë ¤ì„œ ë‚´ìš©ì€ ì–´ë‘ìš´ ìª½ì— ë°°ì¹˜ */
            display: flex; flex-direction: column;
            
            /* [í•µì‹¬ ìˆ˜ì • 1] ì™¼ìª½ í…Œë‘ë¦¬ ì œê±° (ì´ê²Œ ìˆìœ¼ë©´ ê³µì¤‘ì— ì„ ë§Œ ë– ë‹¤ë‹˜) */
            border-left: none;

            /* [í•µì‹¬ ìˆ˜ì • 2] ë¶€ë“œëŸ¬ìš´ ê·¸ë¼ë°ì´ì…˜ (íƒí•´ì§€ì§€ ì•Šê²Œ rgbaê°’ í†µì¼) */
            /* ì™¼ìª½(0%)ì€ ì™„ì „ íˆ¬ëª… -> 30% ì§€ì ë¶€í„° ì„œì„œíˆ ì–´ë‘ì›Œì§ -> 70%ë¶€í„°ëŠ” ê±°ì˜ ë¶ˆíˆ¬ëª… */
            background: linear-gradient(to right, 
                rgba(5, 7, 10, 0) 0%, 
                rgba(5, 7, 10, 0.4) 30%, 
                rgba(5, 7, 10, 0.95) 70%, 
                rgba(5, 7, 10, 1) 100%
            );
            
            transform: translateX(100%); /* í‰ì†Œì—” ìˆ¨ê¹€ */
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s ease;
            
            box-shadow: none; /* ë‹«í˜€ìˆì„ ë•Œ ê·¸ë¦¼ì ì œê±° */
            opacity: 0; pointer-events: none;
        }

        /* ì—´ë ¸ì„ ë•Œ */
        #main-menu-sidebar.active { 
            transform: translateX(0); 
            opacity: 1; 
            pointer-events: auto;
            /* ì—´ë ¸ì„ ë•Œë„ ê·¸ë¦¼ìëŠ” ì œê±°í•˜ê±°ë‚˜ ì•„ì£¼ ì€ì€í•˜ê²Œ (ê·¸ë¼ë°ì´ì…˜ì´ ê·¸ë¦¼ì ì—­í•  í•¨) */
            box-shadow: none; 
        }

        .menu-header { margin-bottom: 60px; text-align: right; }
        .menu-header h2 { font-family: 'Cinzel', serif; color: #fff; font-size: 1.8rem; letter-spacing: 0.3rem; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .menu-underline { width: 100%; height: 1px; background: linear-gradient(to left, #d4af37, transparent); margin-top: 15px; }

        .menu-list { list-style: none; text-align: right; margin-right: 10px; }
        .menu-list li { margin-bottom: 30px; transform: translateX(50px); opacity: 0; transition: all 0.5s ease; }
        
        /* ìˆœì°¨ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        #main-menu-sidebar.active .menu-list li { transform: translateX(0); opacity: 1; }
        #main-menu-sidebar.active .menu-list li:nth-child(1) { transition-delay: 0.2s; }
        #main-menu-sidebar.active .menu-list li:nth-child(2) { transition-delay: 0.3s; }
        #main-menu-sidebar.active .menu-list li:nth-child(3) { transition-delay: 0.4s; }

        .menu-list a {
            color: #888; text-decoration: none; font-family: 'Nanum Myeongjo', serif; font-size: 1.2rem;
            transition: color 0.3s, transform 0.3s; display: inline-block;
        }
        .menu-list a:hover { 
            color: #d4af37; 
            transform: translateX(-10px); /* í˜¸ë²„ ì‹œ ì™¼ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™ */
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6); 
        }

        .menu-footer { margin-top: auto; text-align: right; opacity: 0.3; padding-right: 10px;}

        /* [ìˆ˜ì •] í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼: ì²˜ìŒì— ìˆ¨ê¹€ ì²˜ë¦¬ */
        #menu-toggle-btn {
            position: fixed; top: 30px; right: 40px; z-index: 9000;
            background: transparent; border: none; cursor: pointer;
            width: 35px; height: 25px;
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: flex-end;
            padding: 0;
            
            /* ì—¬ê¸°ë¶€í„° ì¶”ê°€ëœ ë¶€ë¶„: ì²˜ìŒì—” ì•ˆ ë³´ì´ê²Œ ì„¤ì • */
            opacity: 0; 
            visibility: hidden;
            pointer-events: none;
            transition: opacity 1s ease, transform 0.3s ease; /* ë‚˜íƒ€ë‚  ë•Œ ë¶€ë“œëŸ½ê²Œ */
        }

        /* [ì¶”ê°€] ì´ í´ë˜ìŠ¤ê°€ ë¶™ìœ¼ë©´ ë‚˜íƒ€ë‚¨ */
        #menu-toggle-btn.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        body.world-focused #menu-toggle-btn {
            opacity: 0;
            pointer-events: none; /* ì•ˆ ë³´ì¼ ë•Œ í´ë¦­ ì•ˆ ë˜ê²Œ ë§‰ìŒ (í•„ìˆ˜!) */
            transform: scale(0.8) rotate(90deg); /* ì‚´ì§ ì‘ì•„ì§€ê³  ëŒë©´ì„œ ì‚¬ë¼ì§€ëŠ” ì—°ì¶œ */
            transition: all 0.5s ease;
        }
        
        /* ë‹¤ì‹œ ë‚˜íƒ€ë‚  ë•Œì˜ íŠ¸ëœì§€ì…˜ë„ ë¶€ë“œëŸ½ê²Œ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° ë°©ì§€ìš©) */
        #menu-toggle-btn {
            transition: opacity 0.5s ease, transform 0.3s ease;
        }

        /* --- í”„ë¡œí•„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #profile-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 9500; /* ë©”ë‰´(8500)ë³´ë‹¤ ë†’ì•„ì•¼ í•¨ */
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.4s ease;
        }
        #profile-modal.active { opacity: 1; visibility: visible; }

        .profile-window {
            width: 450px; background: linear-gradient(135deg, #1a1c20 0%, #0f1012 100%);
            border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 2px;
            padding: 50px 40px; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transform: translateY(20px); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #profile-modal.active .profile-window { transform: translateY(0); }

        /* ìƒë‹¨ ì •ë³´ */
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .profile-icon {
            width: 70px; height: 70px; background: rgba(255,255,255,0.05);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 2rem; border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .profile-role { font-family: 'Cinzel', serif; color: #d4af37; font-size: 0.7rem; letter-spacing: 0.2rem; display: block; margin-bottom: 5px; }
        #profile-nickname { font-family: 'Nanum Myeongjo', serif; color: #fff; font-size: 2rem; margin: 0; line-height: 1; }
        .join-date { font-family: 'Cinzel', serif; color: #666; font-size: 0.8rem; margin-top: 8px; }

        .profile-divider { width: 100%; height: 1px; background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent); margin-bottom: 30px; }

        /* í†µê³„ ì˜ì—­ */
        .stats-title { font-family: 'Nanum Myeongjo', serif; color: #ddd; font-size: 1.1rem; margin-bottom: 5px; }
        .stats-desc { font-family: 'Nanum Myeongjo', serif; color: #777; font-size: 0.8rem; margin-bottom: 25px; }

        .stat-bar-group { margin-bottom: 15px; }
        .stat-label-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-family: 'Cinzel', serif; font-size: 0.8rem; color: #aaa; }
        .stat-track { width: 100%; height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; }
        .stat-fill { height: 100%; width: 0%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); border-radius: 3px; position: relative; }
        
        /* ë°”ì—ì„œ ë¹›ë‚˜ëŠ” íš¨ê³¼ */
        .stat-fill::after {
            content: ''; position: absolute; top: 0; right: 0; width: 5px; height: 100%;
            background: rgba(255,255,255,0.8); box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        /* ğŸ“± [NEW] ëª¨ë°”ì¼ ì „ìš© ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ (í™”ë©´ í­ 768px ì´í•˜ì¼ ë•Œ ì ìš©) */
        @media screen and (max-width: 768px) {
            
            /* 1. ë©”ì¸ íƒ€ì´í‹€ í¬ê¸° ì¶•ì†Œ */
            .main-title { font-size: 3rem; letter-spacing: 0.3rem; }
            .sub-title { font-size: 0.8rem; letter-spacing: 0.2rem; margin-bottom: 30px; }
            .main-content-box { margin-bottom: 15vh; }

            /* 2. ëª¨ë“  ëª¨ë‹¬ ì°½(ì¼ê¸°, ê²°ê³¼, í”„ë¡œí•„, ìƒì„¸) ë„ˆë¹„ ìµœì í™” */
            .diary-window, .result-window, .detail-window, .profile-window {
                width: 90% !important; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
                max-height: 85vh;      /* ìœ„ì•„ë˜ ì—¬ë°± í™•ë³´ */
                padding: 30px 20px;    /* ë‚´ë¶€ ì—¬ë°± ì¤„ì´ê¸° */
            }
            
            /* 3. í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ë†’ì´ ì¡°ì ˆ */
            #diary-textarea { height: 180px; }

            /* 4. ë©”ì¸ ë©”ë‰´ ì‚¬ì´ë“œë°” (í™”ë©´ ì „ì²´ ë®ê¸°) */
            #main-menu-sidebar { 
                width: 100%; 
                padding: 100px 30px; /* íŒ¨ë”© ì¡°ì • */
                background: linear-gradient(to right, rgba(5,7,10,0.9), #05070a); /* ëª¨ë°”ì¼ì€ ê°€ë…ì„± ìœ„í•´ ì¢€ ë” ì§„í•˜ê²Œ */
            }

            /* 5. ì„¬ ì •ë³´ íŒ¨ë„ (í™”ë©´ ì „ì²´ ë®ê¸°) */
            #island-info-panel { 
                width: 100%; 
                right: -100%; /* ìˆ¨ê²¨ì§„ ìœ„ì¹˜ ìˆ˜ì • */
                border-left: none; /* ëª¨ë°”ì¼ì€ ì „ì²´í™”ë©´ì´ë¼ ê²½ê³„ì„  ë¶ˆí•„ìš” */
            }
            #island-info-panel.active { right: 0; }

            /* 6. ë²„íŠ¼ë“¤ ìœ„ì¹˜ ë° í¬ê¸° ì¡°ì • */
            #menu-toggle-btn { top: 20px; right: 20px; transform: scale(0.9); }
            #diary-open-btn { bottom: 30px; right: 20px; font-size: 0.9rem; }
            .minimal-logout-btn { bottom: 20px; font-size: 0.6rem; }

            /* 7. ëª¨ë°”ì¼ì—ì„œ ë„ˆë¬´ í° ê¸€ì”¨ë“¤ ì¡°ì • */
            #tooltip-kr { font-size: 1.2rem; }
            .panel-header h2 { font-size: 2rem; }
            #profile-nickname { font-size: 1.5rem; }
        }

        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            z-index: 9600; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        #settings-modal.active { opacity: 1; visibility: visible; }

        .settings-window {
            width: 750px; /* PC: ë„“ì€ ê°€ë¡œí˜• */
            background: #151515; border: 1px solid #d4af37;
            padding: 40px 50px; position: relative; box-shadow: 0 0 60px rgba(0,0,0,0.9);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
            max-height: 90vh; /* í™”ë©´ë³´ë‹¤ í¬ë©´ ìŠ¤í¬ë¡¤ */
        }
        #settings-modal.active .settings-window { transform: scale(1); }

        .settings-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .settings-label { font-family: 'Cinzel', serif; color: #666; letter-spacing: 0.2rem; font-size: 0.8rem; }
        .settings-header h2 { font-family: 'Nanum Myeongjo', serif; color: #fff; margin-top: 10px; font-size: 1.8rem; }

        /* [í•µì‹¬] 2x2 ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (PC) */
        .settings-content {
            display: grid;
            grid-template-columns: 1fr 1fr; /* ì •í™•íˆ ë°˜ë°˜ì”© 2ì—´ */
            column-gap: 50px; /* ì¢Œìš° ê°„ê²© */
            row-gap: 30px;    /* ìƒí•˜ ê°„ê²© */
            overflow-y: auto; 
            padding-right: 10px;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .settings-content::-webkit-scrollbar { width: 4px; }
        .settings-content::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .setting-group { margin-bottom: 0; }
        
        .setting-group h3 { 
            font-family: 'Nanum Myeongjo', serif; color: #d4af37; font-size: 1.1rem; 
            margin-bottom: 15px; border-left: 3px solid #d4af37; padding-left: 10px;
        }

        /* ìŠ¬ë¼ì´ë” ë° ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .slider-container { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; color: #aaa; font-family: 'Nanum Myeongjo'; font-size: 0.85rem; margin-bottom: 5px; }
        .custom-range { -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 2px; outline: none; }
        .custom-range::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #d4af37; cursor: pointer; transition: transform 0.2s; }
        .custom-range::-webkit-slider-thumb:hover { transform: scale(1.2); box-shadow: 0 0 10px #d4af37; }

        /* í† ê¸€ ë° ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .toggle-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .toggle-label { color: #aaa; font-family: 'Nanum Myeongjo'; font-size: 0.85rem; }
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: rgba(212, 175, 55, 0.3); border: 1px solid #d4af37; }
        input:checked + .slider:before { transform: translateX(18px); background-color: #d4af37; box-shadow: 0 0 10px #d4af37; }

        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .control-label { color: #aaa; font-family: 'Nanum Myeongjo'; font-size: 0.85rem; }
        .btn-group { display: flex; gap: 5px; }
        .opt-btn { background: #222; border: 1px solid #444; color: #888; padding: 4px 10px; cursor: pointer; border-radius: 4px; font-family: 'Nanum Myeongjo'; font-size: 0.75rem; transition: all 0.3s ease; }
        .opt-btn:hover { background: #333; color: #fff; }
        .opt-btn.active { background: rgba(212, 175, 55, 0.2); border-color: #d4af37; color: #d4af37; font-weight: bold; }

        /* =========================================
           ğŸ“± [í•„ìˆ˜] ëª¨ë°”ì¼ ë°˜ì‘í˜• (CSS ë§¨ ì•„ë˜ì— ìœ„ì¹˜!)
           ========================================= */
        @media screen and (max-width: 768px) {
            
            .main-title { font-size: 3rem; letter-spacing: 0.3rem; }
            .sub-title { font-size: 0.8rem; letter-spacing: 0.2rem; margin-bottom: 30px; }
            .main-content-box { margin-bottom: 15vh; }

            /* ëª¨ë“  ëª¨ë‹¬ ì°½ ë„ˆë¹„ ìµœì í™” */
            .diary-window, .result-window, .detail-window, .profile-window, .settings-window {
                width: 90% !important; max-height: 85vh; padding: 30px 20px;
            }
            #diary-textarea { height: 180px; }

            #main-menu-sidebar { width: 100%; padding: 100px 30px; background: linear-gradient(to right, rgba(5,7,10,0.9), #05070a); }
            #island-info-panel { width: 100%; right: -100%; border-left: none; }
            #island-info-panel.active { right: 0; }

            #menu-toggle-btn { top: 20px; right: 20px; transform: scale(0.9); }
            #diary-open-btn { bottom: 30px; right: 20px; font-size: 0.9rem; }
            .minimal-logout-btn { bottom: 20px; font-size: 0.6rem; }

            #tooltip-kr { font-size: 1.2rem; }
            .panel-header h2 { font-size: 2rem; }
            #profile-nickname { font-size: 1.5rem; }

            /* [í•µì‹¬ Fix] ëª¨ë°”ì¼ì—ì„œëŠ” ì„¤ì •ì°½ ë‹¤ì‹œ 1ì—´ë¡œ ë³µê·€ */
            .settings-content {
                grid-template-columns: 1fr !important; /* ê°•ì œ 1ì—´ */
                gap: 30px;
            }
        }
        /* 1. ì‘ê²Œ (Small) */
        body.fs-small #diary-textarea,  /* ì—¬ê¸°ê°€ ìˆ˜ì •ë¨ (. -> #) */
        body.fs-small .detail-text,
        body.fs-small .result-content { 
            font-size: 1.2rem !important; line-height: 1.6; 
        }

        /* 2. ë³´í†µ (Medium) */
        body.fs-medium #diary-textarea, /* ì—¬ê¸°ê°€ ìˆ˜ì •ë¨ (. -> #) */
        body.fs-medium .detail-text,
        body.fs-medium .result-content { 
            font-size: 1.5rem !important; line-height: 1.8; 
        }

        /* 3. í¬ê²Œ (Large) */
        body.fs-large #diary-textarea,  /* ì—¬ê¸°ê°€ ìˆ˜ì •ë¨ (. -> #) */
        body.fs-large .detail-text,
        body.fs-large .result-content { 
            font-size: 2rem !important; line-height: 2.0; 
        }

        /* --- [ìµœì¢…] ì‹œë„¤ë§ˆí‹± ë¦¬í¬íŠ¸ (ì˜í™” ì˜ˆê³ í¸ ìŠ¤íƒ€ì¼) --- */
        #season-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; /* ì™„ì „ ê²€ì€ ë°°ê²½ */
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 1s ease;
        }
        #season-modal.active { opacity: 1; visibility: visible; }

        /* ë¬´ëŒ€ (ì¤‘ì•™ ì •ë ¬) */
        .cinematic-stage {
            width: 80%; height: 80%; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: white;
        }

        /* 1. ë¡œë”© */
        .season-loading { position: absolute; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 2px solid #333; border-top-color: #d4af37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }

        /* 2. ì¸íŠ¸ë¡œ (ë‚ ì§œ) */
        .intro-slide { position: absolute; opacity: 0; transform: scale(0.8); transition: all 1.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .intro-slide.active { opacity: 1; transform: scale(1); }
        .intro-year { font-family: 'Cinzel'; font-size: 1.5rem; color: #888; letter-spacing: 0.8rem; margin-bottom: 20px; }
        .intro-month { font-family: 'Cinzel'; font-size: 6rem; color: #fff; font-weight: bold; text-shadow: 0 0 40px rgba(255,215,0,0.4); }

        /* 3. ìŠ¤í† ë¦¬ (ëª…ì–¸ ìŠ¬ë¼ì´ë“œ) - 2ê°œì”© ë³´ì—¬ì£¼ê¸°ìš© ìˆ˜ì • */
        .story-slide { 
            position: absolute; opacity: 0; 
            transition: opacity 1s ease; 
            width: 100%; max-width: 800px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .story-slide.active { opacity: 1; }

        .story-virtue { 
            font-family: 'Cinzel'; font-size: 1.2rem; letter-spacing: 0.5rem; 
            margin-bottom: 50px; color: var(--virtue-color);
            border-bottom: 1px solid var(--virtue-color); padding-bottom: 10px;
            opacity: 0; transform: translateY(-20px); transition: all 1s ease;
        }
        .story-slide.active .story-virtue { opacity: 1; transform: translateY(0); }

        /* ê°œë³„ ê¸°ë¡ ë°•ìŠ¤ */
        .record-box { margin-bottom: 40px; width: 100%; text-align: center; }

        /* ìš”ì•½ í…ìŠ¤íŠ¸ (ë¨¼ì € ë“±ì¥) */
        .story-quote { 
            font-family: 'Nanum Myeongjo'; font-size: 1.6rem; line-height: 1.6; color: #eee; 
            text-shadow: 0 0 20px rgba(0,0,0,0.8); word-break: keep-all; margin-bottom: 10px;
            opacity: 0; transform: translateY(20px); transition: all 1s ease;
        }
        .story-quote.show { opacity: 1; transform: translateY(0); }

        /* ë‚ ì§œ (ë‚˜ì¤‘ì— ìŠ¤ë¥´ë¥µ) */
        .story-date {
            font-family: 'Cinzel', serif; font-size: 0.9rem; color: #d4af37;
            letter-spacing: 0.2rem; opacity: 0; transition: opacity 1.5s ease;
        }
        .story-date.show { opacity: 0.7; }

        /* 4. ì•„ì›ƒíŠ¸ë¡œ (ë²„íŠ¼) */
        .outro-slide { position: absolute; opacity: 0; transition: opacity 1.5s ease; }
        .outro-slide.active { opacity: 1; }
        #season-reset-btn {
            background: transparent; border: 1px solid #d4af37; color: #d4af37;
            padding: 20px 60px; font-family: 'Cinzel'; font-size: 1.2rem; letter-spacing: 0.3rem;
            cursor: pointer; transition: 0.5s; margin-top: 30px;
        }
        #season-reset-btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 50px #d4af37; transform: scale(1.05); }

        @keyframes spin { to { transform: rotate(360deg); } }
        #reset-confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); /* ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
            z-index: 10000; /* season-modal(9999)ë³´ë‹¤ ë†’ì•„ì•¼ í•¨ */
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #reset-confirm-modal.active { opacity: 1; visibility: visible; }

        .confirm-window {
            width: 500px;
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            border: 1px solid #d4af37;
            padding: 40px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #reset-confirm-modal.active .confirm-window { transform: scale(1); }

        .confirm-window h3 {
            font-family: 'Nanum Myeongjo', serif; font-size: 1.5rem; color: #fff;
            margin-bottom: 20px;
        }
        .confirm-window p {
            font-family: 'Nanum Myeongjo', serif; font-size: 1rem; color: #aaa;
            line-height: 1.6; margin-bottom: 40px;
        }

        .confirm-btn-group { display: flex; justify-content: center; gap: 20px; }

        #cancel-reset-btn {
            background: transparent; border: 1px solid #555; color: #888;
            padding: 12px 25px; cursor: pointer; font-family: 'Nanum Myeongjo';
            transition: 0.3s;
        }
        #cancel-reset-btn:hover { border-color: #fff; color: #fff; }

        #real-reset-btn {
            background: #d4af37; border: 1px solid #d4af37; color: #000;
            padding: 12px 25px; cursor: pointer; font-family: 'Nanum Myeongjo'; font-weight: bold;
            transition: 0.3s;
        }
        #real-reset-btn:hover { background: #fff; border-color: #fff; }
        /* 4. ì•„ì›ƒíŠ¸ë¡œ (3ì¤„ ìš”ì•½ + ìŠ¤íƒ¯) */
        .outro-slide { 
            position: absolute; opacity: 0; transition: opacity 1.5s ease; 
            width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center;
        }
        .outro-slide.active { opacity: 1; }

        .outro-title {
            font-family: 'Cinzel'; font-size: 2rem; color: #d4af37; margin-bottom: 40px;
            letter-spacing: 0.5rem; text-shadow: 0 0 20px rgba(212,175,55,0.5);
        }

        .outro-content {
            display: flex; justify-content: center; align-items: center; gap: 50px;
            width: 100%; margin-bottom: 50px;
        }

        /* 3ì¤„ ìš”ì•½ (ì™¼ìª½) */
        .outro-summary { text-align: right; flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .persona-line {
            font-family: 'Nanum Myeongjo'; font-size: 1.3rem; color: #eee;
            opacity: 0; transform: translateX(-20px); transition: all 1s ease;
        }
        .persona-line.show { opacity: 1; transform: translateX(0); }

        /* êµ¬ë¶„ì„  */
        .vertical-divider { width: 1px; height: 150px; background: linear-gradient(to bottom, transparent, #555, transparent); }

        /* ìŠ¤íƒ¯ ë¦¬ìŠ¤íŠ¸ (ì˜¤ë¥¸ìª½) */
        .outro-stats { text-align: left; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .outro-stat-item {
            font-family: 'Cinzel'; font-size: 1rem; color: #aaa;
            display: flex; align-items: center; gap: 15px;
            opacity: 0; transform: translateX(20px); transition: all 1s ease;
        }
        .outro-stat-item.show { opacity: 1; transform: translateX(0); }
        .os-val { color: var(--v-color); font-weight: bold; text-shadow: 0 0 10px var(--v-color); }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media screen and (max-width: 768px) {
            .outro-content { flex-direction: column; gap: 30px; }
            .outro-summary { text-align: center; }
            .outro-stats { text-align: center; }
            .vertical-divider { width: 100px; height: 1px; background: linear-gradient(to right, transparent, #555, transparent); }
        }

        /* --- [NEW] ì‹œë„¤ë§ˆí‹± íŠ¸ëœì§€ì…˜ ìŠ¤íƒ€ì¼ --- */
        #archive-transition-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; /* ì™„ì „ ì•”ì „ */
            z-index: 99999; /* ëª¨ë“  ê²ƒì˜ ìµœìƒë‹¨ */
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 1.2s cubic-bezier(0.16, 1, 0.3, 1); /* ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œì¸ */
        }

        #archive-transition-layer.active {
            opacity: 1; visibility: visible; pointer-events: auto;
        }

        .transition-content {
            display: flex; flex-direction: column; align-items: center;
            transform: scale(0.9); opacity: 0;
            transition: all 1s ease 0.2s; /* ë°°ê²½ë³´ë‹¤ ì‚´ì§ ëŠ¦ê²Œ ëœ¸ */
        }
        
        #archive-transition-layer.active .transition-content {
            transform: scale(1); opacity: 1;
        }

        .book-cover {
            width: 100%; height: 100%;
            border: 2px solid #d4af37; border-radius: 2px 6px 6px 2px;
            background: rgba(212, 175, 55, 0.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            position: absolute;
            animation: bookPulse 2.5s infinite ease-in-out;
        }

        .book-page {
            width: 90%; height: 94%;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            position: absolute; top: 3%; left: 5%;
            opacity: 0.3;
            animation: pageShine 3s infinite linear;
        }

        .ancient-symbol { 
            width: 60px; height: 80px; position: relative; margin-bottom: 30px; perspective: 600px; 
        }

        .book-cover {
            width: 100%; height: 100%; border: 2px solid #d4af37; border-radius: 2px 6px 6px 2px;
            background: rgba(212, 175, 55, 0.05); box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            position: absolute; 
            transform-origin: left center; /* ğŸ’¡ ì±…ë“±(ì™¼ìª½)ì„ ì¶•ìœ¼ë¡œ ì—´ë¦¬ê²Œ ê³ ì • */
            animation: bookPulse 2.5s infinite ease-in-out;
        }

        .book-page {
            width: 90%; height: 94%; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            position: absolute; top: 3%; left: 5%; 
            transform-origin: left center; /* ğŸ’¡ ì•ˆìª½ í˜ì´ì§€ë„ ê°™ì€ ì¶•ìœ¼ë¡œ ê³ ì • */
            opacity: 0; 
            animation: pageShine 2.5s infinite ease-in-out; /* ğŸ’¡ í‘œì§€ì™€ ë™ì¼í•˜ê²Œ 2.5ì´ˆ, ë¶€ë“œëŸ¬ìš´ íƒ€ì´ë°ìœ¼ë¡œ í†µì¼! */
        }

        @keyframes bookPulse {
            0%, 100% { transform: rotateY(0deg); box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); border-color: #d4af37; }
            50% { transform: rotateY(-30deg); box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); border-color: #fff; } /* ê°ë„ë¥¼ ì‚´ì§ ë” ì—´ì–´ì¤Œ */
        }

        @keyframes pageShine { 
            0%, 100% { transform: rotateY(0deg) translateX(0); opacity: 0; } 
            50% { transform: rotateY(-15deg) translateX(10px); opacity: 0.8; } /* í‘œì§€ê°€ ì—´ë¦´ ë•Œ í˜ì´ì§€ë„ ë”°ë¼ ì—´ë¦¬ë©° ë¹›ë‚¨ */
        }
        @keyframes textFade {
            from { opacity: 0.4; } to { opacity: 1; }
        }
        /* --- [NEW] ì‹œë„¤ë§ˆí‹± íŠ¸ëœì§€ì…˜ ìŠ¤íƒ€ì¼ (ì—¬ê¸°ì„œë¶€í„° ë³µì‚¬) --- */
        #archive-transition-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; /* ì™„ì „ ì•”ì „ */
            z-index: 99999; /* ëª¨ë“  UI ìœ„ì— ë®ê¸° */
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 1.2s cubic-bezier(0.16, 1, 0.3, 1); /* ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œì¸ */
        }

        /* í™œì„±í™”ë˜ì—ˆì„ ë•Œ */
        #archive-transition-layer.active {
            opacity: 1; visibility: visible; pointer-events: auto;
        }

        .transition-content {
            display: flex; flex-direction: column; align-items: center;
            transform: scale(0.9); opacity: 0;
            transition: all 1s ease 0.2s; /* ë°°ê²½ë³´ë‹¤ 0.2ì´ˆ ëŠ¦ê²Œ ëœ¸ */
        }
        
        #archive-transition-layer.active .transition-content {
            transform: scale(1); opacity: 1;
        }

        /* ê³ ëŒ€ ì‹¬ë³¼ (ë¹›ë‚˜ëŠ” ì±… ì•„ì´ì½˜) */
        .ancient-symbol {
            width: 60px; height: 80px;
            position: relative; margin-bottom: 30px;
            perspective: 600px;
        }

        .book-cover {
            width: 100%; height: 100%;
            border: 2px solid #d4af37; border-radius: 2px 6px 6px 2px;
            background: rgba(212, 175, 55, 0.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            position: absolute;
            animation: bookPulse 2.5s infinite ease-in-out;
        }

        .book-page {
            width: 90%; height: 94%;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            position: absolute; top: 3%; left: 5%;
            opacity: 0.3;
            animation: pageShine 3s infinite linear;
        }

        .transition-text {
            font-family: 'Nanum Myeongjo', serif; color: #d4af37;
            font-size: 1.1rem; letter-spacing: 0.3rem;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
            animation: textFade 2s infinite alternate;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
        @keyframes bookPulse {
            0%, 100% { transform: rotateY(0deg); box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); border-color: #d4af37; }
            50% { transform: rotateY(-15deg); box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); border-color: #fff; }
        }
        @keyframes pageShine {
            0% { transform: translateX(-10px); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateX(10px); opacity: 0; }
        }
        @keyframes textFade {
            from { opacity: 0.4; } to { opacity: 1; }
        }
        /* [ì¶”ê°€] ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .guest-btn {
            background: transparent;
            border: none;
            color: #888; /* ì€ì€í•œ íšŒìƒ‰ */
            font-family: 'Nanum Myeongjo', serif;
            font-size: 0.8rem; /* ì‘ì€ ê¸€ì”¨ */
            margin-top: 15px;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .guest-btn:hover {
            color: #d4af37; /* í˜¸ë²„ ì‹œ ê¸ˆìƒ‰ */
            text-decoration-color: #d4af37;
        }
        /* [ì¶”ê°€] ê²ŒìŠ¤íŠ¸ ëª¨ë‹¬ í™œì„±í™” ìŠ¤íƒ€ì¼ */
        #guest-warning-modal.active {
            opacity: 1 !important;
            visibility: visible !important;
        }
        #guest-warning-modal.active .warning-window {
            transform: scale(1) !important;
        }
        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        #btn-guest-cancel:hover { border-color: #fff; color: #fff; }
        #btn-guest-confirm:hover { background: #fff; border-color: #fff; }
        #limit-modal.active { opacity: 1 !important; visibility: visible !important; pointer-events: auto; }
        #limit-modal.active .limit-window { transform: scale(1) !important; }

        /* ê´‘ê³  ë”ë¯¸ ë°•ìŠ¤ (ê°œë°œìš©) */
        .ad-placeholder {
            width: 100%;
            height: 60px; /* ëª¨ë°”ì¼ ë°°ë„ˆ í‘œì¤€ ë†’ì´ */
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(212, 175, 55, 0.3);
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
        }

        .ad-placeholder span {
            font-family: 'Cinzel', serif;
            color: rgba(212, 175, 55, 0.4);
            font-size: 0.7rem;
            letter-spacing: 0.2rem;
        }

        #loading-ad-modal.active { 
            opacity: 1 !important; 
            visibility: visible !important; 
            pointer-events: auto; 
        }
        /* ğŸ”¥ 1. íˆ¬ëª…í•œ í´ë¦­ ë°©íŒ¨ (í´ë¦­ì€ ì–˜ê°€ ë‹¤ ë§‰ìŒ) ğŸ”¥ */
        #tutorial-blocker {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 1499;
            background: transparent;
            pointer-events: none; /* êº¼ì ¸ìˆì„ ë• í†µê³¼ */
            display: none;
        }
        #tutorial-blocker.active {
            display: block;
            pointer-events: auto; /* ì¼œì§€ë©´ ë‹¤ë¥¸ ëª¨ë“  í´ë¦­ ì™„ë²½ ì°¨ë‹¨ */
        }
        #tutorial-blocker.modal-top { z-index: 2499 !important; }

        /* ğŸ”¥ 2. ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ì‹œê° íš¨ê³¼ (ë¶€ë“œëŸ¬ìš´ ë¹„ë„¤íŒ…ê³¼ ì´ë™) ğŸ”¥ */
        #tutorial-overlay {
            position: fixed;
            z-index: 1500;
            border-radius: 50%;
            /* í•µì‹¬: ì¡°ëª… ê°€ì¥ìë¦¬ì— ê°•í•œ ê¸ˆë¹› ê¸€ë¡œìš° + ë°”ê¹¥ìª½ì€ ì™„ì „ ì•”ì „ */
            box-shadow: 
                0 0 0 9999px rgba(0, 0, 0, 0.85), /* ë°”ê¹¥ ì–´ë‘  */
                0 0 30px 15px rgba(212, 175, 55, 0.4), /* ì¡°ëª… í…Œë‘ë¦¬ ê¸ˆë¹› ê´‘ì±„ */
                inset 0 0 50px rgba(212, 175, 55, 0.2); /* ì•ˆìª½ì—ë„ ì‚´ì§ ì˜¨ê¸° ì¶”ê°€ */
            pointer-events: none !important;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            transform: translate(-50%, -50%);
        }
        #tutorial-overlay.active { opacity: 1; }
        #tutorial-overlay.modal-top { z-index: 2500 !important; }

        /* ğŸ”¥ 3. 1ë‹¨ê³„ ë²„íŠ¼ë§Œ ë°©íŒ¨ ìœ„ë¡œ êº¼ë‚´ì£¼ëŠ” ë§ˆë²•ì˜ í´ë˜ìŠ¤ ğŸ”¥ */
        .tut-z-up {
            z-index: 3000 !important; 
            /* UIê°€ ë’¤í‹€ë¦¬ì§€ ì•Šê²Œ positionì€ ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ! */
        }

        .tutorial-msg {
            position: fixed;
            z-index: 1501;
            width: 280px; /* ë„ˆë¹„ë¥¼ ê³ ì •í•˜ì„¸ìš”! */
            display: flex;
            flex-direction: column;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease; /* ìœ„ì¹˜ ì´ë™ ì• ë‹ˆë©”ì´ì…˜ì€ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì–´ì§€ëŸ¬ìš°ë‹ˆ opacityë§Œ */
        }
        .tutorial-msg.active { opacity: 1; transform: translateY(0); }
        .tutorial-msg.modal-top { z-index: 2501 !important; }

        .tut-title { font-family: 'Nanum Myeongjo', serif; color: #d4af37; font-size: 1.5rem; margin-bottom: 10px; text-shadow: 0 0 15px rgba(212, 175, 55, 0.8); }
        .tut-desc { font-family: 'Nanum Myeongjo', serif; color: #ccc; font-size: 1rem; line-height: 1.6; }

        /* NEXT ë²„íŠ¼ */
        #tutorial-next-btn {
            position: fixed; bottom: 50px; right: 50px; z-index: 3000;
            background: rgba(10, 12, 15, 0.95); border: 1px solid #d4af37; color: #d4af37;
            font-family: 'Cinzel', serif; font-size: 1.1rem; letter-spacing: 0.2rem;
            padding: 12px 30px; cursor: pointer; opacity: 0; visibility: hidden;
            transition: all 0.4s ease; box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }
        #tutorial-next-btn.active { opacity: 1; visibility: visible; pointer-events: auto; }
        #tutorial-next-btn:hover { background: rgba(212, 175, 55, 0.1); color: #fff; box-shadow: 0 0 30px rgba(212, 175, 55, 0.5); }
                
        .tut-desc {
            word-break: keep-all; /* ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆë˜ì–´ ê¹”ë”í•´ì§ */
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <audio id="sfx-hover" src="SFX/hover.mp3"></audio>
    <audio id="sfx-ending" src="SFX/ending.mp3" loop></audio>
    <audio id="sfx-click" src="SFX/click.mp3"></audio>
    <audio id="sfx-clear" src="SFX/cloud_clear.mp3"></audio>
    <audio id="sfx-ambiance" src="SFX/ambiance.mp3" loop></audio>
    <audio id="sfx-result" src="SFX/result.mp3"></audio>
    <audio id="sfx-hit" src="SFX/hit.mp3"></audio>
    <audio id="sfx-tut-1" src="SFX/tut_early.mp3"></audio> <audio id="sfx-tut-2" src="SFX/tut_mid.mp3"></audio>   <audio id="sfx-tut-3" src="SFX/tut_late.mp3"></audio> <div id="tutorial-blocker"></div> <div id="tutorial-overlay"></div>
    <div id="tutorial-text" class="tutorial-msg">
        <span class="tut-title">ì •ì›ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</span>
        <span class="tut-desc">ë¨¼ì €, ìš°ì¸¡ í•˜ë‹¨ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¹ì‹ ì˜ ì²« ì´ì•¼ê¸°ë¥¼ ì‹¬ì–´ë³´ì„¸ìš”.</span>
    </div>

    <button id="tutorial-next-btn">NEXT â¯</button>

    <div id="dev-panel">
        <h3>ğŸŒ± ì •ì›ì‚¬ ëª¨ë“œ (Point Controller)</h3>
        <div class="control-group">
            <label>ìš©ê¸° (Courage) <span id="val-courage" class="val-display">0</span></label>
            <input type="range" id="rng-courage" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>ì§€í˜œ (Wisdom) <span id="val-wisdom" class="val-display">0</span></label>
            <input type="range" id="rng-wisdom" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>ì¹œì ˆ (Kindness) <span id="val-kindness" class="val-display">0</span></label>
            <input type="range" id="rng-kindness" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>ì„±ì‹¤ (Diligence) <span id="val-diligence" class="val-display">0</span></label>
            <input type="range" id="rng-diligence" min="0" max="160" value="0">
        </div>
        <div class="control-group">
            <label>í‰ì˜¨ (Serenity) <span id="val-serenity" class="val-display">0</span></label>
            <input type="range" id="rng-serenity" min="0" max="160" value="0">
        </div>
        <div style="font-size: 10px; color:#888; margin-top:5px;">* ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ ì„¬ì„ ì§„í™”ì‹œí‚¤ì„¸ìš”.</div>
    </div>

    <div id="cursor-tooltip">
        <div class="tooltip-line"></div>
        <div id="tooltip-kr">í•œê¸€ ì´ë¦„</div>
        <div id="tooltip-en">English Name</div>
        <div class="tooltip-level" id="tooltip-lvl">Lv. 1</div>
    </div>

    <div id="hud-layer">
        <div id="hud-line"></div>
        <div id="hud-text-group">
            <div id="hud-date">...</div>
            <div id="hud-time">00:00</div>
        </div>
    </div>

    <div id="world-container">
        <div id="sky-bg"></div>
        <div id="stars-container"></div>
        <div id="cloud-floor"></div>
        <canvas id="particle-canvas"></canvas>

        <div id="islands-container">
            <div id="island-wisdom" class="scene-object island" 
                 data-depth="0.02" data-base-x="42" data-base-y="38" 
                 data-name-en="Wisdom" data-name-kr="ì§€í˜œ" data-type="wisdom" data-points="0">
                <img id="img-wisdom" src="images/island_wisdom_1.png" alt="ì§€í˜œ">
            </div>

            <div id="island-serenity" class="scene-object island" 
                 data-depth="0.02" data-base-x="58" data-base-y="38" 
                 data-name-en="Serenity" data-name-kr="í‰ì˜¨" data-type="serenity" data-points="0">
                <img id="img-serenity" src="images/island_serenity_1.png" alt="í‰ì˜¨">
            </div>

            <div id="island-courage" class="scene-object island" 
                 data-depth="0.04" data-base-x="38" data-base-y="45" 
                 data-name-en="Courage" data-name-kr="ìš©ê¸°" data-type="courage" data-points="0">
                <img id="img-courage" src="images/island_courage_1.png" alt="ìš©ê¸°">
            </div>

            <div id="island-diligence" class="scene-object island" 
                 data-depth="0.04" data-base-x="62" data-base-y="45" 
                 data-name-en="Diligence" data-name-kr="ì„±ì‹¤" data-type="diligence" data-points="0">
                <img id="img-diligence" src="images/island_diligence_1.png" alt="ì„±ì‹¤">
            </div>

            <div id="island-kindness" class="scene-object island" 
                 data-depth="0.07" data-base-x="50" data-base-y="50" 
                 data-name-en="Kindness" data-name-kr="ì¹œì ˆ" data-type="kindness" data-points="0">
                <img id="img-kindness" src="images/island_kindness_1.png" alt="ì¹œì ˆ">
            </div>
        </div>
    </div>

    <div id="ui-layer">
        <div class="title-group">
            <h1 class="main-title">ê¸€ìˆ²</h1>
            <h2 class="sub-title">ê¸€ì´ ì •ì›ì„ ë§Œë“¤ë‹¤</h2>
        </div>
        
        <button id="google-login-btn" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
            <span>Googleë¡œ ì‹œì‘í•˜ê¸°</span>
        </button>

        <button id="guest-login-btn" class="guest-btn">
            Guest Loginìœ¼ë¡œ í•˜ê¸°
        </button>

        <button id="enter-btn" class="enter-btn" style="display: none;">ì •ì› ë“¤ì–´ê°€ê¸°</button>
        
        <button id="logout-btn" class="logout-btn" style="display: none;">LOGOUT</button>
        
        <div id="user-greeting" style="color:white; margin-top:15px; font-family:'Nanum Myeongjo'; opacity:0;"></div>
    </div>

    <div id="nickname-modal">
        <div class="nickname-window">
            <h3>ì´ë¦„ ë“±ë¡</h3>
            <p>ì´ ì •ì›ì˜ ì£¼ì¸ì¸ ë‹¹ì‹ ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”? (ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ì£¼ì„¸ìš”, ë³€ê²½ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤)</p>
            <input type="text" id="nickname-input" placeholder="ìµœëŒ€ 8ê¸€ì" maxlength="8">
            <button id="nickname-submit-btn">ì •ì›ì‚¬ì—ê²Œ ì´ë¦„ ì•Œë ¤ì£¼ê¸°</button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="settings-window">
            <span class="close-modal" id="settings-close-x">âœ•</span>
            
            <div class="settings-header">
                <span class="settings-label">SYSTEM CONFIG</span>
                <h2>ì •ì› ì„¤ì •</h2>
            </div>

            <div class="settings-content">
                
                <div class="setting-group">
                    <h3>ğŸ”Š ì‚¬ìš´ë“œ (Audio)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>ë°°ê²½ìŒ (BGM & Nature)</span> <span id="disp-bgm">20%</span>
                        </div>
                        <input type="range" id="vol-bgm" class="custom-range" min="0" max="1" step="0.01" value="0.25">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>íš¨ê³¼ìŒ (SFX)</span>
                            <span id="disp-sfx">50%</span>
                        </div>
                        <input type="range" id="vol-sfx" class="custom-range" min="0" max="1" step="0.05" value="0.5">
                    </div>
                </div> <div class="setting-group">
                    <h3>âœ¨ ê·¸ë˜í”½ (Graphics)</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>ì…ì íš¨ê³¼ (Particles)</span>
                            <span id="disp-particle">ë§ìŒ (High)</span>
                        </div>
                        <input type="range" id="opt-particle" class="custom-range" min="0" max="2" step="1" value="2">
                    </div>
                    <div class="toggle-container">
                        <span class="toggle-label">ì‹œì  í”ë“¤ë¦¼ íš¨ê³¼ (Parallax)</span>
                        <label class="switch">
                            <input type="checkbox" id="opt-parallax" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>ğŸ¨ í™”ë©´ (Display)</h3>
                    <div class="control-row">
                        <span class="control-label">ê¸€ì í¬ê¸° (Font Size)</span>
                        <div class="btn-group" id="font-group">
                            <button class="opt-btn" data-val="small">ì‘ê²Œ</button>
                            <button class="opt-btn active" data-val="medium">ë³´í†µ</button>
                            <button class="opt-btn" data-val="large">í¬ê²Œ</button>
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ì‹œê°„ í…Œë§ˆ (Time Theme)</span>
                        <div class="btn-group" id="theme-group">
                            <button class="opt-btn active" data-val="auto">ìë™</button>
                            <button class="opt-btn" data-val="day">í•­ìƒ ë‚®</button>
                            <button class="opt-btn" data-val="night">í•­ìƒ ë°¤</button>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>ğŸ’¾ ë°ì´í„° (Data)</h3>
                    <div class="control-row">
                        <span class="control-label">ì¼ê¸° ë°±ì—… (Backup)</span>
                        <button id="btn-backup" class="opt-btn" style="width: auto; padding: 8px 15px;">
                            í…ìŠ¤íŠ¸ë¡œ ë‚´ë³´ë‚´ê¸° (.txt)
                        </button>
                    </div>
                    <p style="color: #666; font-family: 'Nanum Myeongjo'; font-size: 0.8rem; margin-top: 5px;">
                        * ì‘ì„±í•œ ëª¨ë“  ì¼ê¸°ì™€ ì •ì›ì‚¬ì˜ ë‹µì¥ì„ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <button id="menu-toggle-btn">
        <span class="menu-line"></span>
        <span class="menu-line"></span>
        <span class="menu-line"></span>
    </button>

    <aside id="main-menu-sidebar">
        <div class="menu-header">
            <h2>SYSTEM</h2>
            <div class="menu-underline"></div>
        </div>
        
        <ul class="menu-list">
            <li><a href="#">ë‚´ í”„ë¡œí•„ (Profile)</a></li>
            <li><a href="#">ì •ì› ì„¤ì • (Settings)</a></li>
            <li><a href="#" id="menu-archive-btn">ì—­ì‚¬ê´€ (Archives)</a></li>
            <li><a href="#">ë„ì›€ë§ (Help)</a></li>
            </ul>

        <div class="menu-footer">
            <span style="font-family: 'Cinzel'; font-size: 0.7rem; color: #555;">GEULSEUP v1.0</span>
        </div>
    </aside>
    
    <aside id="island-info-panel">
        <button id="panel-close-btn">âœ•</button>
        
        <div class="panel-header">
            <h2 id="panel-title-kr">ì§€í˜œì˜ ì •ì›</h2>
            <h3 id="panel-title-en">Garden of Wisdom</h3>
        </div>

        <div class="panel-stats">
            <div class="stat-row">
                <span class="stat-label">CURRENT LEVEL</span>
                <span class="stat-value" id="panel-lvl">Lv. 3</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">TOTAL POINTS</span>
                <span class="stat-value" id="panel-pts">450</span>
            </div>
            <div class="stat-bar-bg"><div id="panel-progress-bar" class="stat-bar-fill"></div></div>
        </div>

        <div class="panel-divider"></div>

        <div class="panel-history">
            <h4>ê¸°ë¡ëœ ì–‘ë¶„ (Diary Log)</h4>
            <ul id="panel-diary-list">
                </ul>
        </div>
    </aside>

    <button id="diary-open-btn">
        WRITE DIARY
        <div class="btn-line"></div>
    </button>

    <div id="diary-modal">
        <div class="diary-window">
            <span class="close-modal" id="diary-close-x">âœ•</span>
            <div class="diary-header">
                <div id="diary-date-display">2024. 05. 21. TUE</div>
            </div>
            
            <textarea id="diary-textarea" placeholder="ì˜¤ëŠ˜ì˜ ì¼ë“¤ì„ ê¸°ë¡í•˜ì„¸ìš”... (30ì ~ 200ì)"></textarea>
            
            <div class="char-counter" id="char-count-info">0 / 200</div>
            
            <button id="diary-submit" class="diary-submit-btn" disabled>ë‚˜ë¬´ ì‹¬ê¸° (ê¸°ë¡)</button>
        </div>
    </div>
    <div id="limit-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:8000; display:flex; justify-content:center; align-items:center; opacity:0; visibility:hidden; transition:all 0.4s ease;">
        <div class="limit-window" style="width:450px; padding:50px 40px; background:linear-gradient(145deg, #15151a, #0b0b0e); border:1px solid #4db8ff; text-align:center; box-shadow: 0 0 50px rgba(77,184,255,0.2); position:relative; transform:scale(0.9); transition:transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);">
            <span class="close-modal" id="limit-close-x">âœ•</span>
            <div style="font-family:'Cinzel'; color:#4db8ff; font-size:0.8rem; letter-spacing:0.3rem; margin-bottom:20px;">LIMIT REACHED</div>
            <h3 style="font-family:'Nanum Myeongjo'; font-size:1.6rem; color:#fff; margin-bottom:20px; line-height:1.4;">ì˜¤ëŠ˜ì˜ ì •ì› ê°€ê¾¸ê¸°ëŠ”<br>ì—¬ê¸°ê¹Œì§€ì…ë‹ˆë‹¤.</h3>
            <p style="font-family:'Nanum Myeongjo'; font-size:0.95rem; color:#aaa; line-height:1.8;">
                ì •ì›ì´ ì–‘ë¶„ì„ í¡ìˆ˜í•  ì‹œê°„ì´ í•„ìš”í•´ìš”.<br>ë‚´ì¼ ë‹¤ì‹œ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”.
            </p>
        </div>
    </div>
    <div id="result-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(15px); z-index:6000; display:flex; justify-content:center; align-items:center; opacity:0; visibility:hidden; transition:all 0.8s ease;">
        <div class="result-window" style="width:650px; padding:60px; background:linear-gradient(145deg, rgba(25,30,35,0.9), rgba(10,12,15,1)); border:1px solid rgba(212,175,55,0.3); box-shadow:0 0 50px rgba(0,0,0,1); text-align:center; transform:scale(0.9); transition:transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);">
            
            <div id="result-loading-area" style="display:flex; flex-direction:column; align-items:center; padding: 40px 0;">
                <div class="spinner" style="margin-bottom: 25px;"></div>
                <div style="font-family:'Nanum Myeongjo'; color:#d4af37; font-size:1.3rem; line-height:1.6;">
                    ì •ì›ì‚¬ê°€ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼<br>ì‹ ì¤‘í•˜ê²Œ ì½ê³  ìˆìŠµë‹ˆë‹¤...
                </div>
            </div>

            <div id="result-content-area" style="display:none;">
                <div class="result-header">
                    <span class="result-subtitle">THE GARDENER'S INSIGHT</span>
                    <h2 class="result-title">ì •ì›ì‚¬ì˜ ë‹µì¥</h2>
                </div>
                <div class="result-content" id="result-comment"></div>
                <div class="result-footer">
                    <div id="result-point-up-area" style="display:flex; justify-content:center; gap:15px; margin-bottom:40px; flex-wrap:wrap;"></div>
                    <button id="result-close-btn" style="background:transparent; border:1px solid rgba(255,255,255,0.2); color:#fff; padding:12px 40px; font-family:'Nanum Myeongjo'; cursor:pointer; transition:0.3s;">ì •ì›ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </div>

        </div>
    </div>

    <div id="loading-ad-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9000; display:flex; justify-content:center; align-items:center; opacity:0; visibility:hidden; transition:all 0.4s ease;">
        <div style="width: 300px; height: 250px; background: rgba(255,255,255,0.05); border: 1px dashed rgba(212,175,55,0.3); display:flex; justify-content:center; align-items:center; position: relative; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.8);">
            <span style="font-family:'Cinzel'; color:rgba(212,175,55,0.5); font-size:0.8rem; letter-spacing:0.2rem;">ADVERTISEMENT</span>
            
            <button id="ad-close-btn" style="position:absolute; top:-40px; right:0; background:transparent; border:none; color:#888; font-family:'Cinzel'; font-size:1rem; cursor:not-allowed; pointer-events:none; transition:all 0.3s;">
                Wait... 5
            </button>
        </div>
    </div>

    <div id="profile-modal">
        <div class="profile-window">
            <span class="close-modal" id="profile-close-x">âœ•</span>
            
            <div class="profile-header">
                <div class="profile-icon">ğŸ§™â€â™‚ï¸</div> <div class="profile-info">
                    <span class="profile-role">GARDEN MASTER</span>
                    <h2 id="profile-nickname">ì—¬í–‰ì</h2>
                    <p id="profile-join-date" class="join-date">Since 2024. 05. 21.</p>
                </div>
            </div>

            <div class="profile-divider"></div>

            <div class="profile-stats-area">
                <h3 class="stats-title">ì´ë²ˆ ë‹¬ì˜ ì„±ì¥ (Monthly Growth)</h3>
                <p class="stats-desc">ì´ë²ˆ ë‹¬, ë‹¹ì‹ ì˜ ë§ˆìŒì† ì •ì›ì—ì„œ ìë¼ë‚œ ê¸°ìš´ë“¤ì…ë‹ˆë‹¤.</p>
                
                <div id="monthly-stat-container">
                    </div>
            </div>
        </div>
    </div>

    <div id="diary-detail-modal">
        <div class="detail-window">
            <span class="close-modal" id="detail-close-x">âœ•</span>
            
            <div class="detail-header">
                <span class="detail-label">ARCHIVED MEMORY</span>
                <h2 id="detail-date">2024. 05. 21. TUE</h2>
            </div>

            <div class="detail-scroll-area">
                <div class="detail-section">
                    <div class="section-title">ë‚˜ì˜ ê¸°ë¡</div>
                    <p id="detail-content" class="detail-text">ì¼ê¸° ë‚´ìš©ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤...</p>
                </div>

                <div class="detail-section ai-section">
                    <div class="section-title">ì •ì›ì‚¬ì˜ ë‹µì¥ ğŸŒ¿</div>
                    <p id="detail-ai-reply" class="detail-text ai-text">ì •ì›ì‚¬ì˜ ë‹µë³€ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤...</p>
                </div>

                <div class="detail-section">
                    <div class="section-title">ì„±ì¥í•œ ê¸°ìš´</div>
                    <div id="detail-stats" class="stats-container">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="reset-confirm-modal">
        <div class="confirm-window">
            <h3>ìƒˆë¡œìš´ ì›”ì„ ë§ì´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
            <p>
                ì§€ë‚œë‹¬ì˜ ëª¨ë“  ê¸°ë¡ì€ ì—­ì‚¬ê´€ì— ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.<br>
                ì •ì›ì˜ ì–‘ë¶„ì€ ì´ˆê¸°í™”ë˜ì–´ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì‹¬ì„ ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.
            </p>
            <div class="confirm-btn-group">
                <button id="cancel-reset-btn">ì ì‹œë§Œìš” (ì·¨ì†Œ)</button>
                <button id="real-reset-btn">ë„¤, ì‹œì‘í•©ë‹ˆë‹¤ (í™•ì¸)</button>
            </div>
        </div>
    </div>

    <div id="season-modal">
        <div class="cinematic-stage">
            
            <div id="cine-loading" class="season-loading">
                <div class="spinner"></div>
                <div style="font-family:'Nanum Myeongjo'; margin-top:15px; color:#888;">ê¸°ë¡ì„ ì—®ëŠ” ì¤‘...</div>
            </div>

            <div id="cine-intro" class="intro-slide">
                <div class="intro-year" id="cine-year">2024</div>
                <div class="intro-month" id="cine-month">MAY</div>
            </div>

            <div id="cine-story" class="story-slide">
                <div id="cine-virtue" class="story-virtue">WISDOM</div>
                <div id="cine-quote" class="story-quote">"ì¹¨ë¬µ ì†ì—ì„œ ì§€í˜œëŠ” ìë¼ë‚©ë‹ˆë‹¤."</div>
            </div>

            <div id="cine-outro" class="outro-slide">
                <h2 class="outro-title">THE MONTHLY REPORT</h2>
                
                <div class="outro-content">
                    <div class="outro-summary">
                        <div class="persona-line" id="persona-1">...</div>
                        <div class="persona-line" id="persona-2">...</div>
                        <div class="persona-line" id="persona-3">...</div>
                    </div>

                    <div class="vertical-divider"></div>

                    <div class="outro-stats" id="outro-stats-list">
                        </div>
                </div>

                <button id="season-reset-btn">BEGIN NEW SEASON</button>
            </div>

        </div>
    </div>
    <div id="archive-transition-layer">
        <div class="transition-content">
            <div class="ancient-symbol">
                <div class="book-cover"></div>
                <div class="book-page"></div>
            </div>
            <div class="transition-text">ê¸°ì–µì˜ ì„œê³ ë¥¼ ì—¬ëŠ” ì¤‘...</div>
        </div>
    </div>

    <div id="season-notice-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:11000; display:flex; justify-content:center; align-items:center; opacity:0; visibility:hidden; transition:0.5s;">
        <div style="width:450px; padding:50px; background:linear-gradient(145deg, #15151a, #0b0b0e); border:1px solid #d4af37; text-align:center; box-shadow: 0 0 60px rgba(0,0,0,0.9); position:relative;">
            <div style="font-family:'Cinzel'; color:#d4af37; font-size:0.9rem; letter-spacing:0.3rem; margin-bottom:20px;">NEW SEASON ARRIVED</div>
            <h3 style="font-family:'Nanum Myeongjo'; font-size:1.6rem; color:#fff; margin-bottom:30px; line-height:1.4;">ìƒˆë¡œìš´ ë‹¬ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</h3>
            <p style="font-family:'Nanum Myeongjo'; font-size:1rem; color:#aaa; line-height:1.8; margin-bottom:40px;">
                ì§€ë‚œë‹¬ì˜ ì†Œì¤‘í•œ ê¸°ì–µë“¤ì´ ì •ì›ì— ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.<br>
                ì •ì›ì‚¬ê°€ ë‹¹ì‹ ì„ ìœ„í•´ ì›”ê°„ ë¦¬í¬íŠ¸ë¥¼ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.<br>
                ì§€ê¸ˆ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
            <div style="display:flex; justify-content:center; gap:15px;">
                <button id="btn-season-later" style="background:transparent; border:1px solid #555; color:#888; padding:12px 30px; cursor:pointer; font-family:'Nanum Myeongjo'; transition:0.3s;">ë‚˜ì¤‘ì—</button>
                <button id="btn-season-now" style="background:#d4af37; border:1px solid #d4af37; color:#000; padding:12px 30px; cursor:pointer; font-family:'Nanum Myeongjo'; font-weight:bold; transition:0.3s;">ì§€ê¸ˆ ì—®ê¸°</button>
            </div>
        </div>
    </div>

    <div id="guest-warning-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(5px); z-index:12000; display:flex; justify-content:center; align-items:center; opacity:0; visibility:hidden; transition:all 0.3s ease;">
        <div class="warning-window" style="width:500px; padding:50px; background:linear-gradient(145deg, #1a1a20, #0b0b0e); border:1px solid #d4af37; text-align:center; box-shadow: 0 0 60px rgba(0,0,0,0.9); transform:scale(0.9); transition:transform 0.3s ease;">
            <div style="font-family:'Cinzel'; color:#d4af37; font-size:0.9rem; letter-spacing:0.3rem; margin-bottom:20px;">GUEST ENTRY</div>
            <h3 style="font-family:'Nanum Myeongjo'; font-size:1.6rem; color:#fff; margin-bottom:30px; line-height:1.4;">ì†ë‹˜ìœ¼ë¡œ ì…ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
            <p style="font-family:'Nanum Myeongjo'; font-size:1rem; color:#aaa; line-height:1.8; margin-bottom:40px;">
                âš ï¸ <strong>ì£¼ì˜:</strong> ê²ŒìŠ¤íŠ¸ ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.<br>
                ì¸í„°ë„· ê¸°ë¡ ì‚­ì œë‚˜ ë¸Œë¼ìš°ì € ë³€ê²½ ì‹œ<br>
                <span style="color:#ff6b6b;">ì†Œì¤‘í•œ ê¸°ë¡ì´ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
            </p>
            <div style="display:flex; justify-content:center; gap:15px;">
                <button id="btn-guest-cancel" style="background:transparent; border:1px solid #555; color:#888; padding:12px 30px; cursor:pointer; font-family:'Nanum Myeongjo'; transition:0.3s;">ëŒì•„ê°€ê¸°</button>
                <button id="btn-guest-confirm" style="background:#d4af37; border:1px solid #d4af37; color:#000; padding:12px 30px; cursor:pointer; font-family:'Nanum Myeongjo'; font-weight:bold; transition:0.3s;">ë„¤, ì…ì¥í•©ë‹ˆë‹¤</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('particle-canvas');
        const tutBlocker = document.getElementById('tutorial-blocker');
        const tutNextBtn = document.getElementById('tutorial-next-btn');
        const ctx = canvas.getContext('2d');
        const worldContainer = document.getElementById('world-container');
        const uiLayer = document.getElementById('ui-layer');
        const enterBtn = document.getElementById('enter-btn');
        const islandElements = document.querySelectorAll('.island'); 
        const cloudFloor = document.getElementById('cloud-floor');
        const hudLayer = document.getElementById('hud-layer'); 
        const islandsContainer = document.getElementById('islands-container');
        const skyBg = document.getElementById('sky-bg');
        const starsContainer = document.getElementById('stars-container');
        const tooltip = document.getElementById('cursor-tooltip');
        const tooltipEn = document.getElementById('tooltip-en');
        const tooltipKr = document.getElementById('tooltip-kr');
        const tooltipLvl = document.getElementById('tooltip-lvl'); // ë ˆë²¨ íˆ´íŒ
        const devPanel = document.getElementById('dev-panel'); // ê°œë°œì íŒ¨ë„
        const detailModal = document.getElementById('diary-detail-modal');
        const detailCloseX = document.getElementById('detail-close-x');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const helpLink = document.querySelector('.menu-list li:nth-child(4) a'); // 'ë„ì›€ë§'ì´ 4ë²ˆì§¸ ë¦¬ìŠ¤íŠ¸ì¼ ê²½ìš°
        const mainMenuSidebar = document.getElementById('main-menu-sidebar');
        const profileModal = document.getElementById('profile-modal');
        const profileCloseX = document.getElementById('profile-close-x');
        const profileLink = document.querySelector('.menu-list li:first-child a');
        const logoutBtn = document.getElementById('logout-btn');
        let isTutorialMode = false;
        let currentTargetForTutorial = null;
        let currentTutorialData = { title: "", desc: "" };
        let tutorialStep = 0;
        const tutOverlay = document.getElementById('tutorial-overlay');
        const tutText = document.getElementById('tutorial-text');

        const audioHover = document.getElementById('sfx-hover');
        const audioClick = document.getElementById('sfx-click');
        const audioClear = document.getElementById('sfx-clear');
        const audioAmbiance = document.getElementById('sfx-ambiance');
        const hudDate = document.getElementById('hud-date');
        const hudTime = document.getElementById('hud-time');
        const guestWarningModal = document.getElementById('guest-warning-modal');
        const btnGuestConfirm = document.getElementById('btn-guest-confirm');
        const btnGuestCancel = document.getElementById('btn-guest-cancel');

        let width, height; // ë³€ìˆ˜ë¥¼ ë¨¼ì € ë§Œë“­ë‹ˆë‹¤.
        function resize() { 
            width = window.innerWidth; 
            height = window.innerHeight; 
            canvas.width = width; 
            canvas.height = height; 
        }
        window.addEventListener('resize', resize); 
        resize(); // ì¦‰ì‹œ ì‹¤í–‰í•´ì„œ widthê°’ì„ ì±„ì›Œë„£ìŠµë‹ˆë‹¤.

        if (helpLink) {
            helpLink.addEventListener('click', (e) => {
                e.preventDefault(); // í˜ì´ì§€ ì´ë™ ë°©ì§€
                playSfx('sfx-click');

                // 1. ì‚¬ì´ë“œë°”ì™€ ë©”ë‰´ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™” (ë‹«ê¸°)
                mainMenuSidebar.classList.remove('active');
                menuToggleBtn.classList.remove('open');

                // 2. ë§Œì•½ ì´ë¯¸ íŠœí† ë¦¬ì–¼ ì™„ë£Œ ìƒíƒœì˜€ë”ë¼ë„ ê°•ì œë¡œ ë‹¤ì‹œ ì‹œì‘
                // (localStorage ê°’ì€ ì§€ìš°ì§€ ì•Šì•„ë„ í•¨ìˆ˜ë§Œ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤)
                setTimeout(() => {
                    startTutorialStep1(); 
                }, 500); // ë©”ë‰´ê°€ ë‹«íˆëŠ” ì• ë‹ˆë©”ì´ì…˜ ë’¤ì— ì‹œì‘
            });
        }

        // --- ìš”ì†Œ ì„ íƒ ---
        const diaryOpenBtn = document.getElementById('diary-open-btn');
        const diaryModal = document.getElementById('diary-modal');
        const diaryCloseX = document.getElementById('diary-close-x');
        const diaryTextarea = document.getElementById('diary-textarea');
        const charCounter = document.getElementById('char-count-info');
        const diarySubmitBtn = document.getElementById('diary-submit');
        const diaryDateDisplay = document.getElementById('diary-date-display');

        const sidePanel = document.getElementById('island-info-panel');
        const panelCloseBtn = document.getElementById('panel-close-btn');
        const panelDiaryList = document.getElementById('panel-diary-list');
        const resultModal = document.getElementById('result-modal');
        const resultComment = document.getElementById('result-comment');
        const resultPointUpArea = document.getElementById('result-point-up-area');
        const resultCloseBtn = document.getElementById('result-close-btn');
        const audioResult = document.getElementById('sfx-result');
        const audioHit = document.getElementById('sfx-hit');
        const audioEnding = document.getElementById('sfx-ending');

        let isNightTime = false;
        let globalSFXVolume = 0.2; // [NEW] íš¨ê³¼ìŒ(SFX) ì „ì²´ ë³¼ë¥¨ ì œì–´ìš© ë³€ìˆ˜
        let globalTheme = 'auto';
        let particleDensity = 2; // 0: ë”, 1: ë³´í†µ, 2: ë§ìŒ
        let isParallaxOn = true; // ì‹œì  í”ë“¤ë¦¼ ì¼œì§/êº¼ì§
        let cachedDiaries = []; // ğŸ§º ì¼ê¸° ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë‹´ì•„ë‘˜ ë°”êµ¬ë‹ˆ
        let thisMonthDiaries = [];
        let shootingStars = [];

        const seasonModal = document.getElementById('season-modal');
        const seasonLoading = document.getElementById('season-loading');
        const seasonContent = document.getElementById('season-content');
        const seasonTypoList = document.getElementById('season-typo-list');
        const seasonActions = document.getElementById('season-actions');
        const seasonResetBtn = document.getElementById('season-reset-btn');

        let currentUser = null;
        let currentPoints = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
        let currentLastResult = null;
        let dailyDiaryCount = 0; 
        let lastDiaryDate = "";
        
        const virtueColors = {
            courage: '#ff6b6b', wisdom: '#4db8ff', kindness: '#ff85a2',
            diligence: '#2ecc71', serenity: '#81ecec'
        };
        const virtues = ['courage', 'wisdom', 'kindness', 'diligence', 'serenity'];

        let isGuestMode = localStorage.getItem('geulsup_is_guest') === 'true'; // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ìœ ì§€ í™•ì¸
        const guestLoginBtn = document.getElementById('guest-login-btn');

        if (isGuestMode) {
            currentUser = { uid: 'guest', isAnonymous: true };
            document.getElementById('google-login-btn').style.display = 'none';
            document.getElementById('guest-login-btn').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'block';

            const savedNickname = localStorage.getItem('geulsup_guest_nickname');
            if (savedNickname) {
                showEnterButton(savedNickname + " (Guest)");
                
                // ë°ì´í„° ì¦‰ì‹œ ë¡œë“œ!
                loadAllDiaries('guest');
                loadGuestPoints(); 
                
                const todayStr = getTodayStr();
                if (localStorage.getItem('geulsup_guest_last_date') === todayStr) {
                    dailyDiaryCount = parseInt(localStorage.getItem('geulsup_guest_daily_count') || '0');
                } else {
                    dailyDiaryCount = 0;
                    localStorage.setItem('geulsup_guest_last_date', todayStr);
                    localStorage.setItem('geulsup_guest_daily_count', '0');
                }
                lastDiaryDate = todayStr;
                updateSubmitButtonText();
            }
        }

        // 1. ê²ŒìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ ì‹œ -> ëª¨ë‹¬ ë„ìš°ê¸°
        guestLoginBtn.addEventListener('click', () => {
            playSfx('sfx-click');
            guestWarningModal.classList.add('active');
        });

        // 2. [ëŒì•„ê°€ê¸°] í´ë¦­ ì‹œ -> ëª¨ë‹¬ ë‹«ê¸°
        btnGuestCancel.addEventListener('click', () => {
            playSfx('sfx-click');
            guestWarningModal.classList.remove('active');
        });

        // 3. [ì…ì¥í•˜ê¸°] í´ë¦­ ì‹œ -> ì‹¤ì œ ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì§„í–‰
        btnGuestConfirm.addEventListener('click', () => {
            playSfx('sfx-click');
            guestWarningModal.classList.remove('active'); // ëª¨ë‹¬ ë‹«ê¸°

            // --- ì—¬ê¸°ì„œë¶€í„° ê¸°ì¡´ ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ë¡œì§ ì‹¤í–‰ ---
            isGuestMode = true;
            localStorage.setItem('geulsup_is_guest', 'true');
            currentUser = { uid: 'guest', isAnonymous: true };
            
            // UI ë³€ê²½
            document.getElementById('google-login-btn').style.display = 'none';
            document.getElementById('guest-login-btn').style.display = 'none';
            logoutBtn.style.display = 'block';
            
            // ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ë°ì´í„° ë¡œë“œ ì§í›„ (ì•½ 1300ë²ˆì§¸ ì¤„ ë¶€ê·¼)
            loadAllDiaries('guest');
            loadGuestPoints(); 

            // â˜… ì‹¤ì‹œê°„ ë‚ ì§œ ì²´í¬ ë° íšŸìˆ˜ ë™ê¸°í™”
            const todayStr = getTodayStr();
            const savedDate = localStorage.getItem('geulsup_guest_last_date');

            if (savedDate === todayStr) {
                dailyDiaryCount = parseInt(localStorage.getItem('geulsup_guest_daily_count') || '0');
            } else {
                dailyDiaryCount = 0;
                // ë‚ ì´ ë°”ë€Œì—ˆë‹¤ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë„ ìƒˆ ë‚ ì§œë¡œ ê°±ì‹ 
                localStorage.setItem('geulsup_guest_last_date', todayStr);
                localStorage.setItem('geulsup_guest_daily_count', '0');
            }
            lastDiaryDate = todayStr;

            updateSubmitButtonText(); // â˜… ë¡œê·¸ì¸ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
            
            // ë‹‰ë„¤ì„ í™•ì¸
            const savedNickname = localStorage.getItem('geulsup_guest_nickname');
            
            if (savedNickname) {
                showEnterButton(savedNickname + " (Guest)");
            } else {
                document.getElementById('nickname-modal').classList.add('active');
            }
        });

        // [ì¶”ê°€] ê²ŒìŠ¤íŠ¸ í¬ì¸íŠ¸ ë¡œë“œ í•¨ìˆ˜
        function loadGuestPoints() {
            const savedPoints = localStorage.getItem('geulsup_guest_points');
            if (savedPoints) {
                currentPoints = JSON.parse(savedPoints);
            } else {
                currentPoints = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
            }
            applyPointsToWorld();
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const defaultSettings = {
            bgmVolume: 0.3,
            sfxVolume: 0.5,
            particleDensity: 2,
            parallax: true,
            fontSize: 'medium',
            theme: 'auto'
        };

        function playSfx(audioId, multiplier = 1.0) {
            const original = document.getElementById(audioId);
            if (!original) return;

            const sound = original.cloneNode();
            // ì „ì—­ SFX ì„¤ì •ê°’ * ê°œë³„ íš¨ê³¼ìŒì˜ ë³´ì •ì¹˜ë¥¼ ê³±í•´ ìµœì¢… ë³¼ë¥¨ ê²°ì •
            sound.volume = globalSFXVolume * multiplier; 
            sound.play().catch(() => {});
        }

        function getCalculatedMonthlyStats() {
            let stats = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
            const now = new Date();
            const currY = now.getFullYear();
            const currM = now.getMonth(); // 0~11

            // cachedDiaries(ì „ì²´ ì¼ê¸° ë°”êµ¬ë‹ˆ)ì—ì„œ ì´ë²ˆ ë‹¬ ê²ƒë§Œ ê³¨ë¼ í•©ì‚°
            cachedDiaries.forEach(d => {
                let dDate = null;
                if (d.timestamp && typeof d.timestamp.toDate === 'function') dDate = d.timestamp.toDate();
                else if (d.date_str) dDate = new Date(d.date_str);

                if (dDate && dDate.getFullYear() === currY && dDate.getMonth() === currM) {
                    if (d.stat_increase) {
                        for (const [k, v] of Object.entries(d.stat_increase)) {
                            if (stats[k] !== undefined) stats[k] += (parseInt(v) || 0);
                        }
                    }
                }
            });
            return stats;
        }

        function moveSpotlight(targetElement, titleStr, descStr, radiusPadding = 40) {
            if (!targetElement) return;
            currentTargetForTutorial = targetElement;
            currentTutorialData = { title: titleStr, desc: descStr };

            tutText.classList.remove('active');
            
            setTimeout(() => {
                tutText.querySelector('.tut-title').innerText = titleStr;
                tutText.querySelector('.tut-desc').innerHTML = descStr;

                const rect = targetElement.getBoundingClientRect();
                const targetCenterX = rect.left + (rect.width / 2);
                const targetCenterY = rect.top + (rect.height / 2);
                const size = Math.max(rect.width, rect.height) + (radiusPadding * 2);

                // 1. ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ì´ë™
                tutOverlay.style.top = `${targetCenterY}px`;
                tutOverlay.style.left = `${targetCenterX}px`;
                tutOverlay.style.width = `${size}px`;
                tutOverlay.style.height = `${size}px`;

                // 2. í…ìŠ¤íŠ¸ ìœ„ì¹˜ ê³„ì‚°
                let textTop, textLeft;
                const textWidth = 280;
                const nextBtnSafetyZone = 180; // Next ë²„íŠ¼ìœ¼ë¡œë¶€í„° ë–¨ì–´ì§ˆ ìµœì†Œ ê±°ë¦¬

                // ê°€ë¡œ ìœ„ì¹˜: í™”ë©´ ì¤‘ì•™ ê¸°ì¤€
                if (targetCenterX > window.innerWidth / 2) {
                    textLeft = targetCenterX - (size / 2) - textWidth - 30;
                    tutText.style.alignItems = 'flex-end';
                    tutText.style.textAlign = 'right';
                } else {
                    textLeft = targetCenterX + (size / 2) + 30;
                    tutText.style.alignItems = 'flex-start';
                    tutText.style.textAlign = 'left';
                }

                // [í•µì‹¬] ì„¸ë¡œ ìœ„ì¹˜ ê²°ì • (Next ë²„íŠ¼ íšŒí”¼ ë¡œì§)
                // ë§Œì•½ íƒ€ê²Ÿì´ í™”ë©´ í•˜ë‹¨ì— ìˆë‹¤ë©´?
                if (targetCenterY > window.innerHeight - 250) {
                    // ì•„ë˜ì— Next ë²„íŠ¼ì´ ìˆìœ¼ë‹ˆ ìœ„ë¡œ ì˜¬ë¦¼
                    textTop = targetCenterY - (size / 2) - 150; 
                } else {
                    // ê·¸ ì™¸ì—ëŠ” íƒ€ê²Ÿ ì˜†ì— ë‚˜ë€íˆ ë°°ì¹˜
                    textTop = targetCenterY - 50;
                }

                // í™”ë©´ ë°– íƒˆì¶œ ë°©ì§€ (ìƒë‹¨ ë§ˆì§„ í™•ë³´)
                textTop = Math.max(80, Math.min(window.innerHeight - 200, textTop));
                textLeft = Math.max(20, Math.min(window.innerWidth - textWidth - 20, textLeft));

                // ìŠ¤íƒ€ì¼ ì ìš©
                tutText.style.top = `${textTop}px`;
                tutText.style.left = `${textLeft}px`;
                tutText.style.right = 'auto';
                tutText.style.bottom = 'auto';
                tutText.style.transform = 'none';

                tutText.classList.add('active');
            }, 650);
        }

        // ğŸ”¥ 1ë‹¨ê³„ ì‹œì‘ (ì„œì„œíˆ ì–´ë‘ ì´ ê¹”ë¦¬ë©° ì¡°ì¤€)
        function startTutorialStep1() {
            isTutorialMode = true;
            tutorialStep = 1;
            // playSfx('sfx-tut-1', 1.2); <- ì›ë˜ ì—¬ê¸° ìˆë˜ ì¦‰ì‹œ ì¬ìƒì„ ì•„ë˜ë¡œ ì˜®ê¹ë‹ˆë‹¤.

            // í´ë¦­ ë°©ì–´ë§‰ ê°€ë™!
            tutBlocker.classList.add('active');
            
            // ì²˜ìŒì— 200vw í¬ê¸°ì˜ ê±°ëŒ€í•œ ì˜¤ë²„ë ˆì´ê°€ ìŠ¤ë¥´ë¥µ ìƒê²¨ë‚¨ (í™• íŠ€ì–´ë‚˜ì˜´ ë°©ì§€)
            tutOverlay.classList.add('active');
            tutText.classList.add('active');

            // ì¼ê¸° ì“°ê¸° ë²„íŠ¼ë§Œ ë°©íŒ¨ ìœ„ë¡œ êº¼ëƒ„ (ì´ê²ƒ ë•Œë¬¸ì— í´ë¦­ì´ ë¬´ì¡°ê±´ ë©ë‹ˆë‹¤)
            diaryOpenBtn.classList.add('tut-z-up'); 

            // â˜… [ì•ˆì „ì¥ì¹˜] íŠœí† ë¦¬ì–¼ ì‹œì‘ ì‹œ ë¬´ì¡°ê±´ ë©”ë‰´ ìˆ¨ê¸°ê³  ë‹«ì•„ë²„ë¦¬ê¸°
            if (mainMenuSidebar) mainMenuSidebar.classList.remove('active');
            if (menuToggleBtn) {
                menuToggleBtn.classList.remove('open');
                menuToggleBtn.classList.remove('visible');
            }
            // 0.1ì´ˆ ë’¤ì— ê±°ëŒ€í–ˆë˜ êµ¬ë©ì´ ë²„íŠ¼ í¬ê¸°ì— ë§ì¶° ìƒ¥~ ì¢í˜€ì§
            setTimeout(() => {
                moveSpotlight(diaryOpenBtn, "ì •ì›ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.", "ë¨¼ì €, ìš°ì¸¡ í•˜ë‹¨ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬<br>ë‹¹ì‹ ì˜ ì²« ì´ì•¼ê¸°ë¥¼ ì‹¬ì–´ë³´ì„¸ìš”.", 40);
                
                // â˜… ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ê°€ ì´ë™í•˜ëŠ” 0.65ì´ˆ ë’¤ì— ì‚¬ìš´ë“œ ì¬ìƒ
                setTimeout(() => { playSfx('sfx-tut-1', 1.2); }, 650);
            }, 100); 
        }

        tutNextBtn.addEventListener('click', () => {
            playSfx('sfx-click');

            const playDelayedSfx = (sfxId, vol = 1.0) => {
                setTimeout(() => { playSfx(sfxId, vol); }, 650);
            };

            if (tutorialStep === 2) {
                tutorialStep = 3;
                moveSpotlight(diarySubmitBtn, "ë‚˜ë¬´ ì‹¬ê¸° (ê¸°ë¡ ì œì¶œ)", "ê¸°ë¡ì´ ëë‚˜ë©´ ì´ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>ì‘ì„±í•œ ê¸€ì€ ì •ì›ì˜ ì–‘ë¶„ì´ ë©ë‹ˆë‹¤.", 20);
                playDelayedSfx('sfx-tut-2');
            }
            else if (tutorialStep === 3) {
                tutorialStep = 4;
                moveSpotlight(diaryCloseX, "ì°½ ë‹«ê¸°", "ì‘ì„±ì„ ë§ˆì¹˜ê±°ë‚˜ ì·¨ì†Œí•˜ê³  ì‹¶ì„ ë•ŒëŠ”<br>ì´ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì •ì›ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.", 30);
                playDelayedSfx('sfx-tut-3', 1.0);
            }
            // â˜… ìƒˆë¡œ ì¶”ê°€ëœ 4 -> 5ë‹¨ê³„ ì „í™˜ ë¡œì§
            else if (tutorialStep === 4) {
                tutorialStep = 5;
                
                // 1. ì¼ê¸°ì¥ì„ ê°•ì œë¡œ ë¶€ë“œëŸ½ê²Œ ë‹«ê¸°
                diaryModal.classList.remove('active');
                
                // 2. ìˆ¨ê²¨ë’€ë˜ ë©”ë‰´ ë²„íŠ¼ ë“±ì¥ì‹œí‚¤ê¸°
                if (menuToggleBtn) menuToggleBtn.classList.add('visible');
                
                // 3. z-index ë°©íŒ¨ ì •ë¦¬ (ì¼ê¸°ì¥ì—ì„œ ì“°ë˜ ëª¨ë‹¬ìš© ìµœìƒë‹¨ í•´ì œ)
                tutBlocker.classList.remove('modal-top');
                tutOverlay.classList.remove('modal-top');
                tutText.classList.remove('modal-top');
                
                // 4. ë©”ë‰´ ë²„íŠ¼ ì¡°ì¤€!
                moveSpotlight(menuToggleBtn, "ì‹œìŠ¤í…œ ë©”ë‰´", 
                    "ìš°ì¸¡ ìƒë‹¨ì˜ ë©”ë‰´ë¥¼ ì—´ì–´ ë‚´ í”„ë¡œí•„, ì •ì› ì„¤ì •, ê·¸ë¦¬ê³ <br>ê³¼ê±°ì˜ ê¸°ë¡ì´ ë‹´ê¸´ <b>'ì—­ì‚¬ê´€'</b>ì— ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>" +
                    "<span style='font-size: 0.85rem; color: #888; border-top: 1px solid #333; display: block; padding-top: 10px; margin-top: 10px;'>" +
                    "ğŸ’¡ íŠœí† ë¦¬ì–¼ì€ ì–¸ì œë“  ë©”ë‰´ì˜ 'ë„ì›€ë§'ì—ì„œ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>", 
                    30
                );
                playDelayedSfx('sfx-tut-3', 1.0);
                
                // 5. ê¸€ì ë³€ê²½
                setTimeout(() => {
                    tutNextBtn.innerHTML = "FINISH â¯"; 
                }, 650);
            }
            // â˜… 5ë‹¨ê³„ ì¢…ë£Œ ë¡œì§
            else if (tutorialStep === 5) {
                playSfx('sfx-clear', 0.5);
                tutBlocker.classList.remove('active', 'modal-top');
                tutOverlay.classList.remove('active', 'modal-top');
                tutText.classList.remove('active', 'modal-top');
                tutNextBtn.classList.remove('active');
                
                tutOverlay.style.top = '50%'; tutOverlay.style.left = '50%';
                tutOverlay.style.width = '200vw'; tutOverlay.style.height = '200vh';

                isTutorialMode = false;
                tutorialStep = 0;
                localStorage.setItem('geulsup_tutorial_done', 'true'); 
                
                tutText.style.bottom = ''; tutText.style.left = '';
                tutText.style.transform = ''; 
                tutNextBtn.innerHTML = "NEXT â¯"; 
            }
        });

        // [1] ì„¤ì • ì €ì¥ í•¨ìˆ˜ (LocalStorage)
        function saveSettings() {
            const settings = {
                bgmVolume: parseFloat(document.getElementById('vol-bgm').value),
                sfxVolume: parseFloat(document.getElementById('vol-sfx').value),
                particleDensity: parseInt(document.getElementById('opt-particle').value),
                parallax: document.getElementById('opt-parallax').checked,
                // í˜„ì¬ ì ìš©ëœ í°íŠ¸ í´ë˜ìŠ¤ í™•ì¸
                fontSize: document.body.classList.contains('fs-small') ? 'small' : 
                        document.body.classList.contains('fs-large') ? 'large' : 'medium',
                theme: globalTheme
            };
            localStorage.setItem('geulsup_settings', JSON.stringify(settings));
            console.log("ì„¤ì • ì €ì¥ ì™„ë£Œ:", settings);
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('geulsup_settings');
                let s = {};
                if (saved) {
                    try {
                        s = JSON.parse(saved);
                    } catch (e) {
                        console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
                        s = {}; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™”
                    }
                }

                // 1. ê°’ ë³µêµ¬ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš© - ì•ˆì „ì¥ì¹˜)
                globalBGMVolume = (s.bgmVolume !== undefined && s.bgmVolume !== null) ? parseFloat(s.bgmVolume) : 0.3;
                globalSFXVolume = (s.sfxVolume !== undefined && s.sfxVolume !== null) ? parseFloat(s.sfxVolume) : 0.5;
                particleDensity = (s.particleDensity !== undefined) ? parseInt(s.particleDensity) : 2;
                isParallaxOn = (s.parallax !== undefined) ? s.parallax : true;
                globalTheme = s.theme || 'auto';

                // 2. UI(ìŠ¬ë¼ì´ë”)ì— ë°˜ì˜
                if (document.getElementById('vol-bgm')) document.getElementById('vol-bgm').value = globalBGMVolume;
                if (document.getElementById('vol-sfx')) document.getElementById('vol-sfx').value = globalSFXVolume;
                if (document.getElementById('disp-bgm')) document.getElementById('disp-bgm').innerText = Math.round(globalBGMVolume * 100) + '%';
                if (document.getElementById('disp-sfx')) document.getElementById('disp-sfx').innerText = Math.round(globalSFXVolume * 100) + '%';
                
                if (document.getElementById('opt-particle')) document.getElementById('opt-particle').value = particleDensity;
                if (document.getElementById('opt-parallax')) document.getElementById('opt-parallax').checked = isParallaxOn;
                
                // íŒŒí‹°í´ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                const pTextMap = { 0: "ë„ê¸° (Off)", 1: "ë³´í†µ (Medium)", 2: "ë§ìŒ (High)" };
                if (document.getElementById('disp-particle')) document.getElementById('disp-particle').innerText = pTextMap[particleDensity] || "ë§ìŒ (High)";

                // 3. [ì¤‘ìš”] ì‹¤ì œ ì˜¤ë””ì˜¤ íƒœê·¸ì— ì¦‰ì‹œ ë³¼ë¥¨ ì ìš©
                if (audioAmbiance) audioAmbiance.volume = globalBGMVolume;
                if (audioEnding) audioEnding.volume = globalBGMVolume;

                // 4. í…Œë§ˆ ë° í°íŠ¸ ì ìš©
                updateDayNightCycle();
                document.body.classList.remove('fs-small', 'fs-medium', 'fs-large');
                document.body.classList.add(`fs-${s.fontSize || 'medium'}`);

                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë™ê¸°í™”
                document.querySelectorAll('#font-group .opt-btn').forEach(b => b.classList.toggle('active', b.dataset.val === (s.fontSize || 'medium')));
                document.querySelectorAll('#theme-group .opt-btn').forEach(b => b.classList.toggle('active', b.dataset.val === globalTheme));

                console.log("ì„¤ì • ë¡œë“œ ì™„ë£Œ:", { globalBGMVolume, globalSFXVolume });

            } catch (e) {
                console.error("ì„¤ì • ë¡œë“œ ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜:", e);
                // ì˜¤ë¥˜ ë‚˜ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¡¤ë°±
                globalBGMVolume = 0.2;
                globalSFXVolume = 0.4;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        loadSettings();

        async function playCinematicReport(summaryData, yearStr, monthStr, isReplay = false) {
            const cineLoading = document.getElementById('cine-loading');
            const cineIntro = document.getElementById('cine-intro');
            const cineStory = document.getElementById('cine-story');
            const cineOutro = document.getElementById('cine-outro');
            const resetBtn = document.getElementById('season-reset-btn');

            // 1. ë°ì´í„° êµ¬ì¡° í˜¸í™˜ì„± ì²˜ë¦¬
            let quotesData = {};
            let personaData = [];
            let statsData = {};

            if (summaryData.quotes) {
                quotesData = summaryData.quotes;
                personaData = summaryData.persona || [];
                statsData = summaryData.stats || {};
            } else {
                quotesData = summaryData; 
                personaData = []; 
                statsData = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
            }

            // 2. ë¡œë”© ì œê±° & ì¸íŠ¸ë¡œ
            cineLoading.style.opacity = '0';
            await wait(500); cineLoading.style.display = 'none';

            document.getElementById('cine-year').innerText = yearStr;
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            document.getElementById('cine-month').innerText = monthNames[parseInt(monthStr)-1] || "MONTH";

            cineIntro.classList.add('active'); 
            await wait(3500); 
            cineIntro.classList.remove('active'); 
            await wait(1000); 

            // 3. ìŠ¤í† ë¦¬ ë£¨í”„ (ëª…ì–¸)
            const virtues = ['wisdom', 'courage', 'kindness', 'diligence', 'serenity'];
            
            for (const v of virtues) {
                const items = quotesData[v]; 
                if (items && items.length > 0) {
                    let topTwo = items.slice(0, 2);
                    topTwo.sort((a, b) => {
                        if (a && b && a.date && b.date && a.date !== "Unknown Date") {
                            return new Date(a.date) - new Date(b.date);
                        }
                        return 0;
                    });

                    let html = `<div class="story-virtue" style="--virtue-color: ${virtueColors[v]}">${v.toUpperCase()}</div>`;
                    
                    topTwo.forEach((item, idx) => {
                        let text = (typeof item === 'object') ? item.text : item;
                        let displayDate = "";
                        
                        if (item.date && item.date !== "Unknown Date") {
                            const d = new Date(item.date);
                            if (!isNaN(d)) displayDate = `${String(d.getMonth() + 1).padStart(2, '0')}. ${String(d.getDate()).padStart(2, '0')}.`;
                            else displayDate = "MONTHLY MEMORY";
                        } else displayDate = "ARCHIVED MEMORY";

                        html += `
                            <div class="record-box">
                                <div class="story-quote" id="quote-${v}-${idx}">"${text}"</div>
                                <div class="story-date" id="date-${v}-${idx}">${displayDate}</div>
                            </div>
                        `;
                    });

                    cineStory.innerHTML = html;
                    cineStory.classList.add('active'); 
                    await wait(500);

                    const q1 = document.getElementById(`quote-${v}-0`);
                    const d1 = document.getElementById(`date-${v}-0`);
                    if(q1) { q1.classList.add('show'); await wait(800); if(d1) d1.classList.add('show'); }

                    const q2 = document.getElementById(`quote-${v}-1`);
                    const d2 = document.getElementById(`date-${v}-1`);
                    if(q2) { await wait(2000); q2.classList.add('show'); await wait(800); if(d2) d2.classList.add('show'); }

                    const readingTime = topTwo.length * 4000; 
                    await wait(readingTime);
                    cineStory.classList.remove('active'); 
                    await wait(1000); 
                }
            }

            // 4. ì•„ì›ƒíŠ¸ë¡œ ì„¸íŒ…
            const personas = (personaData && personaData.length >= 3) ? personaData : ["ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.", "", ""];
            document.getElementById('persona-1').innerText = personas[0];
            document.getElementById('persona-2').innerText = personas[1];
            document.getElementById('persona-3').innerText = personas[2];

            const statsContainer = document.getElementById('outro-stats-list');
            if (statsContainer) {
                statsContainer.innerHTML = '';
                const stats = statsData; 
                virtues.forEach((v, idx) => {
                    const val = stats[v] || 0;
                    if(val > 0) { 
                        const div = document.createElement('div');
                        div.className = 'outro-stat-item';
                        div.style.transitionDelay = `${idx * 0.2}s`;
                        div.innerHTML = `<span style="width:100px;">${v.toUpperCase()}</span><span class="os-val" style="--v-color:${virtueColors[v]}">+${val}</span>`;
                        statsContainer.appendChild(div);
                    }
                });
            }

            // 5. ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ì¬ìƒ ëª¨ë“œ vs ë¦¬ì…‹ ëª¨ë“œ)
            if (isReplay) {
                resetBtn.innerText = "CLOSE ARCHIVE";
                resetBtn.onclick = () => {
                    document.getElementById('season-modal').classList.remove('active');
                    // ì›ë˜ëŒ€ë¡œ ëŒë ¤ë†“ê¸° (ì¤‘ìš”)
                    resetBtn.innerText = "BEGIN NEW SEASON";
                };
            } else {
                // ê¸°ì¡´ ë¦¬ì…‹ ë¡œì§ì€ showSeasonReportì—ì„œ ì—°ê²°í•¨
                resetBtn.innerText = "BEGIN NEW SEASON";
            }

            cineOutro.classList.add('active');
            
            await wait(500);
            document.querySelectorAll('.persona-line').forEach((el, i) => setTimeout(() => el.classList.add('show'), i * 800));
            document.querySelectorAll('.outro-stat-item').forEach(el => el.classList.add('show'));
        }

        async function showSeasonReport(targetPeriod, userRef, newPeriod, isBackfill) {
            
            seasonModal.classList.add('active');
            document.getElementById('cine-loading').style.display = 'block';
            document.getElementById('cine-loading').style.opacity = '1';
            
            // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            document.getElementById('cine-intro').classList.remove('active');
            document.getElementById('cine-story').classList.remove('active');
            document.getElementById('cine-outro').classList.remove('active');

            if(audioEnding) {
                audioEnding.volume = parseFloat(document.getElementById('vol-bgm').value); 
                audioEnding.currentTime = 0; 
                audioEnding.play().catch(()=>{});
            }

            try {
                // 1. [í•µì‹¬] ì„ íƒí•œ ë‹¬(targetPeriod)ì˜ ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
                const [y, m] = targetPeriod.split('-');
                const startStr = `${y}-${m}-01`;
                const lastDay = new Date(y, m, 0).getDate();
                const endStr = `${y}-${m}-${lastDay}`;

                // 2. í•´ë‹¹ ê¸°ê°„ì˜ ì¼ê¸°ë§Œ ì¿¼ë¦¬
                const snapshot = await userRef.collection('diaries')
                    .where('date_str', '>=', startStr)
                    .where('date_str', '<=', endStr)
                    .get();

                const monthDiaries = [];
                // í•´ë‹¹ ì›”ì˜ í¬ì¸íŠ¸ ìƒˆë¡œ ê³„ì‚° (í˜„ì¬ ìœ ì € í¬ì¸íŠ¸ X)
                let calculatedPoints = { courage:0, wisdom:0, kindness:0, diligence:0, serenity:0 };

                snapshot.forEach(doc => {
                    const d = doc.data();
                    monthDiaries.push(d);
                    
                    if(d.stat_increase) {
                        for(const [k, v] of Object.entries(d.stat_increase)) {
                            // Firestore ìˆ«ìëŠ” ê°€ë” ë¬¸ìì—´ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³€í™˜
                            if(calculatedPoints[k] !== undefined) calculatedPoints[k] += (parseInt(v)||0);
                        }
                    }
                });

                // 3. ìš”ì•½ ìƒì„± (ì¼ê¸°ê°€ ìˆìœ¼ë©´ ì„œë²„ ìš”ì²­, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
                let summaryData = {};
                if (monthDiaries.length === 0) {
                     summaryData = {
                        wisdom: ["ê¸°ë¡ë˜ì§€ ì•Šì€ ì‹œê°„ ì†ì—ë„ ì„±ì¥ì€ ìˆìŠµë‹ˆë‹¤."],
                        courage: [""], kindness: [""], diligence: [""], serenity: [""]
                    };
                } else {
                    const response = await fetch("https://guelforest-server.onrender.com/monthly-summary", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ diaries: monthDiaries })
                    });
                    if (!response.ok) throw new Error("ë¶„ì„ ì„œë²„ ì˜¤ë¥˜");
                    summaryData = await response.json();
                }

                // 4. ì‹œë„¤ë§ˆí‹± ì¬ìƒ (ê³„ì‚°ëœ í¬ì¸íŠ¸ ì „ë‹¬)
                await playCinematicReport(summaryData, y, m, false, calculatedPoints);

                // 5. ì €ì¥ ë²„íŠ¼ ë¡œì§
                const confirmModal = document.getElementById('reset-confirm-modal');
                const realResetBtn = document.getElementById('real-reset-btn');
                const seasonBtn = document.getElementById('season-reset-btn');
                
                // ê³¼ê±° ë°ì´í„° ì±„ìš°ê¸°(isBackfill)ì¼ ê²½ìš° ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                seasonBtn.innerText = isBackfill ? "SAVE TO ARCHIVE" : "BEGIN NEW SEASON";

                seasonBtn.onclick = () => {
                    playSfx('sfx-click');
                    confirmModal.classList.add('active');
                    const title = confirmModal.querySelector('h3');
                    const desc = confirmModal.querySelector('p');
                    
                    if(isBackfill) {
                        title.innerText = "ì´ ê¸°ë¡ì„ ì—­ì‚¬ê´€ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                        desc.innerText = "ì§€ë‚œë‹¬ì˜ ê¸°ë¡ì´ ì˜ì›íˆ ë³´ì¡´ë©ë‹ˆë‹¤.\ní˜„ì¬ ì •ì›ì˜ ìƒíƒœëŠ” ìœ ì§€ë©ë‹ˆë‹¤.";
                    } else {
                        title.innerText = "ìƒˆë¡œìš´ ì›”ì„ ë§ì´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                        desc.innerText = "ê¸°ë¡ì€ ì—­ì‚¬ê´€ì— ë³´ê´€ë˜ë©°,\nì •ì›ì˜ ì–‘ë¶„ì€ ì´ˆê¸°í™”ë˜ì–´ ìƒˆë¡œìš´ ì‹œì‘ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.";
                    }
                };

                document.getElementById('cancel-reset-btn').onclick = () => confirmModal.classList.remove('active');

                // 6. ìµœì¢… ì €ì¥
                realResetBtn.onclick = async () => {
                    realResetBtn.disabled = true;
                    realResetBtn.innerText = "ì €ì¥ ì¤‘...";
                    
                    try {
                        // Archiveì— ì €ì¥ (ë‚ ì§œëŠ” targetPeriod ì‚¬ìš©)
                        await userRef.collection('archives').doc(targetPeriod).set({
                            points: calculatedPoints, // ì—¬ê¸°ì„œ ê³„ì‚°í•œ í¬ì¸íŠ¸ ì €ì¥
                            archivedAt: new Date(),
                            summary: summaryData
                        });

                        // [ì¤‘ìš”] 'ë’¤ëŠ¦ê²Œ ì±„ìš°ê¸°(isBackfill)'ê°€ ì•„ë‹ ë•Œë§Œ ìœ ì € í¬ì¸íŠ¸ë¥¼ ë¦¬ì…‹í•¨
                        // ì¦‰, ì—­ì‚¬ê´€ì—ì„œ ë§Œë“¤ ë•ŒëŠ” í˜„ì¬ ë‚´ ì •ì› ì ìˆ˜ê°€ 0ì´ ë˜ì§€ ì•ŠìŒ.
                        if (!isBackfill) {
                            const resetPoints = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
                            await userRef.update({ 
                                total_points: resetPoints,
                                last_period: newPeriod 
                            });
                        }

                        alert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        if(isBackfill) window.location.href = 'archive.html';
                        else location.reload();

                    } catch(e) {
                        console.error(e);
                        alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
                        realResetBtn.disabled = false;
                    }
                };

            } catch (err) {
                console.error(err);
                document.getElementById('cine-loading').innerHTML = `<br>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>${err.message}`;
            }
        }

        profileLink.addEventListener('click', (e) => {
            e.preventDefault(); // # ì´ë™ ë°©ì§€
            playSfx('sfx-click');
            openProfileModal();
        });

        class ShootingStar {
            constructor() {
                // ì²˜ìŒì—” í™”ë©´ ë°– ë¨¼ ê³³(ëŒ€ê¸°ì‹¤)ì— ìˆ¨ê²¨ë‘ 
                this.x = -5000;
                this.y = -5000;
                this.len = 0;
                this.speed = 0;
                this.size = 0;
                this.angle = 45 * (Math.PI / 180);
            }

            // ë°œì‚¬! (ìœ„ì¹˜ì™€ ì†ë„ë¥¼ ëœë¤ìœ¼ë¡œ ì¬ì„¤ì •)
            reset() {
                // Xì¢Œí‘œ: í™”ë©´ ì™¼ìª½(-width)ë¶€í„° ì˜¤ë¥¸ìª½(width*2)ê¹Œì§€ ë„“ê²Œ ì¡ì•„ì•¼ 
                // 45ë„ë¡œ ë–¨ì–´ì§ˆ ë•Œ í™”ë©´ ì „ì²´ë¥¼ ì»¤ë²„í•  ìˆ˜ ìˆìŒ
                this.x = (Math.random() * width * 1.5) - (width * 0.25);
                
                // Yì¢Œí‘œ: í™”ë©´ ë°”ë¡œ ìœ„
                this.y = -100;
                
                this.len = Math.random() * 80 + 10;  // ê¼¬ë¦¬ ê¸¸ì´
                this.speed = Math.random() * 10 + 6; // ì†ë„
                this.size = Math.random() * 1 + 0.1; // ë¨¸ë¦¬ í¬ê¸°
            }

            update() {
                // ëŒ€ê¸° ì¤‘ì¸ ë³„ì€ ì›€ì§ì´ì§€ ì•ŠìŒ
                if (this.x === -5000) return;

                this.x += this.speed * Math.cos(this.angle);
                this.y += this.speed * Math.sin(this.angle);

                // í™”ë©´ ë°–ìœ¼ë¡œ ì™„ì „íˆ ë²—ì–´ë‚˜ë©´? -> ë‹¤ì‹œ ëŒ€ê¸°ì‹¤ë¡œ ë³´ëƒ„
                if (this.x > width + 200 || this.y > height + 200) {
                    this.x = -5000; 
                    this.y = -5000;
                }
            }

            draw() {
                // ë°¤ì´ ì•„ë‹ˆê±°ë‚˜ ëŒ€ê¸° ì¤‘ì´ë©´ ê·¸ë¦¬ì§€ ì•ŠìŒ
                if (!isNightTime || this.x === -5000) return; 

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);

                const gradient = ctx.createLinearGradient(0, 0, -this.len, 0);
                gradient.addColorStop(0, "rgba(255, 255, 255, 1)"); 
                gradient.addColorStop(0.1, "rgba(212, 175, 55, 0.8)"); 
                gradient.addColorStop(1, "rgba(255, 255, 255, 0)"); 

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-this.len, -1);
                ctx.lineTo(-this.len, 1);
                ctx.closePath();
                ctx.fill();

                ctx.restore();
            }
        }

        // ìœ ì„± 3ê°œ ìƒì„± (3ê°œê°€ ë²ˆê°ˆì•„ê°€ë©° ë–¨ì–´ì§)
        for (let i = 0; i < 3; i++) {
            shootingStars.push(new ShootingStar());
        }

        const fontBtns = document.querySelectorAll('#font-group .opt-btn');
        fontBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // 1. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” ë° í™œì„±í™”
                fontBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                // 2. ë°”ë”” í´ë˜ìŠ¤ ë³€ê²½ (fs-small, fs-medium, fs-large)
                const val = e.target.dataset.val;
                document.body.classList.remove('fs-small', 'fs-medium', 'fs-large'); // ê¸°ì¡´ ê±° ì‚­ì œ
                document.body.classList.add(`fs-${val}`); // ìƒˆ ê±° ì¶”ê°€
                
                playSfx('sfx-click'); // ë”¸ê¹
            });
        });

        const btnBackup = document.getElementById('btn-backup');

        btnBackup.addEventListener('click', () => {
            playSfx('sfx-click'); // ë”¸ê¹

            // 1. ë°ì´í„° í™•ì¸
            if (!cachedDiaries || cachedDiaries.length === 0) {
                alert("ì•„ì§ ë°±ì—…í•  ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ì •ì›ì— ì´ì•¼ê¸°ë¥¼ ì‹¬ì–´ë³´ì„¸ìš”! ğŸŒ±");
                return;
            }

            if (!confirm(`ì´ ${cachedDiaries.length}í¸ì˜ ì¼ê¸°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // 2. í…ìŠ¤íŠ¸ ë‚´ìš© ë§Œë“¤ê¸°
            let textContent = "========== [ê¸€ìˆ²] ë‚˜ì˜ ì •ì› ê¸°ë¡ ==========\n\n";
            const now = new Date();
            textContent += `ë°±ì—… ì¼ì‹œ: ${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}\n`;
            textContent += `ì‘ì„±ì: ${document.getElementById('profile-nickname').innerText}\n\n`;
            textContent += "===========================================\n\n";

            cachedDiaries.forEach((diary, index) => {
                // ë‚ ì§œ í¬ë§·íŒ…
                let dateStr = diary.date_str;
                if (!dateStr && diary.timestamp) {
                    const d = diary.timestamp.toDate ? diary.timestamp.toDate() : new Date();
                    dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }

                textContent += `[No.${cachedDiaries.length - index}] ${dateStr}\n`;
                textContent += `ğŸ“ ë‚˜ì˜ ê¸°ë¡:\n${diary.content}\n\n`;
                textContent += `ğŸŒ¿ ì •ì›ì‚¬ì˜ ë‹µì¥:\n${diary.ai_reply || "(ë‹µì¥ ì—†ìŒ)"}\n`;
                
                // íšë“ ìŠ¤íƒ¯ í‘œì‹œ
                let statsArr = [];
                if(diary.stat_increase) {
                    for(const [k, v] of Object.entries(diary.stat_increase)) {
                        if(v > 0) statsArr.push(`${k.toUpperCase()} +${v}`);
                    }
                }
                if(statsArr.length > 0) textContent += `âœ¨ ì„±ì¥: ${statsArr.join(', ')}\n`;
                
                textContent += "\n-------------------------------------------\n\n";
            });

            // 3. íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±° (ë¸Œë¼ìš°ì € ê¸°ëŠ¥ í™œìš©)
            try {
                const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement("a");
                a.href = url;
                a.download = `GeulSup_Backup_${now.getFullYear()}${now.getMonth()+1}${now.getDate()}.txt`;
                document.body.appendChild(a); // íŒŒì´ì–´í­ìŠ¤ ë“± í˜¸í™˜ì„± ìœ„í•´ ì¶”ê°€
                a.click(); // ê°€ìƒì˜ í´ë¦­ ë°œìƒ
                
                document.body.removeChild(a); // ì²­ì†Œ
                URL.revokeObjectURL(url); // ë©”ëª¨ë¦¬ í•´ì œ
            } catch (err) {
                console.error(err);
                alert("ë°±ì—… íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // [6] í…Œë§ˆ ë²„íŠ¼ ë¡œì§
        const themeBtns = document.querySelectorAll('#theme-group .opt-btn');
        themeBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // 1. ë²„íŠ¼ ìŠ¤íƒ€ì¼
                themeBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                // 2. ì„¤ì •ê°’ ë³€ê²½
                globalTheme = e.target.dataset.val;
                
                // 3. ì¦‰ì‹œ í™”ë©´ ê°±ì‹  (ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë°”ë¡œ ë°”ë€œ)
                updateDayNightCycle();
                
                playSfx('sfx-click');
            });
        });

        /* --- [ìˆ˜ì •] ì—­ì‚¬ê´€ ì´ë™ ë¡œì§ (ì‹œë„¤ë§ˆí‹± íŠ¸ëœì§€ì…˜) --- */
        const transitionLayer = document.getElementById('archive-transition-layer');
        const menuArchiveBtn = document.getElementById('menu-archive-btn');

        if (menuArchiveBtn) { 
            menuArchiveBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                // 1. íš¨ê³¼ìŒ ì¬ìƒ (í´ë¦­ìŒ + ë¶„ìœ„ê¸°ìŒ ìˆìœ¼ë©´ ì¢‹ìŒ)
                const audioClick = document.getElementById('sfx-click');
                if(audioClick) {
                    audioClick.currentTime = 0;
                    audioClick.play().catch(() => {});
                }

                // 2. ë©”ë‰´ë°” ë¶€ë“œëŸ½ê²Œ ë‹«ê¸°
                const sidebar = document.getElementById('main-menu-sidebar');
                const toggleBtn = document.getElementById('menu-toggle-btn');
                if (sidebar) sidebar.classList.remove('active');
                if (toggleBtn) toggleBtn.classList.remove('open');

                // 3. ë¡œê·¸ì¸ ì²´í¬
                if (!currentUser) { 
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤."); 
                    return; 
                }

                // 4. [í•µì‹¬] íŠ¸ëœì§€ì…˜ ë ˆì´ì–´ í™œì„±í™” (ê²€ì€ í™”ë©´ í˜ì´ë“œ ì¸)
                if (transitionLayer) {
                    transitionLayer.classList.add('active');
                }

                // 5. 2ì´ˆ ë™ì•ˆ ì—°ì¶œ ë³´ì—¬ì£¼ê³  í˜ì´ì§€ ì´ë™
                setTimeout(() => {
                    window.location.href = 'archive.html';
                }, 2000);
            });
        } else {
            console.warn("ë©”ë‰´ ë²„íŠ¼(#menu-archive-btn)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // --- [NEW] ì„¤ì • ëª¨ë‹¬ ë° ì‚¬ìš´ë“œ ì œì–´ ë¡œì§ ---
        const settingsModal = document.getElementById('settings-modal');
        const settingsCloseX = document.getElementById('settings-close-x');
        const volBgmSlider = document.getElementById('vol-bgm');
        const volSfxSlider = document.getElementById('vol-sfx');
        const dispBgm = document.getElementById('disp-bgm');
        const dispSfx = document.getElementById('disp-sfx');

        // ì‚¬ì´ë“œë°”ì˜ ë‘ ë²ˆì§¸ ë©”ë‰´('ì •ì› ì„¤ì •') í´ë¦­ ì‹œ ì—´ê¸°
        // (ìˆœì„œê°€ ë°”ë€Œì§€ ì•Šì•˜ëŠ”ì§€ ê¼­ í™•ì¸í•˜ì„¸ìš”!)
        const settingsLink = document.querySelector('.menu-list li:nth-child(2) a');

        settingsLink.addEventListener('click', (e) => {
            e.preventDefault();
            // íš¨ê³¼ìŒ ì¬ìƒ (í˜„ì¬ ì„¤ì •ëœ globalSFXVolume ì ìš©)
            const sound = audioClick.cloneNode();
            sound.volume = 1.0 * globalSFXVolume; 
            sound.play().catch(()=>{});

            settingsModal.classList.add('active');
        });

        settingsCloseX.addEventListener('click', () => settingsModal.classList.remove('active'));

        volBgmSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            audioAmbiance.volume = val; 
            if(audioEnding) audioEnding.volume = val; // ì—”ë”© ìŒì•…ë„ í•¨ê»˜ ì¡°ì ˆ
            dispBgm.innerText = Math.round(val * 100) + '%';
            saveSettings(); 
        });

        // SFX ì¡°ì ˆ
        volSfxSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            globalSFXVolume = val; // ì´ ë³€ìˆ˜ê°€ playSfx í•¨ìˆ˜ì—ì„œ ì‚¬ìš©ë¨
            dispSfx.innerText = Math.round(val * 100) + '%';
            saveSettings(); 
        });

        const optParticle = document.getElementById('opt-particle');
        const dispParticle = document.getElementById('disp-particle');
        const optParallax = document.getElementById('opt-parallax');

        // 3. íŒŒí‹°í´ ì¡°ì ˆ ë¡œì§
        optParticle.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            particleDensity = val;

            // í…ìŠ¤íŠ¸ ë° ì‹¤ì œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            if (val === 0) {
                dispParticle.innerText = "ë„ê¸° (Off)";
                particles = []; // ì‹¹ ë¹„ìš°ê¸°
            } else if (val === 1) {
                dispParticle.innerText = "ë³´í†µ (Medium)";
                // ë„ˆë¬´ ë§ìœ¼ë©´ ì¤„ì´ê¸°
                if (particles.length > 50) particles = particles.slice(0, 50);
            } else {
                dispParticle.innerText = "ë§ìŒ (High)";
                // ë¶€ì¡±í•˜ë©´ ì±„ì›Œë„£ëŠ” ê±´ animate ë£¨í”„ê°€ ì•Œì•„ì„œ í•¨
            }
        });

        // 4. Parallax ON/OFF ë¡œì§
        optParallax.addEventListener('change', (e) => {
            isParallaxOn = e.target.checked;
            
            if (!isParallaxOn) {
                // ë„ë©´ ëª¨ë“  ì„¬ì„ ì¤‘ì•™ ì •ë ¬ë¡œ ì´ˆê¸°í™” (ê¹”ë”í•˜ê²Œ)
                const allObjects = document.querySelectorAll('.scene-object');
                allObjects.forEach(obj => {
                    // ì›ë˜ ìœ„ì¹˜(baseX, baseY)ë¡œ ë³µê·€, translateëŠ” 0ìœ¼ë¡œ
                    // (ë‹¨, world-focused ìƒíƒœì¼ ë•ŒëŠ” ê±´ë“œë¦¬ì§€ ì•Šì•„ì•¼ í•¨)
                    if(!document.body.classList.contains('world-focused')) {
                        obj.style.transform = `translate(-50%, 0px)`; 
                    }
                });
            }
            saveSettings(); // ì¶”ê°€!
        });

        // 2. Firebase ì„¤ì • (ìœ¤í˜¸ë‹˜ì˜ ì„¤ì •ê°’ ê·¸ëŒ€ë¡œ ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyANMznf6jeSLcLBPMZz7UrU7yf5YR3y18s",
            authDomain: "geulsup.firebaseapp.com",
            projectId: "geulsup",
            storageBucket: "geulsup.firebasestorage.app",
            messagingSenderId: "16178537421",
            appId: "1:16178537421:web:f6cf9fbe1317809d721a84",
            measurementId: "G-TQ6Z3SQKPM"
        };

        // 3. [ìˆ˜ì •] Firebase ì´ˆê¸°í™” (compat ë°©ì‹)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ìš”ì†Œ ì„ íƒ ---
        const googleLoginBtn = document.getElementById('google-login-btn');
        const enterButton = document.getElementById('enter-btn'); // ë³€ìˆ˜ëª… ì£¼ì˜ (ìœ„ html idë‘ ë§ì¶¤)
        const userGreeting = document.getElementById('user-greeting');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const nicknameSubmitBtn = document.getElementById('nickname-submit-btn');

        // --- 3. êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ---
        googleLoginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log("ë¡œê·¸ì¸ ì„±ê³µ:", result.user);
                    // ë¡œê·¸ì¸ ìƒíƒœ ë³€í™”ëŠ” ì•„ë˜ onAuthStateChangedì—ì„œ ì²˜ë¦¬
                })
                .catch((error) => {
                    console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                    alert("ë¡œê·¸ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        });

        menuToggleBtn.addEventListener('click', () => {
            playSfx('sfx-click');
            
            // ë§Œì•½ 'ì„¬ ì •ë³´ íŒ¨ë„(ì§‘ì¤‘ ëª¨ë“œ)'ì´ ì—´ë ¤ìˆë‹¤ë©´? -> ë‹«ì•„ë²„ë¦¬ê¸°
            if (document.body.classList.contains('world-focused')) {
                closeFocusMode(); 
            }

            // ë©”ë‰´ í† ê¸€ (active í´ë˜ìŠ¤ ìŠ¤ìœ„ì¹­)
            menuToggleBtn.classList.toggle('open');
            mainMenuSidebar.classList.toggle('active');
        });

        // ë²„íŠ¼ í˜¸ë²„ ì‹œ íš¨ê³¼ìŒ
        menuToggleBtn.addEventListener('mouseenter', () => {
            const sound = audioHover.cloneNode();
            sound.volume = 0.5 * globalSFXVolume; // 0.1ì€ ì›ë˜ ìµœëŒ€ í¬ê¸°
            sound.play().catch(()=>{});
        });

        async function loadAllDiaries(uid) {
            cachedDiaries = [];
            thisMonthDiaries = [];
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            // [ìˆ˜ì •] ê²ŒìŠ¤íŠ¸ ëª¨ë“œë©´ Firebase ê·¼ì²˜ì—ë„ ì•ˆ ê°€ê³  ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ëëƒ„
            if (isGuestMode || uid === 'guest') {
                const localData = localStorage.getItem('geulsup_guest_diaries');
                if (localData) {
                    try {
                        cachedDiaries = JSON.parse(localData);
                        cachedDiaries.forEach(d => {
                            // UI í˜¸í™˜ì„±ì„ ìœ„í•´ ê°€ì§œ toDate í•¨ìˆ˜ ìƒì„±
                            if (!d.timestamp || typeof d.timestamp.toDate !== 'function') {
                                d.timestamp = { toDate: () => new Date(d.date_str || Date.now()) };
                            }
                        });
                    } catch(e) { console.error("LocalData Parse Error", e); }
                }
            } else {
                // [ìˆ˜ì •] íšŒì›ì¼ ë•Œë§Œ Firebase í˜¸ì¶œ
                try {
                    const snapshot = await db.collection('users').doc(uid).collection('diaries')
                        .orderBy('timestamp', 'desc').limit(300).get();
                    snapshot.forEach(doc => cachedDiaries.push(doc.data()));
                } catch (err) { 
                    console.error("Firebase ë¡œë”© ì‹¤íŒ¨ (ê¶Œí•œ ì—†ìŒì€ ë¬´ì‹œí•´ë„ ë¨):", err); 
                }
            }

            // ê³µí†µ í•„í„°ë§ ë¡œì§ (ì´ë²ˆ ë‹¬ ì¼ê¸° ë¶„ë¥˜)
            cachedDiaries.forEach(data => {
                let dDate = null;
                if(data.timestamp && typeof data.timestamp.toDate === 'function') dDate = data.timestamp.toDate();
                else if(data.date_str) dDate = new Date(data.date_str);

                if(dDate && dDate.getFullYear() === currentYear && dDate.getMonth() === currentMonth) {
                    thisMonthDiaries.push(data);
                }
            });
            
            console.log(`ëª¨ë“œ: ${isGuestMode ? 'Guest' : 'User'}, ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
        }

        function openDetailModal(data, dateStr) {
            document.getElementById('detail-date').innerText = dateStr;
            document.getElementById('detail-content').innerText = data.content;
            document.getElementById('detail-ai-reply').innerText = data.ai_reply || "ì •ì›ì‚¬ì˜ ë‹µì¥ì´ ì—†ìŠµë‹ˆë‹¤.";
            
            // ìŠ¤íƒ¯ í‘œì‹œ
            const statsContainer = document.getElementById('detail-stats');
            statsContainer.innerHTML = '';
            
            if (data.stat_increase) {
                for (const [key, value] of Object.entries(data.stat_increase)) {
                    if (value > 0) {
                        const badge = document.createElement('div');
                        badge.classList.add('point-badge', `badge-${key}`);
                        badge.innerText = `${key.toUpperCase()} +${value}`;
                        statsContainer.appendChild(badge);
                    }
                }
            }

            detailModal.classList.add('active');
        }

        // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        detailCloseX.addEventListener('click', () => {
            detailModal.classList.remove('active');
        });

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) detailModal.classList.remove('active');
        });

        function openProfileModal() {
            // 1. [í•µì‹¬ ìˆ˜ì •] ë‹‰ë„¤ì„ & ê°€ì…ì¼ ì„¸íŒ… (ê²ŒìŠ¤íŠ¸ vs íšŒì› ë¶„ê¸° ì²˜ë¦¬)
            if (isGuestMode) {
                // ê²ŒìŠ¤íŠ¸ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const guestName = localStorage.getItem('geulsup_guest_nickname') || 'ì—¬í–‰ì';
                document.getElementById('profile-nickname').innerText = guestName + " (Guest)";
                document.getElementById('profile-join-date').innerText = "ê¸°ë¡ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ëŠ” ì†ë‹˜ì…ë‹ˆë‹¤.";
            } else if (currentUser && currentUser.uid !== 'guest') {
                // íšŒì›ì´ë©´ Firebaseì—ì„œ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if(doc.exists) {
                        document.getElementById('profile-nickname').innerText = doc.data().nickname;
                        const joinDate = doc.data().createdAt ? doc.data().createdAt.toDate() : new Date();
                        document.getElementById('profile-join-date').innerText = `Since ${joinDate.getFullYear()}. ${String(joinDate.getMonth() + 1).padStart(2, '0')}. ${String(joinDate.getDate()).padStart(2, '0')}.`;
                    }
                }).catch(err => console.error("í”„ë¡œí•„ ë¡œë“œ ì—ëŸ¬:", err));
            }

            // 2. [ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€] ì‹¤ì‹œê°„ í•©ì‚° ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ë°” ê·¸ë˜í”„ ë Œë”ë§
            const monthlyStats = getCalculatedMonthlyStats();
            const maxVal = Math.max(...Object.values(monthlyStats), 10);

            const container = document.getElementById('monthly-stat-container');
            container.innerHTML = '';

            const virtueNames = { 
                courage: 'ìš©ê¸° (Courage)', wisdom: 'ì§€í˜œ (Wisdom)', 
                kindness: 'ì¹œì ˆ (Kindness)', diligence: 'ì„±ì‹¤ (Diligence)', serenity: 'í‰ì˜¨ (Serenity)' 
            };

            for (const [key, val] of Object.entries(monthlyStats)) {
                const percent = Math.min((val / maxVal) * 100, 100);
                const color = virtueColors[key];

                const div = document.createElement('div');
                div.className = 'stat-bar-group';
                div.innerHTML = `
                    <div class="stat-label-row">
                        <span>${virtueNames[key]}</span>
                        <span style="color:${color}">${val} pts</span>
                    </div>
                    <div class="stat-track">
                        <div class="stat-fill" style="width: 0%; background-color: ${color}; box-shadow: 0 0 10px ${color};"></div>
                    </div>
                `;
                container.appendChild(div);

                setTimeout(() => {
                    div.querySelector('.stat-fill').style.width = `${percent}%`;
                }, 100);
            }

            profileModal.classList.add('active');
        }

        // ë‹«ê¸° ë¡œì§
        profileCloseX.addEventListener('click', () => profileModal.classList.remove('active'));
        profileModal.addEventListener('click', (e) => {
            if(e.target === profileModal) profileModal.classList.remove('active');
        });

        // [ìˆ˜ì • ì™„ë£Œ] ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ ë° ë°ì´í„° ë¡œë“œ ë¡œì§ (ì „ì²´)
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // ------------------------------------------------
                // 1. ìœ ì € ì ‘ì† ì„±ê³µ (êµ¬ê¸€ ë¡œê·¸ì¸ ìƒíƒœ)
                // ------------------------------------------------
                currentUser = user;
                isGuestMode = false; // êµ¬ê¸€ ë¡œê·¸ì¸ì´ë‹ˆ ê²ŒìŠ¤íŠ¸ ëª¨ë“œ í•´ì œ

                // ë¡œê·¸ì¸ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê³  ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('google-login-btn').style.display = 'none';
                document.getElementById('guest-login-btn').style.display = 'none'; // â˜… ê²ŒìŠ¤íŠ¸ ë²„íŠ¼ë„ ìˆ¨ê¹€
                logoutBtn.style.display = 'block';

                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();

                if (userDoc.exists) {
                    const userData = userDoc.data();

                    // â˜… ì˜¤ëŠ˜ ì“´ ì¼ê¸° íšŸìˆ˜ íŒŒì•… (DB ì—°ë™)
                    const todayStr = getTodayStr();
                    if (userData.last_diary_date === todayStr) {
                        dailyDiaryCount = userData.daily_diary_count || 0;
                    } else {
                        dailyDiaryCount = 0; // ë‚ ì´ ë°”ë€Œì—ˆìœ¼ë©´ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                    }
                    lastDiaryDate = todayStr;

                    updateSubmitButtonText(); // â˜… íšŒì› ë¡œê·¸ì¸ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
                    
                    // [ì¤‘ìš”] ì „ì—­ ë³€ìˆ˜ì— ìœ ì € ì •ë³´ ì €ì¥
                    globalUserData = userData; 
                    globalUserRef = userDocRef;
                    
                    // ì…ì¥ ë²„íŠ¼ í‘œì‹œ ë° ì¼ê¸° ë°ì´í„° ë¡œë“œ
                    showEnterButton(userData.nickname);
                    await loadAllDiaries(user.uid);
                    
                    // í¬ì¸íŠ¸(ìŠ¤íƒ¯) ì ìš©
                    if(userData.total_points) {
                        currentPoints = { ...currentPoints, ...userData.total_points };
                        applyPointsToWorld();
                    }

                    // --- [ì›”ê°„ ë¦¬í¬íŠ¸ ì²´í¬ ë° ì‹¤í–‰ ë¡œì§] ---
                    const now = new Date();
                    // í˜„ì¬ ì‹¤ì œ ë‹¬ (ì˜ˆ: 2024-05)
                    const currentPeriod = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    // DBì— ì €ì¥ëœ ë§ˆì§€ë§‰ ë¦¬í¬íŠ¸ ë‹¬ (ì˜ˆ: 2024-04)
                    const savedPeriod = userData.last_period || ""; 
                    
                    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤: ì´ë²ˆ ë‹¬ ì•Œë¦¼ì„ ì´ë¯¸ ë´¤ëŠ”ì§€ ì²´í¬ìš©
                    const promptSeenKey = `geulsup_prompt_seen_${currentPeriod}`;

                    // 1) [ê°•ì œ ì‹¤í–‰] ì—­ì‚¬ê´€ì—ì„œ "ì§€ê¸ˆ ë§Œë“¤ê¸°"ë¥¼ ëˆ„ë¥´ê³  ë„˜ì–´ì˜¨ ê²½ìš°
                    if (sessionStorage.getItem('forceSeasonReport') === 'true') {
                        sessionStorage.removeItem('forceSeasonReport');
                        
                        // ì €ì¥í•´ë‘” "ëª‡ ì›”(YYYY-MM)"ì¸ì§€ êº¼ë‚´ê¸°
                        const targetDate = sessionStorage.getItem('targetPeriod'); 
                        sessionStorage.removeItem('targetPeriod');

                        if (targetDate) {
                            // ë°°ê²½ ê°€ë¦¬ê¸°
                            enterGardenMode(true); 
                            // [í•µì‹¬] í•´ë‹¹ ì›”(targetDate)ë¡œ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘ (isBackfill = true)
                            await showSeasonReport(targetDate, userDocRef, currentPeriod, true);
                        }
                        return;
                    }

                    // 2) [ìì—° ì‹¤í–‰] ë‹¬ì´ ë°”ë€Œì–´ì„œ ì²˜ìŒ ì•ˆë‚´ì°½ì„ ë„ìš°ëŠ” ê²½ìš°
                    // ì¡°ê±´: (DBìƒ ê³¼ê±° ë‹¬ì„) AND (ì´ë²ˆ ë‹¬ ì•Œë¦¼ì„ ì•„ì§ ì•ˆ ë´„)
                    if (savedPeriod && savedPeriod !== currentPeriod) {
                        
                        // ì´ë¯¸ "ë‚˜ì¤‘ì—"ë¥¼ ëˆŒë €ë˜ ì ì´ ìˆë‹¤ë©´? -> íŒ¨ìŠ¤í•˜ê³  ì¡°ìš©íˆ ì •ì› ë¡œë“œ
                        if (localStorage.getItem(promptSeenKey) === 'true') {
                            // DB ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•ŠìŒ (Archiveì—ì„œ ë§Œë“¤ ë•Œê¹Œì§€ last_period ìœ ì§€)
                            return; 
                        }

                        // ì•Œë¦¼ì„ ë„ì›Œì•¼ í•˜ëŠ” ìƒí™© (í¬ì¸íŠ¸ê°€ ìˆì„ ë•Œë§Œ)
                        if (userData.total_points) {
                            const noticeModal = document.getElementById('season-notice-modal');
                            const btnNow = document.getElementById('btn-season-now');
                            const btnLater = document.getElementById('btn-season-later');
                            
                            if (noticeModal) {
                                noticeModal.style.visibility = 'visible';
                                noticeModal.style.opacity = '1';
                                playSfx('sfx-click'); 

                                // [A] ì§€ê¸ˆ ì—®ê¸° í´ë¦­
                                btnNow.onclick = () => {
                                    playSfx('sfx-click');
                                    noticeModal.style.opacity = '0';
                                    setTimeout(() => { noticeModal.style.visibility = 'hidden'; }, 500);
                                    
                                    // ë´¤ìŒ í‘œì‹œ ì €ì¥ (ë‹¤ì‹œ ì•ˆ ëœ¨ê²Œ)
                                    localStorage.setItem(promptSeenKey, 'true');

                                    // ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘
                                    showSeasonReport(userData.total_points, savedPeriod, userDocRef, currentPeriod, user.uid);
                                };

                                // [B] ë‚˜ì¤‘ì— í´ë¦­
                                btnLater.onclick = () => {
                                    playSfx('sfx-click');
                                    noticeModal.style.opacity = '0';
                                    setTimeout(() => { noticeModal.style.visibility = 'hidden'; }, 500);
                                    
                                    // ë´¤ìŒ í‘œì‹œ ì €ì¥ (ë‹¤ì‹œ ì•ˆ ëœ¨ê²Œ -> ì´ì œ Archiveì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥)
                                    localStorage.setItem(promptSeenKey, 'true');
                                };
                            }
                        } else {
                            // í¬ì¸íŠ¸ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´(í™œë™ ì—†ëŠ” ë‹¬) ì¡°ìš©íˆ ê¸°ê°„ë§Œ ê°±ì‹ 
                            await userDocRef.update({ last_period: currentPeriod });
                        }
                    } 
                    // 3) í‰ì†Œ ì ‘ì† (ë‹¬ì´ ê°™ìŒ or DBì— ê¸°ë¡ ì—†ìŒ)
                    else if (!userData.last_period) {
                        await userDocRef.update({ last_period: currentPeriod });
                    }

                } else {
                    // íšŒì›ê°€ì… ì •ë³´ ì—†ìŒ -> ë‹‰ë„¤ì„ ì„¤ì • ëª¨ë‹¬ ë„ìš°ê¸°
                    document.getElementById('nickname-modal').classList.add('active');
                }
            } else {
                // ------------------------------------------------
                // 2. ë¡œê·¸ì•„ì›ƒ ìƒíƒœ (ë¹„íšŒì›)
                // ------------------------------------------------
                
                // â˜… [ì¤‘ìš”] í˜„ì¬ ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‚¬ìš© ì¤‘ì´ë¼ë©´ UIë¥¼ ì´ˆê¸°í™”í•˜ì§€ ì•Šê³  í•¨ìˆ˜ ì¢…ë£Œ
                if (isGuestMode) return;

                currentUser = null;
                
                // ë¡œê·¸ì¸ ë²„íŠ¼ë“¤ ë‹¤ì‹œ í‘œì‹œ
                document.getElementById('google-login-btn').style.display = 'flex';
                document.getElementById('guest-login-btn').style.display = 'block'; // â˜… ê²ŒìŠ¤íŠ¸ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
                
                // ì…ì¥/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¹€
                enterButton.style.display = 'none';
                logoutBtn.style.display = 'none';
                userGreeting.style.opacity = '0';
                
                // ë°ì´í„° ì´ˆê¸°í™”
                cachedDiaries = [];
                currentPoints = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
            }
        });

        // [index.html ìˆ˜ì •]
        function applyPointsToWorld() {
            // DB í•„ë“œê°€ ì•„ë‹ˆë¼ ì‹¤ì‹œê°„ ê³„ì‚°ëœ ê°’ì„ ê°€ì ¸ì˜´
            const stats = getCalculatedMonthlyStats(); 
            
            virtues.forEach(v => {
                const p = stats[v] || 0;
                
                // ìŠ¬ë¼ì´ë” ë° ìˆ˜ì¹˜ í‘œì‹œ ì—…ë°ì´íŠ¸ (ê°œë°œì ëª¨ë“œìš©)
                const slider = document.getElementById(`rng-${v}`);
                const display = document.getElementById(`val-${v}`);
                if (slider) slider.value = p;
                if (display) display.innerText = p;
                
                // ì‹¤ì œ ì„¬ ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸
                updateIslandVisual(v, p);
            });
        }

        logoutBtn.addEventListener('click', () => {
            const msg = isGuestMode 
                ? "ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ë‚¨ìŠµë‹ˆë‹¤)" 
                : "ì •ì›ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?";

            if (confirm(msg)) {
                if (isGuestMode) {
                    localStorage.removeItem('geulsup_is_guest'); // â˜… [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ ì‹œ ê¸°ì–µ ì§€ìš°ê¸°!
                    location.reload(); 
                } else {
                    auth.signOut().then(() => location.reload());
                }
            }
        });

        nicknameSubmitBtn.addEventListener('click', async () => {
            playSfx('sfx-click');
            const nickname = nicknameInput.value.trim();
            
            if (nickname.length < 1) {
                alert("ì´ë¦„ì„ í•œ ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (isGuestMode) {
                // ğŸŸ¢ [A] ê²ŒìŠ¤íŠ¸ ëª¨ë“œ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì´ë¦„ ì €ì¥
                localStorage.setItem('geulsup_guest_nickname', nickname);
                
                // ê²ŒìŠ¤íŠ¸ìš© ì´ˆê¸° í¬ì¸íŠ¸ ì„¤ì • (ì—†ë‹¤ë©´)
                if (!localStorage.getItem('geulsup_guest_points')) {
                     const initPoints = { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 };
                     localStorage.setItem('geulsup_guest_points', JSON.stringify(initPoints));
                     currentPoints = initPoints;
                }
                
                document.getElementById('nickname-modal').classList.remove('active');
                showEnterButton(nickname + " (Guest)");

            } else {
                // ğŸ”µ [B] íšŒì› ëª¨ë“œ: Firebaseì— ì €ì¥ (ê¸°ì¡´ ë¡œì§)
                try {
                    await db.collection('users').doc(currentUser.uid).set({
                        nickname: nickname,
                        email: currentUser.email,
                        createdAt: new Date(),
                        points: { courage: 0, wisdom: 0, kindness: 0, diligence: 0, serenity: 0 }
                    });
                    
                    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (ì‹œì¦Œ ë¦¬í¬íŠ¸ ë¡œì§ ë“±ì—ì„œ ì‚¬ìš©ë¨)
                    globalUserData = { nickname: nickname }; 
                    globalUserRef = db.collection('users').doc(currentUser.uid);

                    document.getElementById('nickname-modal').classList.remove('active');
                    showEnterButton(nickname);
                } catch (e) {
                    console.error("ë‹‰ë„¤ì„ ì €ì¥ ì‹¤íŒ¨:", e);
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        });

        function showEnterButton(nickname) {
            // ìœ„ì—ì„œ ë³€ìˆ˜ê°€ ì„ ì–¸ë˜ê¸¸ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì—¬ê¸°ì„œ ì§ì ‘ HTML ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const enterBtnEl = document.getElementById('enter-btn');
            const greetingEl = document.getElementById('user-greeting');
            
            if (enterBtnEl) {
                enterBtnEl.style.display = 'block';
                enterBtnEl.style.animation = 'fadeInUp 1s ease forwards';
            }
            
            if (greetingEl) {
                greetingEl.innerText = `í™˜ì˜í•©ë‹ˆë‹¤, ${nickname}ë‹˜.`;
                greetingEl.style.opacity = '1';
                greetingEl.style.transition = 'opacity 1s ease';
            }
        }
        // ë”ë¯¸ ë°ì´í„° (ë‚˜ì¤‘ì—” ì‹¤ì œ ì¼ê¸° ë°ì´í„°ì™€ ì—°ë™)
        const islandData = {
            'wisdom': { 
                kr: 'ì§€í˜œì˜ ì •ì›', en: 'Garden of Wisdom', 
                logs: [
                    { date: '2024.05.20', text: 'ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¥¼ ë°°ì› ë‹¤. ì–´ë µì§€ë§Œ ì›ë¦¬ë¥¼ ê¹¨ë‹«ëŠ” ê³¼ì •ì´ ì¦ê±°ì› ë‹¤.' },
                    { date: '2024.05.18', text: 'ì±…ì„ ì½ë‹¤ê°€ ë¬¸ë“ ë‚´ ì‚¶ì˜ ë°©í–¥ì„±ì— ëŒ€í•œ íŒíŠ¸ë¥¼ ì–»ì—ˆë‹¤.' }
                ] 
            },
            'courage': { 
                kr: 'ìš©ê¸°ì˜ ì •ì›', en: 'Garden of Courage', 
                logs: [
                    { date: '2024.05.21', text: 'ë°œí‘œ ê³µí¬ì¦ì´ ìˆì—ˆì§€ë§Œ ì†ì„ ë“¤ê³  ë‚´ ì˜ê²¬ì„ ë§í–ˆë‹¤. ì‹¬ì¥ì´ í„°ì§ˆ ê²ƒ ê°™ì•˜ì§€ë§Œ í•´ëƒˆë‹¤.' }
                ] 
            },
            'kindness': { kr: 'ì¹œì ˆì˜ ì •ì›', en: 'Garden of Kindness', logs: [] },
            'diligence': { kr: 'ì„±ì‹¤ì˜ ì •ì›', en: 'Garden of Diligence', logs: [] },
            'serenity': { kr: 'í‰ì˜¨ì˜ ì •ì›', en: 'Garden of Serenity', logs: [] }
        };

        async function realAnalyzeDiary(diaryText) {
            // ğŸ‘‡ ìœ¤í˜¸ë‹˜ì˜ Render ì„œë²„ ì£¼ì†Œë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
            const url = "https://guelforest-server.onrender.com/analyze"; 

            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                    // ğŸ” Authorization í—¤ë” ì‚­ì œ! (ì´ì œ API í‚¤ëŠ” ì„œë²„ì— ìˆìœ¼ë‹ˆê¹Œìš”)
                },
                body: JSON.stringify({
                    diaryText: diaryText // ì„œë²„ë¡œ 'ì¼ê¸° ë‚´ìš©'ë§Œ ê°€ë³ê²Œ ë³´ëƒ…ë‹ˆë‹¤.
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || "ì„œë²„ í†µì‹  ì‹¤íŒ¨");
            }

            // ì„œë²„ê°€ ì´ë¯¸ ë¶„ì„í•´ì„œ ê¹”ë”í•œ JSONì„ ë³´ë‚´ì£¼ë¯€ë¡œ ë°”ë¡œ ë¦¬í„´!
            return await response.json(); 
        }

        islandElements.forEach(island => {
            // 1. í˜¸ë²„ íš¨ê³¼ (ê¸°ì¡´ ìœ ì§€)
            island.addEventListener('mouseenter', () => {
                // ì§‘ì¤‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ íˆ´íŒ í‘œì‹œ
                if(!document.body.classList.contains('world-focused') && island.classList.contains('visible')) {
                    const sound = audioHover.cloneNode(); 
                    sound.volume = 0.5 * globalSFXVolume; 
                    sound.play().catch(()=>{});

                    tooltipEn.innerText = island.dataset.nameEn;
                    tooltipKr.innerText = island.dataset.nameKr;
                    const points = parseInt(island.dataset.points);
                    const lvl = calculateLevel(points);
                    tooltipLvl.innerText = `Lv. ${lvl} (${points}pts)`;
                    
                    tooltip.classList.add('active');
                }
            });

            island.addEventListener('mouseleave', () => { 
                tooltip.classList.remove('active'); 
            });

            // 2. í´ë¦­ ì´ë²¤íŠ¸ (ìˆ˜ì •ë¨: ì´ë²ˆ ë‹¬ ë°ì´í„°ë§Œ í•„í„°ë§)
            island.addEventListener('click', (e) => {
                // ë©”ë‰´ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
                if (mainMenuSidebar.classList.contains('active')) {
                    mainMenuSidebar.classList.remove('active');
                    menuToggleBtn.classList.remove('open');
                }
                
                // ì´ë¯¸ ì§‘ì¤‘ ëª¨ë“œë¼ë©´(íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´) ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
                if (document.body.classList.contains('world-focused')) return;

                e.stopPropagation(); // ë°°ê²½ í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€

                const type = island.dataset.type;
                const points = parseInt(island.dataset.points);
                const level = calculateLevel(points);

                // íš¨ê³¼ìŒ ë° ë¹„ì£¼ì–¼ ì²˜ë¦¬
                audioClick.volume = 1.0 * globalSFXVolume;
                playSfx('sfx-click');
                document.body.classList.add('world-focused');
                island.classList.add('focused-island');

                // íŒ¨ë„ ìƒë‹¨ ì •ë³´ ì±„ìš°ê¸°
                document.getElementById('panel-title-kr').innerText = islandData[type].kr;
                document.getElementById('panel-title-en').innerText = islandData[type].en;
                document.getElementById('panel-lvl').innerText = `Lv. ${level}`;
                document.getElementById('panel-pts').innerText = points;
                document.getElementById('panel-progress-bar').style.width = `${(level / 10) * 100}%`;

                // [í•µì‹¬ ë¡œì§] ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° ì´ë²ˆ ë‹¬ ë°ì´í„° í•„í„°ë§
                const listContainer = document.getElementById('panel-diary-list');
                listContainer.innerHTML = ''; 

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0 ~ 11

                // ì „ì²´ ë³´ê´€í•¨(cachedDiaries)ì—ì„œ ì¡°ê±´ì— ë§ëŠ” ê²ƒë§Œ ê³¨ë¼ë‚´ê¸°
                const filteredLogs = cachedDiaries.filter(data => {
                    // ì¡°ê±´ 1: í•´ë‹¹ ë•ëª© ì ìˆ˜ê°€ 0ë³´ë‹¤ ì»¤ì•¼ í•¨
                    if (!data.stat_increase || !data.stat_increase[type] || data.stat_increase[type] <= 0) return false;

                    // ì¡°ê±´ 2: ë‚ ì§œê°€ 'ì´ë²ˆ ë‹¬'ì´ì–´ì•¼ í•¨
                    let dDate = null;
                    if (data.timestamp && typeof data.timestamp.toDate === 'function') {
                        dDate = data.timestamp.toDate();
                    } else if (data.date_str) {
                        dDate = new Date(data.date_str);
                    }

                    if (dDate) {
                        return dDate.getFullYear() === currentYear && dDate.getMonth() === currentMonth;
                    }
                    return false;
                });

                // í•„í„°ë§ëœ ê²°ê³¼ ë Œë”ë§
                if (filteredLogs.length === 0) {
                    listContainer.innerHTML = '<li style="color:#555; font-size:0.8rem; text-align:center; margin-top:20px;">ì´ë²ˆ ë‹¬ì—” ì•„ì§ ì´ ì •ì›ì— í•€ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                } else {
                    filteredLogs.forEach((data, index) => {
                        let dateStr = data.date_str || "ë‚ ì§œ ë¯¸ìƒ";
                        
                        // date_strì´ ì—†ê³  íƒ€ì„ìŠ¤íƒ¬í”„ë§Œ ìˆëŠ” ê²½ìš° í¬ë§·íŒ…
                        if(!data.date_str && data.timestamp) {
                             const date = data.timestamp.toDate();
                             dateStr = `${date.getFullYear()}. ${String(date.getMonth()+1).padStart(2,'0')}. ${String(date.getDate()).padStart(2,'0')}`;
                        }

                        const li = document.createElement('li');
                        li.classList.add('diary-item');
                        // ìˆœì°¨ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
                        li.style.animation = `fadeInUp 0.5s ease forwards ${index * 0.05}s`;
                        li.style.opacity = '0';
                        li.style.cursor = 'pointer';

                        li.innerHTML = `
                            <span class="diary-date">${dateStr}</span>
                            <span class="diary-snippet">${data.content}</span>
                            <div style="font-size: 0.7rem; color: #d4af37; margin-top: 5px; opacity: 0.8;">
                                ğŸŒ¿ "${data.ai_reply ? data.ai_reply.substring(0, 20) : "..."}..."
                            </div>
                        `;

                        // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
                        li.addEventListener('click', () => openDetailModal(data, dateStr));
                        
                        listContainer.appendChild(li);
                    });
                }

                // íŒ¨ë„ ì—´ê¸°
                sidePanel.classList.add('active');
            });
        });

        // --- [NEW] ì§‘ì¤‘ ëª¨ë“œ í•´ì œ (íŒ¨ë„ ë‹«ê¸°) í•¨ìˆ˜ ---
        function closeFocusMode() {
            if (!document.body.classList.contains('world-focused')) return;

            playSfx('sfx-click');
            sidePanel.classList.remove('active'); // íŒ¨ë„ ë‹«ê¸°
            document.body.classList.remove('world-focused'); // ì›”ë“œ ë³µê·€
            
            // ëª¨ë“  ì„¬ì—ì„œ focused í´ë˜ìŠ¤ ì œê±°
            islandElements.forEach(isl => isl.classList.remove('focused-island'));
        }

        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
        panelCloseBtn.addEventListener('click', closeFocusMode);

        // ë°°ê²½(ì›”ë“œ) í´ë¦­ ì‹œ ë‹«ê¸° (ë¹ˆ ê³µê°„ í´ë¦­)
        worldContainer.addEventListener('click', (e) => {
            // ì„¬ì´ë‚˜ íŒ¨ë„ì„ í´ë¦­í•œ ê²Œ ì•„ë‹ˆë¼ë©´ ë‹«ê¸°
            if(document.body.classList.contains('world-focused') && !e.target.closest('.island')) {
                closeFocusMode();
            }
        });

        // ESC í‚¤ ëˆ„ë¥´ë©´ ë‹«ê¸°
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeFocusMode();
        });

        // --- [ì¶”ê°€] ë¦¬ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ (ìŠ¤íƒ€ì¼ íƒœê·¸ì— ë„£ì–´ë„ ë¨) ---
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);

        // --- 1. ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ìŒ (ê¸°ì¡´ ì˜¤ë””ì˜¤ ì¬í™œìš©) ---
        diaryOpenBtn.addEventListener('mouseenter', () => {
            const sound = audioHover.cloneNode();
            sound.volume = 0.5 * globalSFXVolume;
            sound.play().catch(()=>{});
        });


        diaryOpenBtn.addEventListener('click', () => {
            playSfx('sfx-click');

            if (isTutorialMode && tutorialStep === 1) {
                tutorialStep = 2;
                diaryOpenBtn.classList.remove('tut-z-up'); 
                
                tutBlocker.classList.add('modal-top');
                tutOverlay.classList.add('modal-top');
                tutText.classList.add('modal-top'); // í…ìŠ¤íŠ¸ë„ ë ˆì´ì–´ ìœ„ë¡œ
                
                // ëª¨ë‹¬ì°½ì´ ìŠ¤ë¥´ë¥µ ëœ¨ëŠ” ì‹œê°„ì„ ë²Œì–´ì¤€ ë’¤ ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ì´ë™
                setTimeout(() => {
                    tutNextBtn.classList.add('active'); 
                    moveSpotlight(diaryTextarea, "ê¸°ì–µì˜ íŒŒí¸", "ì´ê³³ì— ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì´ë‚˜ ê°ì •ì„ ì ìŠµë‹ˆë‹¤.<br>ìµœì†Œ 30ì ì´ìƒ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.", 40);
                    
                    // â˜… ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ì´ë™ íƒ€ì´ë°(650ms)ì— ë§ì¶° ì‚¬ìš´ë“œ ì¬ìƒ
                    setTimeout(() => { playSfx('sfx-tut-2', 1.0); }, 650);
                }, 850); 
            }

            if (menuToggleBtn) menuToggleBtn.classList.remove('visible');

            const todayStr = getTodayStr();
            if (lastDiaryDate !== todayStr) {
                dailyDiaryCount = 0;
                lastDiaryDate = todayStr;
                updateSubmitButtonText();
            }

            if (dailyDiaryCount >= 2) {
                limitModal.classList.add('active');
            } else {
                diaryModal.classList.add('active');
                const now = new Date();
                diaryDateDisplay.innerText = `${now.getFullYear()}. ${String(now.getMonth()+1).padStart(2,'0')}. ${String(now.getDate()).padStart(2,'0')}. ${['SUN','MON','TUE','WED','THU','FRI','SAT'][now.getDay()]}`;
            }
        });

        function closeDiaryWithTutorial() {
            diaryModal.classList.remove('active');
            
            if (isTutorialMode) {
                tutText.classList.remove('active');
                
                // ìœ ì €ê°€ íŠœí† ë¦¬ì–¼ ë„ì¤‘(2, 3, 4ë‹¨ê³„)ì— ì°½ì„ ë§˜ëŒ€ë¡œ ë‹«ì•„ë²„ë¦¬ë©´ 
                // íŠœí† ë¦¬ì–¼ì´ ê¹¨ì§€ì§€ ì•Šê²Œ 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ ì‹œì‘ì‹œí‚´
                if (tutorialStep >= 2 && tutorialStep <= 4) {
                    setTimeout(startTutorialStep1, 500); 
                }
            } else {
                // í‰ì†Œ(íŠœí† ë¦¬ì–¼ ì•„ë‹ ë•Œ) ì°½ ë‹«ìœ¼ë©´ ë©”ë‰´ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
                if (menuToggleBtn) menuToggleBtn.classList.add('visible'); 
            }
        }

        diaryCloseX.addEventListener('click', closeDiaryWithTutorial);
        diaryModal.addEventListener('click', (e) => {
            if (e.target === diaryModal) closeDiaryWithTutorial();
        });

        diaryCloseX.addEventListener('click', () => { 
            diaryModal.classList.remove('active'); 

            // â˜… [ì¶”ê°€] íŠœí† ë¦¬ì–¼ ì¤‘ì¸ë° ì¼ê¸°ë¥¼ ì•ˆ ì“°ê³  ì°½ì„ ë‹«ì•˜ë‹¤ë©´? -> ë‹¤ì‹œ 1ë‹¨ê³„ë¡œ ê°•ì œ ë³µê·€!
            if (isTutorialMode && tutorialStep === 2) {
                setTimeout(startTutorialStep1, 500); 
            } else {
                if (menuToggleBtn) menuToggleBtn.classList.add('visible'); 
            }
        });

        // ëª¨ë‹¬ ë°– ë°°ê²½ í´ë¦­í•´ì„œ ë‹«ì„ ë•Œë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
        diaryModal.addEventListener('click', (e) => {
            if (e.target === diaryModal) {
                diaryModal.classList.remove('active');
                
                // â˜… [ì¶”ê°€] ê°•ì œ ë³µê·€ ë¡œì§
                if (isTutorialMode && tutorialStep === 2) {
                    setTimeout(startTutorialStep1, 500); 
                } else {
                    if (menuToggleBtn) menuToggleBtn.classList.add('visible'); 
                }
            }
        });

        // --- 3. ê¸€ì ìˆ˜ ê²€ì¦ ë¡œì§ (30ì ~ 20ì) ---
        diaryTextarea.addEventListener('input', () => {
            const len = diaryTextarea.value.length;
            charCounter.innerText = `${len} / 200`;

            // ê¸°íšì„œ ë°¸ëŸ°ì‹± ê¸°ì¤€: ìµœì†Œ 30ì, ìµœëŒ€ 200ì [cite: 3, 17]
            if (len >= 30 && len <= 200) {
                diarySubmitBtn.disabled = false;
                charCounter.classList.remove('invalid');
            } else {
                diarySubmitBtn.disabled = true;
                charCounter.classList.add('invalid');
            }
        });

        diarySubmitBtn.addEventListener('click', async () => {
            const text = diaryTextarea.value.trim();

            // 1. ìœ íš¨ì„± ë° ì‘ì„± í•œë„ ê²€ì¦
            if (text.length < 30 || text.length > 200) {
                alert("ì¼ê¸°ëŠ” 30ì ì´ìƒ 200ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                return;
            }

            const todayStr = getTodayStr();
            if (lastDiaryDate !== todayStr) {
                dailyDiaryCount = 0;
                lastDiaryDate = todayStr;
            }

            if (dailyDiaryCount >= 2) {
                alert("ì˜¤ëŠ˜ ì‘ì„± í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.");
                diaryModal.classList.remove('active');
                limitModal.classList.add('active');
                return;
            }

            // 2. ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì¼ê¸°ì¥ ë‹«ê¸°
            diarySubmitBtn.disabled = true;
            playSfx('sfx-click');
            diaryModal.classList.remove('active');

            // ëª¨ë‹¬ ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
            const resultModalContainer = document.getElementById('result-modal');
            const loadingArea = document.getElementById('result-loading-area');
            const contentArea = document.getElementById('result-content-area');
            const adModal = document.getElementById('loading-ad-modal');
            const adCloseBtn = document.getElementById('ad-close-btn');

            // 3. [1ë‹¨ê³„ ì—°ì¶œ] 'ì •ì›ì‚¬ê°€ ì½ê³  ìˆìŠµë‹ˆë‹¤' ë¡œë”©ì°½ ì¦‰ì‹œ ë„ìš°ê¸°
            loadingArea.style.display = 'flex';
            contentArea.style.display = 'none';
            resultModalContainer.classList.add('active'); 
            resultModalContainer.querySelector('.result-window').style.transform = 'scale(1)';

            // ìƒíƒœ ì²´í¬ìš© ë³€ìˆ˜ (ì´ê²Œ í•µì‹¬ì…ë‹ˆë‹¤!)
            let aiFinished = false; // AI ë¶„ì„ì´ ëë‚¬ëŠ”ê°€?
            let adClosed = false;   // ìœ ì €ê°€ ê´‘ê³ ë¥¼ ë‹«ì•˜ëŠ”ê°€?
            let apiError = null;    // ì—ëŸ¬ ë°œìƒ ì—¬ë¶€

            // [ê²°ê³¼ì°½ ì „í™˜ í•¨ìˆ˜] - ë‘ ì¡°ê±´ì´ ëª¨ë‘ ë§Œì¡±ë  ë•Œë§Œ ì‹¤í–‰ë¨
            const swapToResult = () => {
                loadingArea.style.display = 'none';
                contentArea.style.display = 'block';
                if (audioResult) {
                    const resSound = audioResult.cloneNode();
                    resSound.volume = 0.6 * globalSFXVolume;
                    resSound.play().catch(() => {});
                }
                diaryTextarea.value = '';
                charCounter.innerText = "0 / 200";
                diarySubmitBtn.disabled = false;
                updateSubmitButtonText();
            };

            const handleError = (err) => {
                alert("ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                resultModalContainer.classList.remove('active');
                if (menuToggleBtn) menuToggleBtn.classList.add('visible'); // â˜… ì—ëŸ¬ ë‚¬ì„ ë•Œ íƒˆì¶œêµ¬ ë³µêµ¬
                diarySubmitBtn.disabled = false;
                updateSubmitButtonText();
            };


            // 4. [UI íƒ€ì´ë¨¸ íë¦„] ë¬´ì¡°ê±´ 2ì´ˆ ë’¤ì— ê´‘ê³  ë„ìš°ê¸°
            setTimeout(() => {
                // í˜¹ì‹œ ê·¸ 2ì´ˆ ì•ˆì— ì¹˜ëª…ì ì¸ ì—ëŸ¬ê°€ ë‚¬ë‹¤ë©´ ê´‘ê³  ë„ìš°ì§€ ì•ŠìŒ
                if (aiFinished && apiError) return;

                // 2ì´ˆ ê°ìƒ í›„ ì „ë©´ ê´‘ê³  ë®ê¸°
                adModal.classList.add('active');

                // ê´‘ê³  ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                let countdown = 5;
                adCloseBtn.innerText = `Wait... ${countdown}`;
                adCloseBtn.style.cursor = 'not-allowed';
                adCloseBtn.style.pointerEvents = 'none';
                adCloseBtn.style.color = '#888';

                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        adCloseBtn.innerText = `Wait... ${countdown}`;
                    } else {
                        clearInterval(timer);
                        adCloseBtn.innerText = 'âœ• CLOSE';
                        adCloseBtn.style.cursor = 'pointer';
                        adCloseBtn.style.pointerEvents = 'auto';
                        adCloseBtn.style.color = '#fff';
                    }
                }, 1000);

                // ìœ ì €ê°€ ê´‘ê³ ì˜ X ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
                adCloseBtn.onclick = () => {
                    playSfx('sfx-click');
                    adModal.classList.remove('active'); // ê´‘ê³  ê»ë°ê¸°ë§Œ ì¹˜ìš°ê¸°
                    adClosed = true;

                    // ì´ë¯¸ AIê°€ ëë‚¬ë‹¤ë©´ ë’¤ì— ì¤€ë¹„ëœ ê²°ê³¼ì°½ì„ ë°”ë¡œ ì§ ! í•˜ê³  ë³´ì—¬ì¤Œ
                    if (aiFinished) {
                        if (apiError) handleError(apiError);
                        else swapToResult(); 
                    }
                    // ì•„ì§ AIê°€ ì•ˆ ëë‚¬ë‹¤ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ -> 
                    // ê´‘ê³ ê°€ ì¹˜ì›Œì¡Œìœ¼ë‹ˆ ë°‘ì— ìˆë˜ 'ì •ì›ì‚¬ê°€ ì½ê³  ìˆìŠµë‹ˆë‹¤'ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ì‹œ ë…¸ì¶œë¨!
                };
            }, 2000); // <-- ì´ 2ì´ˆê°€ ê°ì„± íƒ€ì´ë°ì„ ë³´ì¥í•©ë‹ˆë‹¤.


            // 5. [ë°ì´í„° í†µì‹  íë¦„] ì‹œê°„ ë‚­ë¹„ ì—†ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì¦‰ì‹œ ì‹¤í–‰
            (async () => {
                try {
                    const result = await realAnalyzeDiary(text);
                    currentLastResult = result;
                    dailyDiaryCount++;

                    const newDiaryObj = {
                        content: text,
                        ai_reply: result.comment,
                        stat_increase: result.points,
                        date_str: todayStr,
                        timestamp: isGuestMode ? null : firebase.firestore.FieldValue.serverTimestamp() 
                    };

                    // --- ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ë¡œì§ ---
                    if (isGuestMode) {
                        cachedDiaries.unshift({ ...newDiaryObj, timestamp: { toDate: () => new Date() } }); 
                        const saveToLocal = cachedDiaries.map(d => ({
                            content: d.content, ai_reply: d.ai_reply, stat_increase: d.stat_increase, date_str: d.date_str
                        }));
                        localStorage.setItem('geulsup_guest_diaries', JSON.stringify(saveToLocal));
                        localStorage.setItem('geulsup_guest_last_date', todayStr);
                        localStorage.setItem('geulsup_guest_daily_count', dailyDiaryCount.toString());

                        for (const [virtue, score] of Object.entries(result.points)) {
                            if (score > 0) currentPoints[virtue] += score;
                        }
                        localStorage.setItem('geulsup_guest_points', JSON.stringify(currentPoints));

                    } else {
                        await db.collection('users').doc(currentUser.uid).collection('diaries').add(newDiaryObj);
                        const userRef = db.collection('users').doc(currentUser.uid);
                        
                        const updateData = { last_diary_date: todayStr, daily_diary_count: dailyDiaryCount };
                        for (const [virtue, score] of Object.entries(result.points)) {
                            if (score > 0) updateData[`total_points.${virtue}`] = firebase.firestore.FieldValue.increment(score);
                        }
                        await userRef.update(updateData);
                        cachedDiaries.unshift({ ...newDiaryObj, timestamp: { toDate: () => new Date() } });
                    }
                    // ------------------------------------

                    // í†µì‹  ì™„ë£Œ! í™”ë©´ì— ë³´ì´ì§€ëŠ” ì•Šì§€ë§Œ ê²°ê³¼ì°½ ë‚´ìš©ë¬¼ì„ ë¯¸ë¦¬ ì‹¹ ì±„ì›Œë‘  (ë’¤ì—ì„œ ì¤€ë¹„ ì™„ë£Œ)
                    resultPointUpArea.innerHTML = '';
                    virtues.forEach((v, index) => {
                        const p = result.points[v] || 0;
                        if (p > 0) {
                            if (!isGuestMode) currentPoints[v] += p;
                            islandData[v].logs.unshift({ date: 'ë°©ê¸ˆ ì „', text: text });
                            
                            const badge = document.createElement('div');
                            badge.classList.add('point-badge', `badge-${v}`);
                            badge.innerText = `${v.toUpperCase()} +${p}`;
                            badge.style.animationDelay = `${0.8 + (index * 0.1)}s`;
                            resultPointUpArea.appendChild(badge);

                            const slider = document.getElementById(`rng-${v}`);
                            const display = document.getElementById(`val-${v}`);
                            if (slider) slider.value = currentPoints[v];
                            if (display) display.innerText = currentPoints[v];
                            updateIslandVisual(v, currentPoints[v]);
                        }
                    });
                    resultComment.innerText = result.comment;

                    aiFinished = true; // AI ë‹¤ ëë‚¨ ë„ì¥ ì¾…!

                    // ë§Œì•½ ìœ ì €ê°€ ì´ë¯¸ 5ì´ˆ ê´‘ê³ ë¥¼ ë‹¤ ë³´ê³  êº¼ë²„ë ¤ì„œ ëŒ€ê¸° ì¤‘ì¸ ìƒíƒœë¼ë©´? 
                    // ê¸°ë‹¤ë¦¬ê²Œ í•˜ì§€ ë§ê³  ì™„ì„±ëœ ê²°ê³¼ì°½ì„ ë„ì›Œì¤Œ
                    if (adClosed) {
                        swapToResult();
                    }

                } catch (err) {
                    console.error(err);
                    aiFinished = true;
                    apiError = err;
                    if (adClosed) {
                        handleError(err);
                    }
                }
            })(); // ë¹„ë™ê¸° ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ ë¬¶ì–´ì„œ íƒ€ì´ë¨¸ì™€ ì™„ì „ ë…ë¦½ì‹œì¼°ìŠµë‹ˆë‹¤.
        });

        // ë‚ ì§œ ë¬¸ìì—´ ë°˜í™˜ í•¨ìˆ˜
        function getTodayStr() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        // ì¼ê¸° ì‘ì„± ë²„íŠ¼ ë‚¨ì€ íšŸìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateSubmitButtonText() {
            const remaining = Math.max(0, 2 - dailyDiaryCount); // ë‚¨ì€ íšŸìˆ˜ ê³„ì‚° (ìµœì†Œ 0)
            const submitBtn = document.getElementById('diary-submit');
            if (submitBtn) {
                submitBtn.innerHTML = `ë‚˜ë¬´ ì‹¬ê¸° (ê¸°ë¡) <span style="font-size: 0.75rem; margin-left: 5px; opacity: 0.7;">(${remaining}/2)</span>`;
            }
        }

        // [ì¶”ê°€] ì œí•œ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ (Xë²„íŠ¼ íš¨ê³¼ìŒ í¬í•¨)
        const limitModal = document.getElementById('limit-modal');
        const limitCloseX = document.getElementById('limit-close-x');
        
        limitCloseX.addEventListener('mouseenter', () => playSfx('sfx-hover'));
        limitCloseX.addEventListener('click', () => {
            playSfx('sfx-click');
            limitModal.classList.remove('active');
            if (menuToggleBtn) menuToggleBtn.classList.add('visible'); // â˜… ë³µêµ¬
        });
        limitModal.addEventListener('click', (e) => {
            if (e.target === limitModal) {
                limitModal.classList.remove('active');
                if (menuToggleBtn) menuToggleBtn.classList.add('visible'); // â˜… ë³µêµ¬
            }
        });

        resultCloseBtn.addEventListener('click', () => {
            resultModal.classList.remove('active');
            if (menuToggleBtn) menuToggleBtn.classList.add('visible'); // â˜… ë³µêµ¬ ì™„ë£Œ!

            // ì´ì œ currentLastResultê°€ ì •ì˜ë˜ì–´ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤!
            if (!currentLastResult) return;

            Object.keys(currentLastResult.points).forEach((v, index) => {
                const p = currentLastResult.points[v];
                if (p > 0) {
                    setTimeout(() => {
                        createOrbToIsland(v, p);
                    }, index * 250); // êµ¬ìŠ¬ì´ í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ ë‚ ì•„ê°
                }
            });
        });

        function createOrbToIsland(virtue, points) {
            const island = document.getElementById(`island-${virtue}`);
            const islandImg = document.getElementById(`img-${virtue}`);
            const islandRect = island.getBoundingClientRect();
            const color = virtueColors[virtue];
            
            const orb = document.createElement('div');
            orb.classList.add('energy-orb');
            orb.style.setProperty('--orb-color', color);
            
            orb.style.left = `${window.innerWidth / 2}px`;
            orb.style.top = `${window.innerHeight / 2}px`;
            document.body.appendChild(orb);

            orb.offsetHeight; 

            setTimeout(() => {
                orb.classList.add('flying');
                const targetX = islandRect.left + islandRect.width / 2;
                const targetY = islandRect.top + islandRect.height / 2;
                orb.style.left = `${targetX - 15}px`; 
                orb.style.top = `${targetY - 15}px`;
            }, 100);

            // [ì¶©ëŒ ì‹œì ]
            setTimeout(() => {
                orb.remove();

                // A. [NEW] íƒ€ê²© íš¨ê³¼ìŒ ì¬ìƒ
                if(audioHit) {
                    const hitSound = audioHit.cloneNode();
                    hitSound.volume = 0.4;
                    hitSound.play().catch(()=>{});
                }

                // B. ì„¬ ë°œê´‘
                islandImg.classList.add('flash-effect');
                setTimeout(() => islandImg.classList.remove('flash-effect'), 700);

                // C. [ê°œì„ ] ì¶©ê²©íŒŒ ìƒì„±
                const ripple = document.createElement('div');
                ripple.classList.add('impact-ripple');
                ripple.style.setProperty('--orb-color', color);
                island.appendChild(ripple);
                setTimeout(() => ripple.classList.add('active'), 10);
                setTimeout(() => ripple.remove(), 600);

                // D. [ê°œì„ ] ì‘ê³  ì˜ˆìœ í…ìŠ¤íŠ¸ íŒì—…
                const popup = document.createElement('div');
                popup.classList.add('floating-point');
                popup.style.setProperty('--orb-color', color);
                popup.innerText = `+${points} PTS`;
                island.appendChild(popup);
                
                setTimeout(() => popup.classList.add('pop'), 10);

                setTimeout(() => {
                    popup.classList.add('fade');
                    setTimeout(() => popup.remove(), 500);
                }, 1200); // í‘œì‹œ ì‹œê°„ë„ ì‚´ì§ ë‹¨ì¶•í•˜ì—¬ ê²½ì¾Œí•˜ê²Œ

            }, 1300);
        }

        diaryCloseX.addEventListener('click', () => { 
            // [ì¤‘ìš”] style.display = 'none' ëŒ€ì‹  í´ë˜ìŠ¤ ì œê±°!
            diaryModal.classList.remove('active'); 
        });

        diaryModal.addEventListener('click', (e) => {
            if (e.target === diaryModal) {
                diaryModal.classList.remove('active');
            }
        });

        // [í•µì‹¬] ë‹«ê¸° ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ì €ì¥!
        settingsCloseX.addEventListener('click', () => {
            saveSettings(); // ì—¬ê¸°ì„œ ì €ì¥
            settingsModal.classList.remove('active');
            playSfx('sfx-click');
        });

        // [í•µì‹¬] ë°°ê²½ í´ë¦­í•´ì„œ ë‹«ì„ ë•Œë„ ì €ì¥! (ì„ íƒì‚¬í•­)
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                saveSettings(); // ì—¬ê¸°ì„œë„ ì €ì¥
                settingsModal.classList.remove('active');
            }
        });

        // [í•µì‹¬] í¬ì¸íŠ¸ì— ë”°ë¥¸ ë ˆë²¨ ê³„ì‚° í•¨ìˆ˜ 
        function calculateLevel(points) {
            if (points <= 15) return 1;
            if (points <= 30) return 2;
            if (points <= 45) return 3;
            if (points <= 60) return 4;
            if (points <= 75) return 5;
            if (points <= 90) return 6;
            if (points <= 105) return 7;
            if (points <= 125) return 8;
            if (points <= 150) return 9;
            return 10; // Max [cite: 43]
        }

        // [í•µì‹¬] ì„¬ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateIslandVisual(type, points) {
            const level = calculateLevel(points);
            const imgElement = document.getElementById(`img-${type}`);
            const parentElement = document.getElementById(`island-${type}`);
            
            // ë°ì´í„° ì—…ë°ì´íŠ¸
            parentElement.dataset.points = points;
            
            // ì´ë¯¸ì§€ ì†ŒìŠ¤ êµì²´ (íŒŒì¼ëª… ê·œì¹™: island_type_level.png)
            const newSrc = `images/island_${type}_${level}.png`;
            
            // í˜„ì¬ ì´ë¯¸ì§€ì™€ ë‹¤ë¥¼ ë•Œë§Œ êµì²´ (ë¶ˆí•„ìš”í•œ ë¦¬ë¡œë“œ ë°©ì§€)
            if (!imgElement.src.includes(newSrc)) {
                // í˜ì´ë“œ íš¨ê³¼ë¥¼ ìœ„í•´ íˆ¬ëª…ë„ ì¡°ì ˆ
                imgElement.style.opacity = 0;
                setTimeout(() => {
                    imgElement.src = newSrc;
                    imgElement.onload = () => {
                        imgElement.style.opacity = 1;
                    };
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ(íŒŒì¼ ì—†ì„ ë•Œ) 1ë ˆë²¨ë¡œ ë¡¤ë°±í•˜ëŠ” ì•ˆì „ì¥ì¹˜
                    imgElement.onerror = () => {
                        imgElement.src = `images/island_${type}_1.png`;
                        imgElement.style.opacity = 1;
                    }
                }, 300);
            }
        }

        // [NEW] ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        virtues.forEach(v => {
            const slider = document.getElementById(`rng-${v}`);
            const display = document.getElementById(`val-${v}`);
            
            slider.addEventListener('input', (e) => {
                const points = parseInt(e.target.value);
                display.innerText = points;
                updateIslandVisual(v, points);
            });
        });

        function createStars() {
            const count = 100;
            for(let i=0; i<count; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const x = Math.random() * 100;
                const y = Math.random() * 70; 
                const size = Math.random() * 2 + 1;
                const duration = Math.random() * 3 + 2; 
                const opacity = Math.random() * 0.7 + 0.3;
                star.style.left = `${x}%`; star.style.top = `${y}%`;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${duration}s`);
                star.style.setProperty('--opacity', opacity);
                starsContainer.appendChild(star);
            }
        }
        createStars();

        function updateDayNightCycle() {
            // [1] ì‹œê³„(HUD) ì—…ë°ì´íŠ¸: í…Œë§ˆ ì„¤ì •ê³¼ ìƒê´€ì—†ì´ í•­ìƒ ì‹¤í–‰ë˜ì–´ì•¼ í•¨ (ë°–ìœ¼ë¡œ êº¼ëƒ„)
            const realNow = new Date();
            const year = realNow.getFullYear(); 
            const month = String(realNow.getMonth() + 1).padStart(2, '0'); 
            const date = String(realNow.getDate()).padStart(2, '0');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT']; 
            const dayName = days[realNow.getDay()];
            
            // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì—…ë°ì´íŠ¸ (ì•ˆì „ì¥ì¹˜)
            if (hudDate) hudDate.innerText = `${year}. ${month}. ${date}. ${dayName}`;
            
            const hours = String(realNow.getHours()).padStart(2, '0'); 
            const minutes = String(realNow.getMinutes()).padStart(2, '0');
            
            if (hudTime) hudTime.innerText = `${hours}:${minutes}`;


            // [2] ë°°ê²½ìƒ‰(í…Œë§ˆ) ê²°ì • ë¡œì§
            let h;
            
            if (globalTheme === 'day') {
                h = 12; // ê°•ì œ ë‚® (ì •ì˜¤)
            } else if (globalTheme === 'night') {
                h = 22; // ê°•ì œ ë°¤ (ë°¤ 10ì‹œ)
            } else {
                // autoë©´ ì‹¤ì œ ì‹œê°„ ì‚¬ìš©
                const now = window.manualTime ? new Date().setHours(window.manualTime.h) : new Date();
                h = new Date(now).getHours();
            }

            // ë°°ê²½ìƒ‰ ê²°ì • ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
            let skyGradient = ''; 
            let starsOpacity = 0;

            if (h >= 5 && h < 7) { 
                skyGradient = 'linear-gradient(135deg, #2c3e50 0%, #4ca1af 60%, #ff9966 100%)'; starsOpacity = 0; // ìƒˆë²½
                isNightTime = false;
            } else if (h >= 7 && h < 17) { 
                skyGradient = 'linear-gradient(135deg, #2980b9 0%, #6dd5fa 50%, #ffffff 100%)'; starsOpacity = 0; // ë‚®
                isNightTime = false;
            } else if (h >= 17 && h < 19) { 
                skyGradient = 'linear-gradient(135deg, #3e5151 0%, #decba4 50%, #ff7e5f 100%)'; starsOpacity = 0.3; // ë…¸ì„
                isNightTime = false;
            } else { 
                skyGradient = 'linear-gradient(160deg, #02010a 0%, #040714 60%, #090c1f 100%)'; starsOpacity = 1; // ë°¤
                isNightTime = true; 
            }
            
            if(skyBg) skyBg.style.background = skyGradient; 
            if(starsContainer) starsContainer.style.opacity = starsOpacity;
        }
        setInterval(updateDayNightCycle, 1000); updateDayNightCycle(); 

        let mouseX = 0; let mouseY = 0; let targetX = 0; let targetY = 0;
        const parallaxSensitivity = 0.2; 
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - width / 2) / (width / 2);
            mouseY = (e.clientY - height / 2) / (height / 2);
            tooltip.style.left = e.clientX + 'px'; tooltip.style.top = e.clientY + 'px';
        });

        function updateParallax() {
            // [ìˆ˜ì •] êº¼ì ¸ìˆê±°ë‚˜ ì§‘ì¤‘ ëª¨ë“œì¼ ë• ê³„ì‚° ì¤‘ì§€ (ì„±ëŠ¥ ì ˆì•½)
            if (!isParallaxOn || document.body.classList.contains('world-focused')) {
                requestAnimationFrame(updateParallax);
                return;
            }

            targetX += (mouseX - targetX) * 0.05; 
            targetY += (mouseY - targetY) * 0.05;

            const allObjects = document.querySelectorAll('.scene-object');
            allObjects.forEach(obj => {
                const depth = parseFloat(obj.dataset.depth); 
                const baseX = parseFloat(obj.dataset.baseX); 
                const baseY = parseFloat(obj.dataset.baseY);

                // ì›€ì§ì„ ê³„ì‚°
                const moveX = targetX * depth * width * -1 * parallaxSensitivity; 
                const moveY = targetY * depth * height * -1 * parallaxSensitivity;

                // ì ìš©
                obj.style.left = `${baseX}%`; 
                obj.style.top = `${baseY}%`; 
                obj.style.transform = `translate(calc(-50% + ${moveX}px), ${moveY}px)`;
            });

            requestAnimationFrame(updateParallax);
        }

        function createShards() {
            const shardCount = 20;
            for(let i=0; i<shardCount; i++) {
                const shard = document.createElement('div'); shard.classList.add('shard', 'scene-object'); 
                const size = 5 + Math.random() * 20; shard.style.width = `${size}px`; shard.style.height = `${size}px`;
                shard.dataset.baseX = Math.random() * 100; shard.dataset.baseY = Math.random() * 90; shard.dataset.depth = (Math.random() * 0.1).toFixed(3); 
                const p1 = Math.floor(Math.random() * 100); const p2 = Math.floor(Math.random() * 100); const p3 = Math.floor(Math.random() * 100);
                shard.style.clipPath = `polygon(${p1}% 0%, 100% ${p2}%, ${p3}% 100%)`; shard.style.animationDelay = `${Math.random() * 5}s`;
                islandsContainer.appendChild(shard);
            }
        }
        createShards(); 

        islandElements.forEach(island => {
            island.addEventListener('mouseenter', () => {
                if(island.classList.contains('visible')) {
                    const sound = audioHover.cloneNode(); sound.volume = 0.5 * globalSFXVolume; sound.play().catch(()=>{});
                    tooltipEn.innerText = island.dataset.nameEn;
                    tooltipKr.innerText = island.dataset.nameKr;
                    
                    // íˆ´íŒì— í˜„ì¬ ë ˆë²¨ í‘œì‹œ ì¶”ê°€
                    const points = parseInt(island.dataset.points);
                    const lvl = calculateLevel(points);
                    tooltipLvl.innerText = `Lv. ${lvl} (${points}pts)`;
                    
                    tooltip.classList.add('active');
                }
            });
            island.addEventListener('mouseleave', () => { tooltip.classList.remove('active'); });
        });

        let particles = []; const particleCount = 200; let isClearing = false; let isGardenMode = false;
        class Particle {
            constructor(isIntro = true) { this.isIntro = isIntro; this.markedForDeletion = false; this.reset(true); }
            reset(initial = false) {
                if (this.isIntro) {
                    this.x = Math.random() * width; this.y = Math.random() * height; this.z = Math.random(); 
                    this.size = 100 + this.z * 300; this.speed = 0.5 + this.z * 0.5; this.opacity = 0.4 + Math.random() * 0.5;
                    this.vx = this.speed; this.vy = 0; this.type = 'cloud';
                } else {
                    this.x = width + 50; const rand = Math.random();
                    if (rand < 0.8) { this.y = (height * 0.7) + Math.random() * (height * 0.3); } else { this.y = Math.random() * (height * 0.5); }
                    const typeRand = Math.random();
                    if (typeRand > 0.8) { this.type = 'mini-cloud'; this.size = 30 + Math.random() * 60; this.speed = 0.5 + Math.random() * 0.5; this.opacity = 0.15 + Math.random() * 0.2; } 
                    else { this.type = 'wind'; this.size = 1 + Math.random() * 2; this.speed = 2.5 + Math.random() * 2; this.opacity = 0.05 + Math.random() * 0.1; }
                    this.vx = -this.speed; this.vy = (Math.random() - 0.5) * 0.2;
                }
                this.explodeVx = 0; this.explodeVy = 0;
            }
            update() {
                if (this.isIntro) {
                    if (!isClearing) { this.x += this.vx; if (this.x - this.size > width) { this.x = -this.size; this.y = Math.random() * height; } } 
                    else {
                        const centerX = width / 2; const centerY = height / 2; const dx = this.x - centerX; const dy = this.y - centerY;
                        const angle = Math.atan2(dy, dx); const force = 8; 
                        this.explodeVx += Math.cos(angle) * 0.8; this.explodeVy += Math.sin(angle) * 0.8;
                        this.x += (Math.cos(angle) * force) + this.explodeVx; this.y += (Math.sin(angle) * force) + this.explodeVy;
                        this.opacity -= 0.02; if (this.opacity <= 0) { this.markedForDeletion = true; }
                    }
                } else {
                    this.x += this.vx; this.y += this.vy; if (this.x < -200) { this.markedForDeletion = true; }
                }
            }
            draw() {
                if (this.opacity <= 0) return; ctx.beginPath();
                if (this.type === 'cloud' || this.type === 'mini-cloud') {
                    const gradient = ctx.createRadialGradient(this.x, this.y, this.size * 0.1, this.x, this.y, this.size);
                    gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`); gradient.addColorStop(0.6, `rgba(240, 248, 255, ${this.opacity * 0.5})`); gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                    ctx.fillStyle = gradient; ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                } else if (this.type === 'wind') {
                    ctx.strokeStyle = `rgba(255, 255, 255, ${this.opacity})`; ctx.lineWidth = 1;
                    ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.size * 15, this.y); ctx.stroke();
                }
            }
        }

        function initIntroParticles() { for (let i = 0; i < particleCount; i++) particles.push(new Particle(true)); }
        function spawnGardenParticles() { 
            if (!isGardenMode) return; 

            // [ìˆ˜ì •] ì„¤ì •ê°’ì— ë”°ë¼ ìµœëŒ€ ê°œìˆ˜ ì œí•œ
            let maxParticles = 200; // ê¸°ë³¸(ë§ìŒ)
            if (particleDensity === 1) maxParticles = 50; // ë³´í†µ
            if (particleDensity === 0) maxParticles = 0;  // ë„ê¸°

            if (particles.length < maxParticles) { 
                particles.push(new Particle(false)); 
            } 
        }
        function animateParticles() {
            ctx.clearRect(0, 0, width, height);
            
            // 1. ê¸°ì¡´ íŒŒí‹°í´ (êµ¬ë¦„, ë¨¼ì§€ ë“±)
            for (let i = 0; i < particles.length; i++) { 
                particles[i].update(); 
                particles[i].draw(); 
            }
            particles = particles.filter(p => !p.markedForDeletion);

            // 2. [ìˆ˜ì •ë¨] ìœ ì„±ìš° ë¡œì§
            if (isNightTime) {
                // 1.5% í™•ë¥ ë¡œ ëŒ€ê¸° ì¤‘ì¸(-5000) ë³„ í•˜ë‚˜ë¥¼ ê³¨ë¼ ë°œì‚¬(reset)
                if (Math.random() < 0.015) {
                    const dormantStar = shootingStars.find(s => s.x === -5000);
                    if (dormantStar) dormantStar.reset();
                }

                shootingStars.forEach(star => {
                    star.update();
                    star.draw();
                });
            }

            if (isGardenMode) { spawnGardenParticles(); }
            requestAnimationFrame(animateParticles);
        }

        enterBtn.addEventListener('mouseenter', () => { const sound = audioHover.cloneNode(); sound.volume = 0.5 * globalSFXVolume; sound.play().catch(()=>{}); });
        
        function enterGardenMode(isInstant = false) {
            if (!isInstant) {
                playSfx('sfx-click');
                
                // íš¨ê³¼ìŒ ë³¼ë¥¨ë„ ì „ì—­ ë³€ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
                audioClear.volume = 0.4 * globalSFXVolume; 
                audioClear.play();
                
                // [ì¤‘ìš” ìˆ˜ì •] ë³¼ë¥¨ì„ 1ë¡œ ê°•ì œí•˜ì§€ ë§ê³ , ì„¤ì •ëœ ê°’(globalBGMVolume)ì„ ì‚¬ìš©
                audioAmbiance.volume = globalBGMVolume; 
                audioAmbiance.play().catch(()=>{});
            } else {
                if(audioAmbiance) { 
                    audioAmbiance.volume = globalBGMVolume; // ì—¬ê¸°ì„œë„ ì„¤ì •ê°’ ì‚¬ìš©
                    audioAmbiance.play().catch(()=>{}); 
                }
            }

            uiLayer.style.opacity = '0';
            isClearing = true; 
            
            worldContainer.style.transform = "scale(2.0)"; 

            setTimeout(() => {
                isGardenMode = true;
                const allSceneObjects = document.querySelectorAll('.scene-object');
                allSceneObjects.forEach((obj) => { obj.classList.add('visible'); });

                if (diaryOpenBtn) diaryOpenBtn.classList.add('visible');

                cloudFloor.style.opacity = '1'; 
                hudLayer.style.opacity = '1'; 
                updateParallax(); 

                // â˜… 1. íŠœí† ë¦¬ì–¼ ëŒ€ìƒìì¸ì§€ ë¨¼ì € í™•ì¸
                const isNewUser = Object.values(currentPoints).every(val => val === 0);
                const needTutorial = isNewUser && !localStorage.getItem('geulsup_tutorial_done');

                // â˜… 2. íŠœí† ë¦¬ì–¼ì„ ì•ˆ í•´ë„ ë  ë•Œë§Œ ë©”ë‰´ ë²„íŠ¼ì„ ì¦‰ì‹œ ë³´ì—¬ì¤Œ (í‹ˆìƒˆ í´ë¦­ ì›ì²œ ì°¨ë‹¨)
                if (menuToggleBtn && !needTutorial && !isTutorialMode) {
                    menuToggleBtn.classList.add('visible'); 
                }

                // â˜… 3. ëŒ€ìƒìë¼ë©´ 1.5ì´ˆ ë’¤ íŠœí† ë¦¬ì–¼ ì‹œì‘
                if (needTutorial) {
                    setTimeout(startTutorialStep1, 1500); 
                }
            }, isInstant ? 100 : 1000);

            setTimeout(() => { uiLayer.style.display = 'none'; }, isInstant ? 150 : 1500);
        }

        // 2. [ê¸°ì¡´ ë²„íŠ¼ ì—°ê²°] ë§ˆìš°ìŠ¤ í˜¸ë²„ ë° í´ë¦­ ì´ë²¤íŠ¸
        enterBtn.addEventListener('mouseenter', () => { 
            const sound = audioHover.cloneNode(); 
            sound.volume = 0.5 * globalSFXVolume; 
            sound.play().catch(()=>{}); 
        });

        enterBtn.addEventListener('click', () => {
            enterGardenMode(false); // false = ìˆ˜ë™ ì…ì¥ (ì—°ì¶œ ì²œì²œíˆ)
        });

        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();

            // 1. ì—­ì‚¬ê´€ì—ì„œ 'ì •ì›ìœ¼ë¡œ ëŒì•„ê°€ê¸°'ë¡œ ì˜´ (íƒ€ì´í‹€ ìŠ¤í‚µ)
            if (sessionStorage.getItem('skipIntro') === 'true') {
                sessionStorage.removeItem('skipIntro');
                uiLayer.style.transition = 'none'; 
                uiLayer.style.opacity = 0;
                enterGardenMode(true);
            }

            // 2. [ìˆ˜ì •ë¨] ì—­ì‚¬ê´€ì—ì„œ "ë¦¬í¬íŠ¸ ë§Œë“¤ê¸°" ëˆ„ë¥´ê³  ì˜´
            if (sessionStorage.getItem('forceSeasonReport') === 'true') {
                // ì£¼ì˜: ì—¬ê¸°ì„œ removeItemì„ í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤! 
                // auth.onAuthStateChangedê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€ í‚¤ê°€ ì‚´ì•„ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                
                // ëŒ€ì‹ , íƒ€ì´í‹€ í™”ë©´ë§Œ ë¯¸ë¦¬ ìˆ¨ê²¨ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë„˜ì–´ê°€ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
                uiLayer.style.transition = 'none';
                uiLayer.style.opacity = 0;
                enterGardenMode(true); 
            }
        });

        initIntroParticles(); animateParticles();
        // --- [ì¶”ê°€] F3 í‚¤ë¡œ ì •ì›ì‚¬ ëª¨ë“œ í† ê¸€ ---
        window.addEventListener('keydown', (e) => {
            if (e.key === 'F3') {
                e.preventDefault(); // ë¸Œë¼ìš°ì € ìì²´ 'ì°¾ê¸°' ì°½ì´ ëœ¨ëŠ” ê±¸ ë§‰ìŒ
                
                // í˜„ì¬ ìƒíƒœê°€ blockì´ë©´ ìˆ¨ê¸°ê³ , ì•„ë‹ˆë©´ ë³´ì—¬ì¤Œ
                if (devPanel.style.display === 'block') {
                    devPanel.style.display = 'none';
                } else {
                    devPanel.style.display = 'block';
                }
            }
        });

        window.addEventListener('resize', () => {
            if (isTutorialMode && currentTargetForTutorial) {
                // ì´ë¯¸ ë– ìˆëŠ” í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì„œ ìœ„ì¹˜ë§Œ ì¬ê³„ì‚°
                const title = currentTutorialData.title;
                const desc = currentTutorialData.desc;
                
                // ë”œë ˆì´ ì—†ì´ ì¦‰ì‹œ ì¬ê³„ì‚° (0ms)
                const rect = currentTargetForTutorial.getBoundingClientRect();
                const targetCenterX = rect.left + (rect.width / 2);
                const targetCenterY = rect.top + (rect.height / 2);
                const size = Math.max(rect.width, rect.height) + 80;

                tutOverlay.style.top = `${targetCenterY}px`;
                tutOverlay.style.left = `${targetCenterX}px`;
                tutOverlay.style.width = `${size}px`;
                tutOverlay.style.height = `${size}px`;

                // ê°€ë¡œ ìœ„ì¹˜ ì¬ê³„ì‚° ë¡œì§ ë°˜ë³µ (ê°„ëµí™”)
                let textLeft;
                if (targetCenterX > window.innerWidth / 2) {
                    textLeft = targetCenterX - (size / 2) - 310;
                } else {
                    textLeft = targetCenterX + (size / 2) + 30;
                }
                
                tutText.style.left = `${Math.max(20, Math.min(window.innerWidth - 300, textLeft))}px`;
                tutText.style.top = `${Math.max(100, Math.min(window.innerHeight - 150, targetCenterY - 50))}px`;
            }
        });
    </script>
</body>
</html> 